\documentclass[12pt,twoside,spanish,a4paper]{book}
\usepackage{geometry}\geometry{top=3cm,bottom=3cm,left=3cm,right=3cm}
\usepackage{fancyhdr}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{url}
\usepackage{mathrsfs}
\usepackage{longtable}
\usepackage{tocbibind}
\usepackage{titlesec}
\usepackage{makeidx}
\usepackage{boxedminipage}
\usepackage[utf8]{inputenc}
\usepackage[all,2cell,dvips]{xy}
\usepackage{graphicx}
\usepackage{float}
\usepackage[spanish,es-tabla]{babel}
\usepackage{parskip}
\usepackage{multirow}
\usepackage{multicol}
\usepackage{verbatim}
\usepackage{fancyvrb}
\usepackage[authoryear]{natbib}

\fancyhf{} 
\fancyhead[LE]{\leftmark} 
\fancyhead[RO]{\nouppercase{\rightmark}} 
%\fancyfoot[LE,RO]{\thepage} 
\rfoot{\thepage} 
\pagestyle{fancy} 

\topmargin 2mm
\oddsidemargin 2mm
\evensidemargin 2mm

\makeindex
\setcounter{secnumdepth}{3}

\linespread{1.6}

\begin{document}

<<echo=FALSE>>=
options(scipen = 999)  
@


<<echo=FALSE, message=FALSE, warning=FALSE>>=
list.of.packages <- c("knitr", "xtable", "tidyverse", "ggplot2", "RColorBrewer", "gridExtra", "ggmosaic", "remotes", "muhaz", "survminer", "forestplot")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

#install.packages("ggplot2")
#remove.packages('ggplot2')
#install.packages("devtools")
#devtools::install_github('cran/ggplot2', force=TRUE)

library(knitr)
library(xtable)
library(tidyverse)
library(ggplot2)
library(RColorBrewer)	
library(gridExtra)
library(ggmosaic)
#remotes::install_github("thomasp85/patchwork")
library(patchwork)
library(survival) 
library(muhaz)
library(survminer)
library(forestplot)
library(coxphw)
@

\pagenumbering{roman}

%%%%%%%%%%%%%%%%%%%%%%%%%% CARATULA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\thispagestyle{empty}

\begin{center}

\includegraphics[width=0.15\textwidth]{grafi/logoudelar.jpg}



UNIVERSIDAD DE LA REPÚBLICA

Facultad de Ciencias Económicas y de Administración

Licenciatura en Estadística

Informe de Pasantía

\vspace{2.5cm}


\textbf{\large Análisis de supervivencia de las tablets del Plan Ceibal 2014-2015}

\vspace{1.5 cm}

\textbf{Guillermina Costabel}


\end{center}


\vspace{2cm}

\noindent Tutores:\\
\noindent Marco Scavino\\
\noindent Natalia da Silva\\


\vspace{1cm}

\begin{center}

\noindent Montevideo, Noviembre 2019.

\vspace{1cm}
\end{center}


%%%%%%%%%%%%%%%%%%%%%%% APROBACION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\thispagestyle{empty}


UNIVERSIDAD DE LA REPÚBLICA\\
FACULTAD DE CIENCIAS ECONÓMICAS Y DE ADMINISTRACIÓN \\

\vspace{1.5 cm}

\begin {center}

El tribunal docente integrado por los abajo firmantes aprueba el trabajo de Pasantía:

\textbf{\large Análisis de supervivencia de las tablets del Plan Ceibal 2014-2015}


\vspace{1.5 cm}

\textbf{Guillermina Costabel}

\vspace{1.5 cm}

\noindent Tutores:\\
\noindent Marco Scavino\\
\noindent Natalia da Silva\\
\noindent Licenciatura en Estadística\\

\vspace{1cm}


\end{center}

\noindent \textbf{Puntaje} ................................................................................\\
\noindent \textbf{Tribunal} \\
\noindent Profesor...............................................................(nombre y firma).\\
\noindent Profesor...............................................................(nombre y firma).\\
\noindent Profesor...............................................................(nombre y firma).\\
\noindent \textbf{Fecha}.............................................................................\\

%\vspace{1cm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% RESUMEN %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 'resumen.Rnw'

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\listoffigures
\listoftables

\newpage
\thispagestyle{empty}

\setcounter{page}{1} 
 
\pagenumbering{arabic}

%%%%%%%%%%%%%%%%%%%%%%%%% INTRODUCCION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Introducción \label{cap:Intro}}
Con el propósito de potenciar los procesos de aprendizaje utilizando herramientas tecnológicas de la información y la comunicación (TIC), se implementa en Uruguay en 2007 el Plan Ceibal, como plan de inclusión e igualdad de oportunidades.\\
Según la Ley Nro. 18.640 \citep{ceibal2010promocion} %Ley Número 18.640, PROMOCIÓN DE LA SALUD Y LA EDUCACIÓN EN LA NIÑEZ Y LA ADOLESCENCIA EN EL ÁMBITO DE LA EDUCACIÓN PÚBLICA, se declara de interés nacional los programas que tengan por objeto actividades de apoyo. \textit{https://legislativo.parlamento.gub.uy/temporales/leytemp4690798.htm}}
, de creación del Centro Ceibal, se establece que uno de los principales cometidos del Plan, es ``contribuir al ejercicio del derecho a la educación y a la inclusión social mediante acciones que permitan la igualdad de acceso al conocimiento y al desarrollo saludable de la infancia y la adolescencia".

Desde su creación, cada niño y niña que ingresa al sistema educativo uruguayo cuenta con la posibilidad de acceder a una computadora personal con conexión a Internet en forma gratuita que proviene desde el centro educativo en el cual participa. De esta manera, el aprendizaje se ve ampliado con la posibilidad de, además de lo aprendido en clase, seleccionar información, desarrollar alternativas y saber utilizar la tecnología actual.

La primera entrega de dispositivos se realizó en 2007, en la Escuela Italia de Villa Cardal en el departamento de Florida comenzando de esta manera una serie de etapas que incluyen la implementación del sistema de entregas en primaria, secundaria y UTU en todo el país, la instalación del acceso inalámbrico e internet y el despliegue de las plataformas educativas permitiendo el acceso de forma gratuita a libros de textos como también la inclusión de la familia. Plan Ceibal contribuyó a disminuir la brecha de acceso a la computadora, entre los quintiles de mayor y menor ingreso, consolidando un escenario de equidad que se mantiene estable desde 2010.

Como se menciona en el sitio web de \cite{ceibal2017que}, la misión del Plan es la integración de la tecnología al servicio de la educación, con el fin de mejorar su calidad, impulsando la innovación social, la inclusión y el crecimiento personal; mientras que su visión es contribuir con una educación innovadora que permita desarrollar el aprendizaje, la creatividad y el pensamiento crítico.

Con el ``Modelo uno a uno"  que se implementó, se ha podido contemplar la entrega de una laptop o tablet a cada alumna, alumno y docente de la enseñanza pública básica (Educación Inicial y Primaria y Educación Media). Así mismo, para la permanencia en el tiempo durante la trayectoria del alumno o alumna en su ciclo educativo, el Plan Ceibal planifica el mantenimiento de los servicios de soporte del parque de dispositivos, comprando repuestos, realizando reparaciones de partes y reparaciones de equipos, implementando también un servicio de reparación móvil que permite que todos los dispositivos sean reparados en prácticamente cualquier lugar geográfico del territorio nacional bajo cualquier estado de conservación. 

\section{Motivación \label{sec:Just}}
Dado el plan de entregas y recambio, todos los años se otorgan, por parte de Ceibal, equipos nuevos para todos los alumnos y las alumnas de primer y cuarto año de educación primaria y de primero de educación media básica. Por tanto, el conocer la duración aproximada de cada uno de ellos y los tipos de roturas más frecuentes, además del porcentaje de dispositivos que quedan totalmente rotos, ayudaría a tomar decisiones a futuro sobre qué equipo comprar pudiendo así reducir algunos costos y asegurar la equidad en el acceso. Por otra parte, la tarea de soporte es considerablemente importante dentro del presupuesto anual del Plan Ceibal, por tanto toda información que contribuya a la optimización del uso de los recursos (técnicos, financieros), es fundamental.

Esta investigación contribuiría además con el objetivo propuesto por Ceibal y su política de equidad en el acceso a las TICs generando evidencia empírica con una metodología que permita ampliar los conocimientos generando nuevos antecedentes para luego ser extrapolada a los restantes modelos de equipos del parque.

\section{Objetivos \label{sec:Obj}}
El objetivo general de este trabajo es analizar la supervivencia de un modelo de tablet entregado por Ceibal, y sus principales causas de rotura, indagando la relación entre la incidencia del tipo de rotura y la esperanza de vida del equipo con las características sociodemográficas de las alumnas y los alumnos.

En función de éste, surgen los siguientes objetivos específicos:
\begin{itemize}
\item Realizar un análisis exploratorio de los datos para identificar posibles variables relevantes para modelizar la supervivencia de las tablets.
\item Conocer las principales causas de rotura que presenta este dispositivo a lo largo de su trayectoria y los tiempos asociados a cada una de ellas.
\item Estimar la función de supervivencia de la generación de tablets que presentan una primera vida (desde el momento en que el equipo es entregado hasta su primera reparación) y de la generación que presentan una segunda vida (desde que el equipo se vuelve a entregar después de su primera reparación hasta su segunda reparación).
\item Comparar el tiempo de vida, la supervivencia y los patrones de rotura de la primera y segunda vida.
\item Estimar los efectos de las características sociodemográficas del alumnado y características técnicas de las tablets, sobre el grupo primera vida, aplicando diferentes métodos de análisis.
\item Estimar la función de riesgo de la generación de tablets que presentan una primera vida y la de la generación que presentan una segunda vida y compararlas.
\end{itemize}

\vspace{1.5cm}

En el siguiente repositorio de github se encuentra todo el material necesario para reproducir este trabajo. Debido a la confidencialidad de los datos el repositorio es privado, para acceder al mismo se deberá solicitar el permiso necesario. 

https://github.com/GCost14/TrabajoFinalIEsta.git

Por otro lado, en este otro repositorio de público acceso se puede encontrar solo un archivo \texttt{.Rnw} con el código de \texttt{R} \citep{r} utilizado para obtener todos los resultados.

https://github.com/GCost14/Trabajo-final-grado-Lic.Estadistica.git



%%%%%%%%%%%%%%%%%%%%%%%%%%% ANTECEDENTES %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Antecedentes \label{cap:Ante}}
El presente trabajo tiene como antecedente principal el documento de \cite{marconi2016supervivencia} donde se estudia la supervivencia de las laptops XO entregadas por Ceibal en el año 2010 a alumnas y alumnos de Educación Primaria Pública de Uruguay  teniendo como objetivo analizar las funciones de supervivencia de los equipos de diferentes perfiles sociodemográficos del alumnado. Se utilizó la técnica de análisis de la historia de acontecimientos para la obtención de las tasas de riesgo y estimación de las funciones de supervivencia. Se evidenció que el 70\%  de la generación presentó una rotura total siendo la principal causa de rotura el teclado de la laptop. El perfil sociodemográfico de alumnas y alumnos que presenta mayor tasa de riesgo a la rotura total de la XO, son los varones de Montevideo de contextos socioculturales más desfavorables, que han repetido algún año y con registros previos de reparación en servicio técnico.

Por otra parte, el análisis de supervivencia ha sido utilizado en variadas disciplinas, principalmente en el ámbito de la salud, también en problemas de ingeniería, lo que se conoce en la literatura como análisis de confiabilidad.

En un texto dirigido a ingenieros y estadísticos industriales que trabajan con datos de duración de vida de productos, \cite{nelson2005applied} presenta entre varias aplicaciones a problemas de ingeniería, un ejemplo sobre datos de fallas de ventiladores de setenta generadores. Para cada uno se registró el número de horas de funcionamiento desde la primera vez que se puso en servicio, hasta la falla del ventilador o hasta el final del estudio (lo que ocurriera primero). Un problema fue estimar el porcentaje de falla en la garantía. Otro fue determinar si la tasa de rotura de los ventiladores disminuía o aumentaba con la edad; es decir, ¿el problema mejoraría o empeoraría a medida que los ventiladores restantes envejecieran? Esta información ayudó a la gerencia a decidir si reemplazar o no a los ventiladores sin fallas.

Así mismo, entre varios ejemplos de \cite{phillips2003statistical} es de interés el que refiere a datos de fallas censuradas a la derecha en el que se analizan los tiempos de rotura (en días) de 16 sistemas de telecomunicaciones instalados en el año 1985 y los tiempos de censura de 109 sistemas restantes, totalizando 125 clientes. Los sistemas podrían retirarse del servicio en cualquier momento durante el período de observación a petición del cliente. Tanto como la falta de funcionamiento, un nivel inaceptable de estática, interferencia o ruido en la transmisión del sistema de telecomunicaciones se consideró como una falla del sistema.

Estos datos fueron presentados originalmente por \cite{kim1991piecewise} y utilizados para obtener una estimación no paramétrica suave de la función de confiabilidad de los sistemas de telecomunicación, a través del modelo exponencial constante a intervalos.

A nivel nacional, se ha aplicado la técnica de análisis de supervivencia o análisis de confiabilidad en distintos ámbitos. A modo de ejemplos, \cite{triunfo29mortalidad} estimaron la tasa de mortalidad infantil a partir de los nacimientos ocurridos en Uruguay entre 2002 y 2003 y las defunciones ocurridas en el primer año de vida. \cite{amarante2012dinamica} estimaron la función de supervivencia y la función de riesgo de duración en el empleo formal al estudiar el mercado de trabajo uruguayo en el período 1997-2009, en base a una muestra de historias laborales de la seguridad social proveniente de los registros administrativos del Banco de Previsión Social (BPS).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% MARCO TEORICO %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Marco teórico \label{sec:MarTeo}}
Este capítulo ofrece una descripción general del enfoque del estudio de datos llamado análisis de supervivencia. Se incluye el tipo de problema abordado por dicha técnica, la variable de respuesta considerada (Sección \ref{sec:SupervGeneral}), la necesidad de tener en cuenta datos censurados (Sección \ref{subsec:Censuras}), así como lo que representa una función de supervivencia y una función de riesgo (Secciones \ref{subsec:FunSuperv} y \ref{subsec:FunRiesgo} respectivamente).

\section{Análisis de supervivencia \label{sec:SupervGeneral}}
%tercera edición del libro "Survival Analysis. A Self-Learning Text", de David G. Kleinbaum y Mitchel Klein.
En general, el análisis de supervivencia es un conjunto de procedimientos estadísticos para el análisis de datos para los cuales la variable de respuesta de interés es el \textit{tiempo hasta que ocurre un evento}.

El \textit{tiempo} puede estar medido en años, meses, semanas o días desde el comienzo del seguimiento de un individuo (tiempo inicial) hasta que ocurre un evento (tiempo final) y se refiere a él como, \textbf{tiempo de supervivencia}, porque es el tiempo que un individuo ha sobrevivido durante un período de seguimiento.

Un \textbf{evento} representa un cambio de la unidad de análisis de un estado de origen a otro, tales como muerte, incidencia de enfermedad, recaída de remisión, falla de un equipo, recuperación (por ejemplo, regreso al trabajo) o cualquier experiencia designada de interés que pueda sucederle a un individuo.

Cuando se considera más de un evento (por ejemplo, muerte por una de varias causas), el problema estadístico se puede caracterizar como un evento recurrente  o un problema con riesgos competitivos (competing risk).

\subsection{Datos censurados \label{subsec:Censuras}}
Una característica especial de los datos de supervivencia que hace que los métodos estándar para datos completos no sean apropiados, es que contienen observaciones censuradas. En esencia, la censura se produce cuando no se conoce exactamente el tiempo de supervivencia de la unidad de análisis.

Se considera como \textbf{censura a la derecha} el caso en el cual no se observa el punto final de interés para cierto individuo. El intervalo de tiempo se ha cortado (es decir, censurado) en el lado derecho, obteniendo un tiempo de supervivencia censurado menor al tiempo de supervivencia real, el cual no se conoce.


\subsection{Diseño de datos de supervivencia \label{subsec:Disenio}}
%segun tercera edición del libro "Survival Analysis. A Self-Learning Text", de David G. Kleinbaum y Mitchel Klein.
El diseño de datos expresado en la Tabla \ref{cuad:sup} ayuda a comprender cómo funciona un análisis de supervivencia.

La primer columna de esta tabla muestra tiempos de falla ordenados en forma ascendente. Los mismos se denotan con subíndices entre paréntesis, comenzando con $t_{(0)}$ hasta $t_{(k)}$, siendo $k$ la cantidad de tiempos de fallas de los individuos. Se deben excluir antes del ordenamiento los tiempos asociados a momentos censurados.

En la segunda columna se muestra la frecuencia de los sujetos que experimentaron el evento en cada tiempo de falla, denotada por $m_f$. La suma de todos los $m_f$ en esta columna indica la cantidad total de fallas respecto al total de individuos considerados.

La tercera columna proporciona la frecuencia, denotada por $q_f$, de los individuos censurados en el intervalo de tiempo que comienza con el tiempo de falla $t_{(f)}$ hasta el siguiente tiempo de falla $t_{(f+1)}$. La suma de estos valores da el número total de observaciones censuradas.

La última columna en la tabla muestra el \textbf{conjunto de riesgo}. Por definición, el conjunto de riesgo, $R(t_{(f)})$, es el conjunto de individuos que han sobrevivido al menos hasta el tiempo $t_{(f)}$; es decir, cada sujeto en $R(t_{(f)})$ tiene un tiempo de supervivencia que es $t_{(f)}$ o mayor, independientemente de si el individuo ha fallado o está censurado.
\begin{table}[hbt]
	\begin{center}
		\caption{Diseño de datos de tiempos de supervivencia.}
		\label{cuad:sup}
		\begin{tabular}{cccc}
			$t_{(f)}$ & $m_f$ & $q_f$ & $R(t_{(f)})$ \\
			\hline
			$t_{(0)} = 0$ & $m_0 = 0$ & $q_0$ & $R(t_{(0)})$ \\
			$t_{(1)}$ & $m_1$ & $q_1$ & $R(t_{(1)})$ \\
			$t_{(2)}$ & $m_2$ & $q_2$ & $R(t_{(2)})$ \\
			\vdots & \vdots & \vdots & \vdots \\
			\vdots & \vdots & \vdots & \vdots \\
			\vdots & \vdots & \vdots & \vdots \\
			$t_{(k)}$ & $m_k$ & $q_k$ & $R(t_{(k)})$ \\
			\hline
		\end{tabular}
	\end{center}
\end{table}

A continuación se hace referencia a dos términos considerados en cualquier análisis de supervivencia. Estos son la \textit{función de supervivencia}, denotada por $S(t)$, y la \textit{función de riesgo}, denotada por $h(t)$. La primera de ellas también es conocida en la literatura como \textit{función de confiabilidad} (o reliability function), sobre todo en el área de ingeniería.


\subsection{Función de supervivencia o confiabilidad \label{subsec:FunSuperv}}
\cite{kleinbaum2010survival} introducen la noción de función de confiabilidad o supervivencia como la probabilidad de que un individuo sobreviva más que un tiempo $t$ determinado.

%\citep{kleinbaum2010survival}
\newtheorem{defi}{Definición}[chapter] 

\begin{defi}
Sea el tiempo de supervivencia $T$, es decir el tiempo hasta que determinado evento ocurra, una variable aleatoria no negativa con función de distribución absolutamente continua $F$. La \textbf{función de supervivencia} $S(t)$,  es la probabilidad de que el tiempo de supervivencia $T$ sea mayor que el tiempo $t$. Esto es,
\begin{equation}
S(t) = P(T \geq t) =   1 - F(t).
\end{equation}
\end{defi}

\subsection{Función de riesgo \label{subsec:FunRiesgo}}
Se define la \textbf{función de riesgo} $h(t)$, como el potencial instantáneo por unidad de tiempo para que ocurra el evento, dado que el individuo ha sobrevivido hasta el tiempo $t$ \citep{kleinbaum2010survival}.

%\citep{kleinbaum2010survival}
\newtheorem{defi}{Definición}[chapter]
\begin{defi}
Sea la variable aleatoria $T$, el tiempo de supervivencia. Se define la función de riesgo como:
\begin{equation}
h(t) = \lim_{\delta t \rightarrow 0} \dfrac{P(t \leq T < t + \delta t \mid T \geq t)}{\delta t}.
\end{equation}
\end{defi}
Debido al suceso condicional en la probabilidad, la función de riesgo a veces es llamada tasa de falla condicional.

\cite{ivanka2012kernel} definen la función de riesgo como la probabilidad de que un individuo presente un evento en el tiempo $t$, condicionado en que haya sobrevivido hasta ese tiempo.

% \citep{ivanka2012kernel}, p
\newtheorem{defi}{Definición}[chapter]
\begin{defi}
Si la distribución del tiempo de vida $F$ tiene una densidad $f$, para $S(t) > 0$, la función de riesgo está definida por
	\begin{equation}
	h(t) = \dfrac{f(t)}{S(t)},
	\end{equation}
	y la \textbf{función de riesgo acumulado} como
	\begin{equation}
	H(t) = - \log S(t).
	\end{equation}
\end{defi}
%segun tercera edición del libro "Survival Analysis. A Self-Learning Text", de David G. Kleinbaum y Mitchel Klein.
Hay una clara relación entre la función de supervivencia y la función de riesgo. De hecho, si uno conoce la forma de $S(t)$, puede derivar la $h(t)$ correspondiente, y viceversa a través de las siguientes fórmulas:
$$ S(t) = \exp \left[ - \int_{0}^{t} h(u) du \right], \qquad  h(t) = - \left[ \frac{S'(t)}{S(t)} \right]. $$


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% METODOLOGIA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Metodología \label{cap:Meto}}
En este capítulo se presentan diferentes métodos no paramétricos usualmente utilizados para estimar la función de confiabilidad (Secciones \ref{sec:EstFunSuperv} y \ref{sec:ModCox}) y la función de riesgo (Sección \ref{sec:EstFunRiesgo}) del conjunto de datos con observaciones censuradas a la derecha, junto con respectivas pruebas de hipótesis e intervalos de confianza.

\section{Notación \label{sec:Nota}}
%Libro de Muller
En primer lugar se resumen algunos conceptos básicos y se introduce la notación para el modelo de tiempo de vida con censura aleatoria a la derecha \citep{muller1994hazard}.

Sean $T_1, T_2, \ldots , T_n$  tiempos de vida independientes e idénticamente distribuidos (i.i.d.) con función de distribución $F$, y sean $C_1, \ldots , C_n$ tiempos de censura i.i.d. con función de distribución $G$, tal que $C$ y $T$ son independientes.

Se observan los pares
$$(X_i, \delta_i), \quad i = 1,2, ..., n,$$
donde $ X_i = \min(T_i, C_i)$ y $\delta_i = I_{\lbrace  X_i = T_i \rbrace}, i=1, ..., n$ indica si la observación es censurada o no. Las $X_i$ son i.i.d. con función de supervivencia $S$, siendo,
$$ S(x) = \bar{F} (x) \bar{G} (x),$$
con $\bar{F}(x) = P(T_1 \geq x)$ y $\bar{G}(x) = P(C_1 \geq x)$ las funciones de supervivencia de $\lbrace T_i \rbrace$ y $\lbrace C_i \rbrace$ respectivamente.


\section{Estimación de la función de confiabilidad \label{sec:EstFunSuperv}}
La estimación no paramétrica más simple de la función de supervivencia para observaciones completas es una función de supervivencia empírica. Kaplan y Meier propusieron una extensión para datos con censuras \citep{KaplanMaier}.

\citep{ivanka2012kernel} presentan la estimación de la función de supervivencia, $\hat{S}(x)$, como se explica a continuación.

En primer lugar se deben ordenar los tiempos de falla de forma ascendete. Luego, para cada uno de los tiempos de falla, la probabilidad de supervivencia estimada se calcula de la siguiente manera:
\begin{equation}
	\hat{S}_{KM}(x)
	 = \prod_{j:X_{(j)} < x}  \left( \dfrac{k-j}{k-j+1} \right)^{\delta_{(j)}},
\end{equation}
donde $X_{(j)}$ denota el $j$-ésimo estadístico de orden de $X_1, X_2, ..., X_k$ y $\delta_{(j)}$ el indicador del estado de censura correspondiente.

La fórmula general para una probabilidad de supervivencia de Kaplan-Meier en el tiempo de falla $ t_{(j)} $ indica la probabilidad de sobrevivir más allá del tiempo de falla anterior $ t_{(j-1)} $, multiplicado por la probabilidad condicional de sobrevivir más que $ t_{(j)} $, dada la supervivencia hasta al menos el tiempo $ t_{(j)} $. Esto es:
$$ \hat{S}(t_(j)) = \prod_{i=1}^{j-1} \hat{P} \left[T > t_{(i)} \mid T \geq t_{(i)} \right]  =  hat{S}(t_(j-1)) \times \hat{P} \left(T > t_{(j)} \mid T \geq t_{(j)} \right). $$

$\hat{S}_{KM}(x)$ es una función escalonada y continua a la derecha. El estimador $\hat{S}_{KM}(x)$ de la función de supervivencia de las observaciones $X_1, \ldots, X_n$ se denomina estimador límite de producto (product-limit) debido a su derivación, como límite, cuando el tiempo se divide en intervalos y la longitud del intervalo tiende a $0$.


\subsection{Intervalos de confianza \label{subsec:Conf}}
%Libro Survival Analysis A Self-Learning text 3nd ed 2012
Se describe como calcular intervalos de confianza para las curvas estimadas por el método de Kaplan-Meier \citep{kleinbaum2010survival}.

La fórmula de los intervalos con una confianza puntuales del 95\% para la probabilidad estimada de Kaplan-Meier, tiene la siguiente fórmula general:
\begin{equation}
\hat{S}_{KM} (t) \pm 1.96 \sqrt{\hat{Var}[\hat{S}_{KM}(t)]},
\end{equation}
donde $\hat{S}_{KM} (t)$ denota la estimación Kaplan-Meier de la función de supervivencia en el tiempo $ t $ y $\hat{Var}[\hat{S}_{KM}(t)]$ denota la estimación de la varianza de $\hat{S}_{KM} (t)$. El enfoque más común utilizado para estimar esta varianza utiliza la \textit{fórmula de Greenwood}:
$$\hat{Var}[\hat{S}_{KM}(t)] = (\hat{S}_{KM} (t))^{2} \sum_{j: t_{(j)}\leq t} \left[\dfrac{m_j}{r_j(r_j - m_j)}\right],$$
siendo $t_{(j)}$ el tiempo de falla ordenado $j$, $m_j$ el número  de fallas en el tiempo $t_{(j)}$, y $r_j$ el número de observaciones en el conjunto de riesgo al tiempo $t_{(j)}$.

La sumatoria representa, en cada tiempo de falla $t_{(j)}$, un promedio ponderado (por $ 1 / r_j $) del riesgo condicional de fallar antes de $t_{(j)}$.


\subsection{Comparación de curvas de supervivencia \label{subsec:LogRank}}
%Capitulo 2. Analisis de sobrevivencia utilizando el lenguaje R
Se describe en primer lugar cómo evaluar si las curvas Kaplan-Meier para dos grupos son estadisticamente equivalentes\footnote{Cuando se afirma que dos o más curvas de Kaplan-Meier son ``estadisticamente equivalentes", se quiere decir que, en base a un procedimiento de testeo que compara dichas curvas de supervivencia, no hay evidencia que indique que sean diferentes.}, testeándose lo siguiente:

\begin{equation*}
\begin{array}{cl}
H_0: & \hat{S}_1(t) = \hat{S}_2(t), 0 < t < \infty, \\
H_1: &  \hat{S}_1(t) \neq \hat{S}_2(t).
\end{array}
\end{equation*}

Para construir el estadístico de contraste basta con calcular el número esperado de fallas y la varianza estimada del número de muertes para uno de los grupos; por ejemplo, para el grupo $1$ el número esperado de muertes se calcula de la siguiente manera:
$$ \hat{e}_{1}(t_i) = \dfrac{r_1(t_i) m(t_i)}{r(t_i)}, $$
donde $r(t_i)$ y $m(t_i)$ son el número de individuos en riesgo y el número de muertes (o de ocurrencia del evento de interés) en el momento $t_i$, y $r_1(t_i)$ es la cantidad de individuos en riesgo del grupo $1$ en el tiempo $t_i$.

La varianza estimada de $m_i(t_i)$ está basada en la distribución hipergeométrica y para el grupo $1$ está definida como:
$$ \hat{V} (m_1(t_i)) = \dfrac{r_1(t_i)r_2(t_i)(r(t_i)-m(t_i))}{r^2 (t_i)(r(t_i)-1)}, $$
siendo $r_2(t_i)$ la cantidad de individuos en riesgo del grupo 2 en el tiempo $t_i$.

Finalmente, el estadístico de contraste se define de la siguiente manera:
\begin{equation}
Q = \dfrac{\left[\sum_{t=1}^k w_i(m_1(t_i)-\hat{e}_1(t_i)) \right]^2}{\sum_{t=1}^k w_i^2 \hat{V}(m_1(t_i))}.
\label{ec:pesos}
\end{equation}

En la Ecuación \ref{ec:pesos}, $k$ es el número de tiempos de ocurrencia de eventos en ambos grupos y $w_i$ denota los pesos que toman valores distintos dependiendo del test utilizado.

El más común de los test es el de \cite{mantel1966evaluation} conocido como test de rangos logarítmicos (o log-rank), el cual está diseñado para verificar igualdad o diferencia en la función de supervivencia en todos los tiempos. En este test los pesos son iguales a 1, es decir, $w_i = 1$.

Otro de los test comúnmente utilizados es el de \cite{peto1972asymptotically}, el cual permite verificar igualdad o diferencia de las funciones de supervivencia en los tiempos iniciales. En este test los pesos toman la forma:
$$w_i = \tilde{S} (t_{i-1}) \dfrac{r(t_i)}{r(t_i) - 1}, $$
donde $\tilde{S} (t)$ es el estimador de la función de supervivencia definido por:
$$ \tilde{S} (t) =  \prod_{t_i \leq t} \left( \dfrac{r(t_i)+1-m(t_i)}{r(t_i)+1} \right). $$

Otra forma de estudiar los test anteriores fue propuesta por \cite{harrington1982class} quienes sugirieron pesos de la forma:
$$ w_1 = \left[ \hat{S}_{KM}(t_{i-1}) \right]^{\rho}, $$
 y haciendo $\rho = 0$ se tiene que $w_i = 1$, test log-rank, y, si $\rho = 1$, se obtiene el test de Peto-Peto.

Puede demostrarse que para un número de observaciones suficientemente grande, la distibución del estadístico $Q$ puede aproximarse, bajo la hipótesis nula que asume que las dos funciones de supervivencia son iguales, con una distribución $\chi^2_1$ (chi-cuadrado de un grado de libertad).

Por otro lado, para el caso de más de dos grupos, se define a continuación solamente la fórmula del estadístico de log-rank, siendo la hipótesis a testear:

\begin{equation*}
\begin{array}{cl}
H_0: & \hat{S}_1(t) = \hat{S}_2(t) = \ldots = \hat{S}_G(t), \\
H_1: & \textrm{Al menos } \hat{S}_i \neq \hat{S}_l \textrm{ para cualquier } i, l \in \left[1,G \right].
\end{array}
\end{equation*}

Sea $i=1,2, \ldots , G$ la cantidad de grupos y $j=1,2, \ldots , k$, la cantidad de tiempos de falla diferentes:

\begin{itemize}
\item $r_{ij}$ es la cantidad en riesgo en el $i$-ésimo grupo en el $j$-ésimo tiempo de falla ordenado,
\item $m_{ij}$ es la cantidad de fallas observadas en el $i$-ésimo grupo en el $j$-ésimo tiempo de falla ordenado,
\item $e_{ij}$ es la cantidad de fallas esperadas en el $i$-ésimo grupo en el $j$-ésimo tiempo de falla ordenado, igual a $\left( \dfrac{r_{ij}}{r_{1j} + r_{2j}} \right)  (m_{1j}+m_{2j})$,
\item $r_j = \sum_{i=1}^{G} r_{ij}$,
\item $m_j = \sum_{i=1}^{G} m_{ij}$,
\item $O_i - E_i = \sum_{j=1}^{k} (m_{ij} - e_{ij})$,
\item $Var(O_i - E_i) = \sum_{j=1}^{k} \left( \dfrac{r_{ij}(r_j - r_{ij})m_{ij} (r_j-m_j)}{r^{2}_j (r_j - 1)} \right)$,
\item $\mathbf{d} = (O_1-E_1, O_2-E_2, \ldots , O_{G-1}-E_{G-1})^{\prime}$,
\item $\mathbf{V} =  ((v_{il}))$ donde $v_{ii} = Var(O_i-E_i)$ y $v_{il} = Cov(O_i-E_i, O_l-E_l)$ para $i=1,2,\ldots , G-1$; $l=1,2, \ldots , G-1$.
\end{itemize}

Luego, el estadístico log-rank viene dado por la fórmula del producto matricial:
$$ Log-rank = \mathbf{d}^{\prime} \mathbf{V}^{-1}\mathbf{d},$$
que se distribuye aproximadamente $\chi^2_{G-1}$ bajo la hipótesis nula de que los $G$ grupos tienen igual curva de supervivencia.

\section{Modelo de Cox \label{sec:ModCox}}
%Analisis de sobrevivencia utilizando el lenguaje R - Refael Borges Peña (cap 5 enviado al mail por Natalia)
El modelo de riesgos proporcionales de \cite{cox1972regression} establece una expresión del riesgo en el tiempo $t$ para un individuo con un conjunto específico de variables explicativas.

Formalmente, según \cite{pena2005analisis}, el riesgo para un individuo se define de la siguiente manera:
\begin{equation}
h(t;X)= h_0(t) e^{\sum_{i=1}^p \beta_i X_i},
\end{equation}
donde $X=(X_1, X_2 \ldots X_p)$ es el vector de variables explicativas o predictoras para ese individuo.

La fórmula del modelo de Cox dice que el riesgo en el tiempo $t$ es el producto de dos cantidades. La primera de ellas $h_0(t)$, es llamada función de riesgo base y es llamada así porque la fórmula del modelo cumple la propiedad de que si todas las $X$'s son iguales a $0$, o visto desde otra perspectiva, no hay $X$'s en el modelo, la fórmula se reduce a esa función. Además es una función que se asume desconocida, la que hace al modelo de Cox un modelo semiparamétrico. Es una función de $t$ que no involucra las $X$'s. La segunda cantidad es la expresión exponencial a la suma lineal de $\beta_i X_i$, donde la suma es sobre las $p$ variables explicativas $X$.

Otra propiedad interesante del modelo de Cox, es que, a pesar de que la parte de riesgo base del modelo no está especificada, es posible estimar los $\beta$'s en la parte exponencial.
A continuación se describe como pueden obtenerse estimaciones de los parámetros del modelo de Cox, utilizando un enfoque basado en la función de verosimilitud.

\subsection{Estimación por máxima verosimilitud \label{subsec:ML_Cox}}
Las estimaciones de máxima verosimilitud de los parámetros del modelo de Cox se derivan al maximizarse una función de probabilidad, que generalmente se denota como $L$. La función de verosimilitud es una expresión matemática que describe la probabilidad conjunta de obtener los datos realmente observados, en función de los parámetros desconocidos ($\beta$'s) en el modelo considerado.

La fórmula para la función de verosimilitud del modelo de Cox en realidad se llama \emph{función de verosimilitud parcial}. Este término se usa porque la fórmula de verosimilitud considera las probabilidades solo para aquellos individuos que presentan el evento, y no considera explícitamente las probabilidades para aquellos que son censurados.

Entonces, definiendo $\lambda_i = e^{\beta_i X_i}$ y suponiendo que una muerte ha ocurrido en el tiempo $t^{\ast}$, la verosimilitud de que la muerte le ocurra al individuo $i$-ésimo y no a otro individuo es:
\begin{equation}
L_i({\beta}) = \dfrac{h(t^{\ast},X_i)}{\sum_{l \in R(t^{\ast})} h(t^{\ast},X_l)} = \dfrac{h_0(t^{\ast})\lambda_i(t^{\ast})}{\sum_{l \in R(t^{\ast})} h_0(t^{\ast})\lambda_l(t^{\ast})} = \dfrac{\lambda_i(t^{\ast})}{\sum_{l \in R(t^{\ast})} \lambda_l(t^{\ast})}.
\end{equation}
En particular, la verosimilitud parcial puede escribirse como un producto de varias verosimilitudes, una para cada timepo de falla $k$,y se expresa como:
$$ L = L_1 \times L_2 \times L_3 \times \ldots \times L_k = \prod_{i=1}^{k} L_i .$$
Una vez que se forma la función de verosimilitud para un modelo dado, el siguiente paso es maximizar esta función de los parámetros o, de manera equivalente su logaritmo natural (la función de log-verosimilitud).

\subsection{Interpretación del modelo \label{subsec:ModCox_interp}}
La interpretación del modelo de Cox no se hace directamente a través de su parámetro estimado sino del exponencial de dicho parámetro estimado, $e^{\hat{\beta_i}}$, para la variable $X_i$.

Para variables dicotómicas $e^{\hat{\beta_i}}$ es un estimador de la razón de riesgos y se interpreta como la cantidad de riesgo que se tiene con la presencia de cada covariable en relación a la ausencia del resto de las covariables.

Los intervalos de confianza al $95\%$ para $e^{\hat{\beta_i}}$ se obtienen mediante:
$$ exp \left[\hat{\beta_i} \pm 1.96 se(\hat{\beta_i})\right], $$ donde $se(\hat{\beta_i}) = \sqrt{\hat{Var}(\hat{\beta}_1)}$ es el error estándar de $\hat{\beta_i}$.

Para el caso de covariables continuas, $e^{\hat{\beta_i}}$ representa la razón de riesgos al incrementar en una unidad la covariable $X_i$.

\subsection{Contrastes de hipótesis \label{subsec:signif_Cox}}
Una vez que se ajusta el modelo de Cox, existen tres contrastes de hipótesis para verificar la significación del modelo testenado $H_0:\beta = \beta_0$ versus $H_1:\beta \neq \beta_0$: test de razón de verosimilitud, test de Wald y test de puntajes. A menudo estos test arrojan resultados similares.

El test de Wald tiene una interpretación más directa que el test de verosimiitud y el de puntajes, sin embargo no es invariante ante diferentes parametrizaciones y los otros dos si. Con el test de puntajes solo hace falta maximizar bajo la hipótesis nula, con lo que si hay que realizar el test para varios parámetros es más rapido computacionalmente. Sin embargo, el test de máxima verosimilitud converge más rápido hacia la distribución normal.

\subsubsection{Test de razón de verosimilitud \label{subsec:verosimil}}
Es el que presenta mayor confiabilidad. En este contraste se utiliza el valor de la función de verosimilitud parcial evaluada en $\hat{\beta}$, $L(\hat{\beta})$, y evaluada en $\beta_0$, $L(\hat{\beta}_0)$:
\begin{equation}
\chi_{LR} = -2 \lbrace log(L (\beta_0)) - log(L (\hat{\beta})) \rbrace,
\end{equation}
que bajo la hipótesis nula sigue una distribución $\chi^2_p$.

\subsubsection{Test de Wald \label{subsec:Wald}}
Es quizás el test mas natural debido a que proporciona un contraste por variables en lugar de una medida de significación global. Se basa en que los parámetros $\hat{\beta} = (\hat{\beta}_1, \ldots, \hat{\beta}_p)$ siguen una distribución aproximadamente normal con media $(\hat{\beta}_1, \ldots, \hat{\beta}_p)$ y matriz de varianzas y covarianzas $\hat{\sum}_{\hat{\beta}}$. El estadístico se define como:
\begin{equation}
\chi_W = (\hat{\beta} - \beta_0)^{t}\hat{\sum}_{\hat{\beta}}^{-1}(\hat{\beta} - \beta_0),
\end{equation}
que bajo la hipótesis nula sigue una distribución $\chi^2_p$.

\subsubsection{Test de puntajes (score test) \label{subsec:score}}
En este contraste se utiliza el gradiente (derivadas) del logaritmo de la verosimilitud parcial evaluada en la hipótesis nula y supone que bajo la hipótesis nula el vector de puntajes:
\begin{equation}
\chi_S = \left(\dfrac{\partial L(\beta_0)}{\partial \beta} \right)^t \left(- \dfrac{\partial L^2(\beta_0)}{\partial \beta \partial \beta^t} \right)^{-1} \dfrac{\partial L(\beta_0)}{\partial \beta},
\end{equation}
es aproximadamente multinormal de medias 0 y matriz de varianzas y covarianzas $\hat{\sum}_{\hat{\beta}}$, con lo que el estadístico sigue también una distribución $\chi^2_p$.

\subsection{Estudio de los residuos del modelo \label{subsec:residuos}}
Los residuos se representan gráficamente frente a alguna cantidad, y el patrón observado se utiliza para diagnosticar posibles problemas con el modelo ajustado. Algunos residuos tienen la propiedad adicional de no solo indicar problemas sino también sugerir correcciones.

Existen cuatro tipos de residuos de interés en el modelo de Cox: los residuos de martingala, los de desvíos (devianza), los de puntaje (score) y los de Schoenfeld. De estos cuatro residuos pueden derivarse otros dos: los dfbetas y los residuos escalados de Schoenfeld.

A continuación se definen y explican brevemente cada uno de ellos \citep{moore2016applied}.

\subsubsection{Residuos martingala}
Los residuos martingala son una transformación de los residuos denominados Cox-Snell. Tienen una distribución asimétrica y su esperanza debería ser asintoticamente 0. Son útiles para indicar si con las covariables del modelo se han predicho bien los tiempos de supervivencia. Sirven para analizar transformaciones de las covariables que mejoren dichos residuos. Su fórmula es:
\begin{equation}
R_{M_i} = \delta_i - R_i,
\end{equation}
para $i = 1, \ldots, n$, siendo $\delta_i$ el indicador del si el sujeto está o no censurado. Donde $R_i = -log \left(\hat{S}(t_i,X_i) \right)$ son los denominados residuos de Cox-Snell extendidos. Los residuos de Cox-Snell se utilizan del siguiente modo: si el modelo de riesgos proporcionales estimado es adecuado el gráfico de dichos residuos y su correspondinete curva Kaplan-Meier, $\hat{S}(R)$, aparecerían como una recta de 45 grados.

\subsubsection{Residuos de desvíos (devianza)}
Los residuos de desvíos si se distribuyen de forma simétrica alrededor del cero y sirven para analizar el ajuste del modelo para cada sujeto no censurado y por lo tanto detectar observaciones atípicas. Su fórmula es:
\begin{equation}
R_{D_i} = signo\left(R_{M_i}\right) \sqrt{2\left[ - R_{M_i} - \delta_i log \left(\delta_i - R_{M_i} \right) \right]},
\end{equation}
para $i = 1, \ldots, n.

\subsubsection{Residuos de puntajes (scores)}
Los residuos de puntajes se calculan para cada sujeto y cada covariable. Los gráficos de estos versus las covariables (una a una) indican la influencia de los individuos en la estimación de los parámetros. Los \emph{dfbeta} y \emph{dfbetas} (el dfbeta estandarizado) se calculan para cada sujeto e indican el cambio aproximado en el vector de parámetros si el sujeto concreto no estuviese en el modelo. Su fórmula es:
\begin{equation}
R_{P_{ij}}(t) = \int_0^t X_{ij} (u) - \bar{X}_{ij} (u) d\hat{M}_i (u),
\end{equation}
para $i=1, \ldots, n$. Donde:
$$ \bar{X}_j(u) = \dfrac{\sum_{i=1}^n J_i(t) X_{ij} e^{\beta X_i(t)}}{\sum_{i=1}^n J_i(t) e^{\beta X_i(t)}} \quad y \quad \hat{M}_i(u) = N_i(u) - \int_0^t J_i(s) e^{\beta X_i(s)} d\hat{H}_0(s),$$
siendo $J_i(t) = 1$ si el individuo $i$ está en riesgo antes del tiempo $t$, y $N_i(t)$ el indicador del proceso de conteo (\emph{counting process}) de si el individuo $i$-ésimo ha tenido un evento. Se observa que estos residuos tienen en cuenta variables dependientes del tiempo y su expresión se particulariza cuando las variables son independientes del tiempo.

\subsubsection{Residuos de Schoenfeld}
Los residuos de Schoenfeld se calculan para cada covariable y para cada individuo. Se definen como:
\begin{equation}
R_{S_{ij}} = \delta_i \left(X_{ij} - \dfrac{\sum_{l \in R(t_{(i)})} X_{lj} e^{\hat{\beta}X_l}}{\sum_{l \in R(t_{(i)})} e^{\hat{\beta}X_l}} \right),
\end{equation}
para $i=1, \ldots, n$ y $j=1, \ldots, p$, siendo $\delta_i$ el indicador de si el sujeto está censurado o no. Por lo tanto estos residuos solo están definidos para los individuos no censurados.

Los residuos de Schoenfeld son útiles para la verificación del supuesto de riesgo proporcional en el modelo de Cox el cual se expresa en la siguiente subsección.

\subsection{El supuesto de riesgos proporcionales \label{subsec:riesprop}}
El supuesto de riesgos proporcionales requiere que el riesgo para un individuo sea proporcional al riesgo para cualquier otro individuo, siendo la constante de proporcionalidad independiente del tiempo. Esto es:
$$\dfrac{\hat{h}(t, X^*)}{\hat{h}(t, X)} = \dfrac{\hat{h}_0(t) e^{\sum_{i=1}^{p} \hat{\beta}_i X^*_i}}{\hat{h}_0(t) e^{\sum_{i=1}^{p} \hat{\beta}_i X_i}} = e^{\sum_{i=1}^{p} \hat{\beta}_i (X_i^* - X_i)},$$
donde $X^* = (X_1^*, X_2^*, \ldots, X_p^*)$ y $X = (X_1, X_2, \ldots, X_p)$ denotan el conjunto de $X's$ para dos individuos.

Por lo tanto, la expresión final para la relación de riesgo involucra los coeficientes $\beta_i$ gorro estimados y los valores de $X^*$ y $X$ para cada variable. Sin embargo, debido a que el riesgo base se cancela, la expresión final no depende del tiempo $t$.

Para una covariable en particular se cumplirá la hipótesis de proporcionalidad de los riesgos si los residuos de Schoenfeld de dicha covariable no están correlacionados con los tiempos de supervivencia. Gráficamente, si se dibujan los residuos de Schoenfeld de la covariable, estos serán horizontales si se cumple la hipótesis de riesgos proporcionales ya que en tal caso los residuos son independientes del tiempo.

Para la realización se deben calcular los residuos de Schoenfeld del modelo de Cox en estudio; ordenar los tiempos de falla etiquetando el orden a cada tiempo; calcular la correlación entre los residuos y la variable de orden creada. Y se realiza el test de si $H_0: \rho = 0$ para cada covariable por separado. En el caso de aceptar la hipótesis nula de que la correlación es cero, se cumplirá la hipótesis de riesgos proporcionales para la covariable correspondiente.

\subsection{Curvas de supervivencia ajustadas \label{subsec:superv_ajustada}}
Cuando se usa un modelo de Cox para ajustar los datos de supervivencia, se pueden obtener curvas de supervivencia que se ajustan a las variables explicativas utilizadas como predictores.

La fórmula de la función de supervivencia detallada seguidamente, es la base para determinar las curvas de supervivencia ajustadas.
$$S(t,X) = [S_0(t)]^{e^{\sum_{i=1}^{p} \beta_i X_i}}.$$
Esta fórmula expresa que la función de supervivencia en el tiempo $t$ para un individuo con el vector de covariables $X$ viene dada por una función de supervivencia base $S_0(t)$, aumentada a una potencia igual a la exponencial de la suma de $\beta_i$ veces $X_i$

Luego, la expresión para la función de supervivencia estimada es la siguiente:
$$\hat{S}(t,X) = [\hat{S}_0(t)]^{e^{\sum_{i=1}^{p} \hat{\beta}_i X_i}}.$$

\subsection{Modelo extendido de Cox}
La fórmula del modelo de Cox establece que el riesgo en el tiempo $t$ es el producto de dos cantidades. La primera de ellas, $h_0(t)$, es llamada función de riesgo base. La segunda cantidad es la expresión exponencial $e$ a la suma lineal de $\beta_i X_i$, sobre las $p$ variables explicativas $X$.
Una característica importante de esta fórmula, que refiere al supuesto de riesgos proporcionales, es que el riesgo base es una función de $t$ que no involucra las $X$'s mientras que la expresión exponencial involucra las $X$'s pero no involucra $t$. Las $X$'s en ese caso son llamadas \emph{independientes del tiempo} ya que para un sujeto dado, su valor permanece constante en el tiempo. Es posible, no obstante, considerar $X$'s que difieran con el tiempo, llamadas variables \emph{dependientes del tiempo}.

Dada una situación de análisis de supervivencia que involucra variables predictoras independientes y dependientes del tiempo, se puede escribir el  \textbf{modelo extendido de Cox} que incorpora ambos tipos de variables, de la siguiente manera:

$$ h(t, X(t)) = h_0(t) e^{\sum_{i=1}^{p_1} \beta_i X_i + \sum_{j=1}^{p_2} \delta_j X_j(t)}, $$ siendo $$X(t) = (\underbrace{X_1, X_2, \ldots X_{p_1}}_{\textrm{independ. del tiempo}}, \underbrace{X_1(t), X_2(t), \ldots X_{p_2}(t)}_{\textrm{depend. del tiempo}}).$$

La parte exponencial contiene variables independientes del tiempo, indicados por las $ X_i $, y variables dependientes del tiempo, indicados por las variables $ X_j (t) $.

Otra opción es crear variables dependientes del tiempo a partir de variables independientes del tiempo, definiendo términos de productos entre cada variable y alguna función del tiempo. Es decir, si las variables independientes del tiempo se denotan como $X_i$, se puede definir el término del producto $i$-ésimo como $X_i \times g_i(t)$, donde $g_i(t)$ es alguna función del tiempo para la variable $i$-ésima, quedando expresado de la siguiente forma:

$$ h(t, X(t)) = h_0(t) e^{\sum_{i=1}^p \beta_i X_i + \sum_{i=1}^p \delta_i X_i g_i(t)}. $$

La forma más simple para $g_i(t)$ es que todos los $g_i(t)$ sean idénticamente $0$ en cualquier momento del tiempo; esta sería otra manera de establecer el modelo de riesgos proprocionales original, que no contiene términos dependientes del tiempo. Una segunda opción es dejar $g_i(t) = t$. Esto implica que para cada $X_i$ del modelo, hay una variable dependiente del tiempo correspondiente de la forma $X_i \times t$. Si se quiere centrar en una variable particular independiente del tiempo, por ejemplo, la variable $X_L$, entonces $g_i(t) = t$ para $i = L$, pero es igual a $0$ para todos los demás $i$. También ese podría elegir $g_i(t)$ como el log de $t$, de modo que las variables dependientes del tiempo correspondientes tendrán la forma $X_i \times ln t$. Y otra opción más sería dejar que $g_i(t)$ sea una ``función de cabecera" de la forma $g_i(t) = 1$ cuando $t$ está por encima de un tiempo específico, $t_0$, y $g_i(t) = 0$ cuando $t$ está por debajo de $t_0$.

Al igual que con el modelo de riesgos proporcionales de Cox más simple, los coeficientes de regresión en el modelo extendido, se estiman utilizando un procedimiento de máxima verosimilitud en el que se maximiza la función de verosimilitud parcial $L$.

Los métodos para hacer inferencias estadísticas son esencialmente los mismos que para el modelo de riesgos proporcionales. Es decir, se pueden usar las pruebas de Wald y/o la razón de verosimilitud y los métodos de intervalo de confianza para muestras grandes.

Una suposición importante del modelo extendido de Cox, es que el efecto de una variable dependiente del tiempo $ X_j(t) $ sobre la probabilidad de supervivencia en el tiempo $t$, depende del valor de esta variable en ese tiempo $t$, y no en el valor en un momento anterior o posterior.



\section{Estimación de la función de riesgo \label{sec:EstFunRiesgo}}
\cite{ivanka2012kernel} introducen la noción de estimación de la función de riesgo como se explica a continuación.

\cite{nelson1972theory} propuso estimar la función de riesgo acumulado mediante
\begin{equation}
\mathcal{H}_n (x) = \sum_{X_{(i)} \leq x} \frac{\delta_{(i)}}{n-i+1},
\end{equation}
donde $n$ es el número de tiempos de fallas diferentes y $\delta_{(i)}$ es el indicador de censura correspondiente al instante $t_i$.

Luego, la estimación por núcleo de la función de riesgo $h$ es la siguiente convolución del núcleo $K$ con el estimador de la función de riesgo de Nelson $\mathcal{H}_n$
\begin{eqnarray}
\hat{h} (x,b) &=& \dfrac{1}{b} \int K \left(\dfrac{x - u}{b}\right) d\mathcal{H}_n (u) \\
 & = & \dfrac{1}{b} \sum_{i=1}^{n} K \left(\dfrac{x - X_{(i)}}{b}\right) \frac{\delta_{(i)}}{n-i+1}.
\end{eqnarray}

Estas estimaciones (las estimaciones por núcleos) dependen de un parámetro de suavizado llamado ancho de banda ($b$) que controla la suavidad de la estimación y de un núcleo ($K$) que desempeña el papel de función de peso. En lo que se refiere a la función del núcleo, un parámetro clave es su orden, que se relaciona tanto con el número de sus momentos de fuga como con el número de derivadas existentes para la curva subyacente que debe estimarse.

El núcleo $K$ de orden 2 presenta las siguientes propiedades:
\begin{itemize}
	\item Está acotado en el intervalo $[-1,1]$. $\left( soporte(K) = [-1,1] \right).$
	\item Es una función lipschitziana en ese intervalo, es decir que no oscila demasiado. $\left(K \in Lip[-1,1] \right).$
	\item Tiene media igual a cero. $\left(\int_{-1}^1 x K(x)dx = 0 \right).$
	\item Tiene momento segundo finito.  $\left(\int_{-1}^1 x^2 K(x)dx = \beta_2 (K) \neq 0 \right).$
	\item Integra 1. $\left(\int_{-1}^1 K(x)dx = 1 \right).$
\end{itemize}

\citep{muller1994hazard} proponen una modificación del estimador de suavizado por núcleos de Nelson, en el que se permiten grados de suavizado variables en diferentes puntos, así como la implementación de núcleos en los bordes, definido de la siguiente manera:
\begin{equation}
\hat{h} (x,b) \equiv \hat{h} (t,b(x))  = \dfrac{1}{b(x)} \sum_{i=1}^{k} K_x \left(\dfrac{x - X_{(i)}}{b(x)}\right) \frac{\delta_{(i)}}{k-i+1}.
\label{estimadorMuller}
\end{equation}

Aquí, el ancho de banda $b=b(x)$ al igual que el núcleo $K = K_x$ dependen del punto $x$ en donde la estimación es calculada.

Las propiedades del estimador por núcleos y de la modificación propuesta por Muller y Wang, se presentan en el Anexo \ref{ane:PropEst}.

\subsection{Elección de la forma del núcleo $K$ \label{subsec:K}}
Para los núcleos pertenecientes a la clase $S_{0,2}$, el que cumple la condición de optimalidad, es el núcleo de Epanechnikov con el cual se trabajará en el presente trabajo \citep{ivanka2012kernel}.

El núcleo de Epanechnikov se define de la siguiente manera:
$$ K(x) = \dfrac{3}{4}(1 - x^{2}) I_{[-1,1]}(x). $$
Se puede observar en la Figura \ref{Epanech} la forma de dicho núcleo.

\begin{figure}[hbpt]
\begin{center}
\includegraphics[scale = 0.5]{grafi/Nucleo_Epanech.png}
\caption{Núcleo de Epanechnikov. \label{Epanech}}
\end{center}
\end{figure}


\subsection{Elección del ancho de banda $b$ \label{subsec:b}}
El problema de elegir cuánto suavizar, es decir, cómo elegir el ancho de banda es un problema crucial común en el suavizado por núcleos.

Hay dos posibles métodos en el algoritmo a ser utilizado que contemplan las estimaciones antes mencionadas, en la que se considera un único ancho de banda para todos los puntos y la variación en la que se considera un ancho de banda variable. La primera de ellas es considerada como el \textbf{método global}, el ancho de banda óptimo con dicho método se obtiene al minimizar el Error Cuadrático Medio Integrado (IMSE). Para el \textbf{método local}, en donde se utilizan diferentes anchos de banda en cada punto, el ancho de banda óptimo en un punto se obtiene minimizando el Error Cuadrático Medio (MSE) local \citep{muhaz}.

La elección del ancho de banda inicial depende de la situación específica, pero es muy importante para obtener el mejor ancho de banda. Un posible valor sugerido por Muller y Wang es $ b.inicial = \frac{R}{8 * m_u^{1/5}}$, suponiendo que los datos están disponibles en $[0, R]$, y $m_u$ es el número de observaciones sin censura.

\subsection{Efecto borde \label{subsec:Bordes}}
Al igual que anteriormente, se supone que los datos están disponibles en $[0,R]$. Cuando la estimación es cerca de $0$ o $R$, pueden ocurrir lo que comúnmente se denomina efectos de borde. Esto puede llevar a problemas de sesgo o estimaciones negativas de la función de riesgo cerca de esos puntos finales de los datos.

Hay varios métodos para corregir los efectos de borde; uno de ellos se basa en la construcción de núcleos de borde especiales tal y como en el estimador de la Ecuación \ref{estimadorMuller}.

Al núcleo de Epanechnikov, \cite{muller1994hazard} lo definen en los bordes como:
$$ \dfrac{12}{(1+q)^{4}}(x+1) \left[\dfrac{x(1-2q)+(3q^{2}-2q+1)}{2}\right]. $$


\subsection{Intervalos de confianza \label{subsec:Conf2}}
Los intervalos de confianza para la estimación de la función de riesgo $\hat{h}^{(v)} (\cdot, b_{opt,v,k})$ se pueden construir tal y como se describe en el libro de \cite{ivanka2012kernel}.

El intervalo de confianza asintótico $(1 - \alpha)$ para $h^{(v)}(x, b)$ viene dado por
$$\hat{h}^{(v)} (x,b)  \pm \left\{ \dfrac{\hat{h}(x,b)V(K)}{(1 - L_n(x))n\hat{b}^{2v+1}}\right\}^{1/2}  \Phi^{-1}(1-\alpha/2),$$
donde $\Phi$ es la función de distribución normal estándar.


%%%%%%%%%%%%%%%%%%%%%%%%%%% ANALISIS EXPLORATORIO DATOS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Descripción y análisis exploratorio de los datos \label{cap:Dat}}
En este capítulo en primer lugar se define el universo de análisis y la fuente de donde se obtuvieron los datos (Sección \ref{sec:Univer}).

Luego se presentan algunos resultados del análisis exploratorio de los datos realizado. Se distingue entre primera vida (Sección \ref{sec:PV}) y segunda vida (Sección \ref{sec:SV}) de las tablets y para analizar cada una de ellas, se presentan cuadros y gráficos con la cantidad de defunciones y censuras, las fecha de inicio y finalización de los episodios y duración de los mismos, las causas de defunción, y las posibles variables explicativas que se puedan incluir a los modelos, tales como variables sociodemográficas de las alumnas y alumnos: sexo, área geográfica y contexto sociocultural, y variables que cuantifican la entrada  de las tablets a servicio técnico.

Las visualizaciones fueron realizadas con el paquete \texttt{ggplot2} \citep{ggplot}.

\section{Universo de análisis y fuente de datos \label{sec:Univer}}
El universo de análisis considerado en este trabajo refiere a toda la generación del modelo de tablets entregado por Ceibal, pertenecientes a alumnas y alumnos del sistema educativo público que a partir de 2014 ingresaron a educación primaria cursando primer, segundo o tercer grado, en escuelas comunes del todo el país.

Los datos utilizados fueron brindados por el Plan Ceibal tanto de los alumnos y las alumnas matriculadas en primaria a los cuales se les entregó ese modelo de tablet en el 2014 o 2015 y sus respectivas escuelas y características (Fuente CRM), cómo de las bases de datos de las Órdenes de Trabajo (OT) asociadas a las reparaciones de las tablets realizadas, entre el 2014 y 2017, por Servicio Técnico (ST) de Plan Ceibal (Fuente K2B), observando en los registros administrativos el tipo de desperfecto que presentó  el equipo y en qué  momento del tiempo lo hizo.


\section{Análisis exploratorio de los datos de las tablets \label{sec:Descri}}
En primer lugar  se definen la primera y segunda vida de las tablets, así como una breve descripción del proceso de creación de dichos subconjuntos de datos.

Se considera la \textbf{primera vida} de las tablets, desde el momento en que estas son entregadas a las alumnas y los alumnos de primaria (respetando un proceso planificado por Ceibal) hasta que presentan un primer evento, o son cambiadas por otro dispositivo por parte de Ceibal, sin haber tenido antes ninguna reparación que implique su defunción, considerándose por lo tanto censuradas.

Se considera la \textbf{segunda vida} de esta generación de tablets, desde el momento en que estas fueron reparadas luego de su primer defunción y vueltas a entregar a los mismos u otros alumnos o alumnas, hasta que presentan el segundo evento o son censuradas al ser cambiadas por otros dispositivos por parte de Ceibal.

<<r lectura datos, echo=FALSE >>=
#Se carga la tabla final de la primera vida y la tabla final de la segunda vida, ambas con el análisis de calidad de datos ya realizado
load("Datos/Primera_y_segunda_vida.RData")
@

Se comienza trabajando con cinco tablas iniciales: \textit{OT}, \textit{Ventas}, \textit{Personas}, \textit{Relación Extendida} y \textit{Empresas}. Las mismas contienen los datos de las reparaciones realizadas por servicio técnico, las características de la entrega de los equipos, datos de las personas que los recibieron y datos de las instituciones a las que concurren dichas personas. Luego se filtran las cinco tablas para que contengan sólo datos de estudiantes de primaria a los que se les entregó, en 2014 o 2015, ese modelo de tablet, eliminando el resto de las observaciones. Finalmente se crean dos bases para cada una de las vidas de la tablet. La primera de ellas cuenta  con
\Sexpr{dim(PrimeraVida)[1]} observaciones correspondientes a la primera vida, mientras que la segunda con \Sexpr{dim(SegundaVida)[1]} correspondientes a la segunda vida.

\subsection{Primera vida de las tablets \label{sec:PV}}
<<r primera vida, echo=FALSE, cache=TRUE>>=
#Se crean dos sub bases correspondientes a cada año de entrega que se utilizarán luego para los gráficos.
PV2014 <- PrimeraVida[PrimeraVida$AnioVenta == "2014",]
PV2015 <- PrimeraVida[PrimeraVida$AnioVenta == "2015",]
#Se crea una subbase en la que se encuentran solo las tablets que murieron que se utilizará luego para los gráficos.
defun <- PrimeraVida[PrimeraVida$IndDef == "Defunción",]
@
En primer lugar, se debe mencionar que fue necesario depurar la base de datos al encontrarse con casos duplicados y números de series de los equipos que no contaban con registros asociados en algunas de las variables, además de irregularidades y errores de registro. Se realiza para ello un trabajo en la curación de los datos atendiendo las siguientes dimensiones: exactitud, validez, completitud y consistencia. Se analizan  por ejemplo, mismas personas con diferentes roles (estudiantes y docentes), duplicados en número de serie y fecha en que fueron entregados, valores perdidos (missing data), registros de consumo de repuestos de otros equipos distintos al modelo en estudio, duraciones negativas o menores a un día de vida, entre otras.

Se obtiene entonces una base con la primera vida de las tablets de \Sexpr{length(unique(PrimeraVida$Serie))} números de series, habiéndose entregadas \Sexpr{dim(PV2014)[1]} de estas en 2014 y \Sexpr{dim(PV2015)[1]} en 2015, \Sexpr{length(unique(PrimeraVida$CodCeibal))} escuelas públicas, a \Sexpr{length(PrimeraVida$Grado[PrimeraVida$Grado == "1º"])} estudiantes de primero, \Sexpr{length(PrimeraVida$Grado[PrimeraVida$Grado == "2º"])} estudiantes de segundo y \Sexpr{length(PrimeraVida$Grado[PrimeraVida$Grado == "3º"])} estudiantes de tercero (las restantes fueron entregadas a algunos alumnos de cuarto, quinto y sexto).

\subsubsection{Defunciones y censuras \label{subsec:Def}}
<<echo=FALSE, cache=TRUE>>=
t1 = addmargins(table(PrimeraVida$IndDef, useNA = "ifany"))

#Según año de entrega de los equipos
t2 = addmargins(table(PrimeraVida$IndDef, PrimeraVida$AnioVenta, useNA = "ifany"))
@

Se entiende que una tablet de Ceibal es sobreviviente cuando presenta condiciones técnicas suficientes para ser operativa para el alumno o la alumna. Por el contrario, la \textit{muerte} o \textit{defunción} del dispositivo se considera cuando el mismo presenta roturas que no permiten el correcto funcionamiento, limitando el acceso tanto a la nueva tecnología como a la información. Se diferencian las roturas que implican la defunción de la tablet de otros tipos de rotura que no impiden el funcionamiento de la misma aún cuando tenga desperfectos (véase sección \ref{subsec:Causas}).

Por otro lado la \textit{censura} del dispositivo en este estudio significa que si bien las tablets pueden seguir funcionando (no ocurrió el evento aún), la ventana del tiempo de observación se cierra, ya que el dispositivo fue retirado y cambiado por otro por parte de Ceibal, sin haberse observado el evento hasta ese momento. El tiempo de vida real del dispositivo censurado es mayor que el que se considerará, pero desconocido.

Considerando los equipos entregados en 2014 y 2015 como dos generaciones distintas,  la mortalidad fue del \Sexpr{round((t2[2,1]/t2[3,1])*100, 1)}\% (\Sexpr{t2[2,1]} tablets) para la generación del 2014 y del \Sexpr{round((t2[2,2]/t2[3,2])*100, 1)}\% (\Sexpr{t2[2,2]} tablets) para la del 2015.

Las defunciones contemplan dos tipos de registros considerados: el evento registrado por servicio técnico en sus órdenes de trabajo (OT) y el registro por lo que se considera una sustitución, esto es, registros de equipos que fueron entregados para reemplazar otros y no por el sistema normal de entregas\footnote{En la programación se considera que el equipo murió por sustitución si, ordenados previamente los registros por \emph{Persona}, \emph{FechaVenta} y \emph{Serie}, para dos observaciones de la misma persona, la fecha de cambio de estado de su primer registro es igual a la fecha de venta de su segundo registro y además la variable \emph{Sust} es igual a \emph{Sustitucion} en el último de ellos.}.

En la Figura \ref{graf:IndDef} se presenta un gráfico de mosaico. En \citep{hofmann2000exploring} se presentan los gráficos de mosaicos y se describen los mismos en base a su semejanza gráfica con las tablas de contingencia multivariadas; cada celda de una tabla de correspondencia se visualiza mediante un mosaico, y el tamaño del mismo es directamente proporcional al número de casos en esa celda. Mientras que por ejemplo en un gráfico de barras se comparan valores absolutos, en un mosaico se muestran proporciones relacionadas con los tamaños de muestra de cada subconjunto. La altura de los rectángulos corresponde a la probabilidad marginal de las categorpias de la variable y el ancho de los rectángulos corresponde a la propabilidad condicional dentro de los niveles indicados para la otra variable.

En la Figura \ref{graf:IndDef} se muestra la proporción entre defunciones y censuras variando con el año de entrega del equipo. Se observa que no hay prácticamente diferencias entre un año y otro, pero condicional al año de entrega, en 2015 hay más defunciones.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3.5, fig.align="center", cache=TRUE, warning=FALSE>>=
ggplot(data = PrimeraVida) +
  geom_mosaic(aes(x = product(AnioVenta), fill = fct_infreq(IndDef))) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Año de entrega", y = "Estado final") +
  theme(aspect.ratio = 1,legend.position = "none")
@
\caption[Estado final de la primera vida de las tablets según año de entrega.]{Gráfico de mosaico que muestra la proporción de tablets que presentaron defunciones  o censuras (estado final) en la primera vida, por separado para la generación de las \Sexpr{nrow(PrimeraVida[PrimeraVida$AnioVenta == "2014",])} tablets entregadas en 2014 y para la generación de las \Sexpr{nrow(PrimeraVida[PrimeraVida$AnioVenta == "2015",])} entregadas en 2015. \label{graf:IndDef}}
\end{figure}

\subsubsection{Fechas de inicio y fechas de finalización \label{subsec:FIyFF}}
El proceso de entrega de las tablets varía según la planificación de Ceibal dentro de cada año, 2014 y 2015. Algunas pueden haber sido entregadas por ejemplo al comienzo del año, pero otras cuando este ha avanzado más. Lo mismo sucede con el proceso de recambio en 2017. Debido a esto, el período de riesgo es diferente para cada uno de los equipos.

<<echo=FALSE, cache=TRUE>>=
#Fecha de inicio (corresponde  a la fecha de entrega del equipo)
FechaVenta <- data.frame(table(substr(PrimeraVida$FechaVenta, 1, 10)))
FechaVenta$Var1 <- as.Date(FechaVenta$Var1)

#Fecha de muerte o censura
FechaFinal <- data.frame(table(substr(PrimeraVida$FechaFinal, 1, 10)))
FechaFinal$Var1 <- as.Date(FechaFinal$Var1)
@

La fecha de inicio de la primera vida de las tablets corresponde a la fecha en que estas fueron entregadas por primera vez a las alumnas y los alumnos, mediante el proceso de entregas de Plan Ceibal.

Se muestra en la Figura \ref{graf:FE} las fechas de inicio de los episodios, representando el proceso de entregas antes mencionado. Se diferencian claramente dos períodos de entrega, entre julio y noviembre en 2014 y entre fines de mayo y mediados de julio en 2015, correspondientes a las dos generaciones de estudio. El día que se entregaron mas tablets (\Sexpr{max(FechaVenta$Freq)} equipos) fue el 25 de junio del 2015.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=2.5, fig.width=6, fig.align="center", cache=TRUE>>=
ggplot(data = FechaVenta) +
  geom_line(aes(x = Var1, y = Freq)) +
  geom_point(aes(x = Var1, y = Freq), size = 0.3) +
  scale_x_date(date_breaks = "3 months") +
  labs(x = "Fecha de inicio del episodio", y = "Cantidad de tablets")
@
	\caption[Fechas de inicio de la primera vida de las tablets.]{Serie temporal con las fechas de inicio de los episodios, es decir las fechas de entrega de las \Sexpr{nrow(PrimeraVida)} tablets que dan inicio a la  primera vida de las mismas. En el gráfico se diferencian claramente dos períodos de entrega, entre julio y noviembre de 2014 y mayo y julio de 2015. \label{graf:FE}}
\end{figure}

La fecha de finalización del episodio, para todas las tablets que presentan una defunción, corresponde a la fecha registrada en la OT en la que se comienza a realizar una reparación al equipo que ya no funciona. En el caso de las defunciones por sustitución en particular, la fecha de finalización corresponde a la fecha en que se le entregó a la alumna o el alumno un equipo que sustituye el suyo el cual es retirado para ser reparado por lote.

Considerando que la rotura de la tablet se evidencia cuando el alumno o la alumna lleva su tablet a reparación, se introduce el supuesto de que el intervalo de tiempo entre que se produce efectivamente la rotura y el momento en que se registra en la OT no debiera ser sustancial, ya que Plan Ceibal ha dispuesto varios medios por los cuales los alumnos y las alumnas pueden llevar a reparar sus equipos; el servicio de reparación móvil visita los centros educativos frecuentemente, por otro lado hay centros de reparación fija en distintas ciudades del país a donde el alumnado puede llevar sus equipos o incluso enviarlos a través del Correo Uruguayo para que sean reparados, no generando ninguno de estos medios de reparación un costo económico para el alumno o la alumna.

En cuanto a las tablets que se consideran censuradas, la fecha de finalización de su vida es cuando se le entrega al alumno o la alumna un nuevo modelo de tablet o laptop retirándoles definitivamente el que ya tenían, cerrando así la ventana de observación de las mismas. Corresponde a la fecha en que en los registros de Ceibal, el equipo pasa de estar \textit{entregado}, a estar \textit{devuelto}  o  \textit{pendiente de devolución}.

En la Figura \ref{graf:FF} se muestran las frecuencias de las fechas de muerte o censura, es decir las fechas de finalización del episodio, a través de un histograma. Para éste y los próximos histogramas que se presentan en el trabajo, se utiliza el método de selección de ancho de banda de Freedman-Diaconis. (Ver Anexo \ref{ane:F-D}).
Se observa que la mayor cantidad de tablets que tienen sus fechas de finalización el mismo día se concentra en torno a junio de 2016.
\begin{figure}[hbpt]
<<echo=FALSE, fig.height=2.9, fig.align="center", warning=FALSE, message=FALSE, cache=TRUE>>=
ggplot(data = PrimeraVida, aes(x = FechaFinal, fill = fct_infreq(IndDef))) +
  geom_histogram(binwidth = function(x) 2 * IQR(x) / (length(x)^(1/3)), alpha=0.6) +
  scale_fill_brewer(palette = "Dark2", name = "Estado final") +
  labs(x = "Fecha de finalización del episodio", y = "Cantidad de tablets")
@
\caption[Fechas de finalización de la primera vida de las tablets según estado final.]{Histograma con las fechas de finalización de la primera vida de las \Sexpr{nrow(PrimeraVida)} tablets del análisis, con un ancho de banda de Freedman-Diaconis. En color verde se representa la fecha final de las \Sexpr{nrow(PrimeraVida[PrimeraVida$IndDef == "Defunción",])} tablets que presentaron una defunción, y en color naranja la de las restantes \Sexpr{nrow(PrimeraVida[PrimeraVida$IndDef == "Censura",])} que fueron censuradas.\label{graf:FF}}
\end{figure}


\subsubsection{Tiempo de vida hasta la primera defunción o censura \label{subsec:Dura}}
Se define la variable \textit{duración} como el tiempo de vida del equipo, medido como la cantidad de días entre la fecha de entrega del mismo al alumno o la alumna y la fecha registrada como fecha de finalización ya sea por una defunción o no.

<<echo=FALSE, cache=TRUE>>=
#Cuantas se encuentran en el pico mas alto que aparece en la grafica del 2014?
algunas2014 <- PV2014[PV2014$Duracion > 500,]
algunas2014 <- algunas2014[algunas2014$Duracion < 700,]
@

Se presenta en la Figura \ref{graf:Dura} la distribución de la duración de todas las tablets entregadas en 2014 y 2015. El gráfico superior presenta la duración de las \Sexpr{dim(PV2014)[1]} tablets entregadas en 2014 que van desde \Sexpr{round(min(PV2014$Duracion))} día hasta  \Sexpr{round(max(PV2014$Duracion))} días. La mitad de estas tablets tienen una duración de \Sexpr{round(median(PV2014$Duracion))} días, en promedio duran \Sexpr{round(mean(PV2014$Duracion))} días y el \Sexpr{round((dim(algunas2014)[1]/dim(PV2014)[1])*100,1)}\%  tienen una duración entre 500 y 700 días, correspondiendo estas al segundo modo que se observa en dicho gráfico que alcanza los valores más altos. El gráfico inferior presenta las duraciones de las \Sexpr{dim(PV2015)[1]} tablets entregadas en 2015 que van desde \Sexpr{round(min(PV2015$Duracion))} día hasta \Sexpr{round(max(PV2015$Duracion))} días. La mitad de estas tablets tienen una duración aproximada de 10 meses (\Sexpr{round(median(PV2015$Duracion))} días) y en promedio duran \Sexpr{round(mean(PV2015$Duracion))} días. Comparando ambos histogramas, en los dos se distinguen tres modos bien diferentes, pero el correspondiente a la generación del 2014 es más asimétrica a la derecha observándose menor cantidad de duraciones mayores.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3, fig.width=4, fig.align="center", cache=FALSE, cache=TRUE>>=
ggplot(PrimeraVida, aes(x = Duracion)) +
  facet_wrap(~ AnioVenta,  nrow = 2) +
  geom_histogram(binwidth = function(x) 2 * IQR(x) / (length(x)^(1/3)), fill = "aquamarine4") +
  scale_fill_brewer(palette = "Dark2") +
  labs(y = "Cantidad de tablets", x = "Duración (días)")
@
\caption[Duración de la primera vida de las tablets por año de entrega.]{Panel superior: histograma con los tiempos de vida de las \Sexpr{nrow(PrimeraVida[PrimeraVida$AnioVenta == "2014",])} tablets entregadas en 2014 agrupadas en intervalos de \Sexpr{round(2*IQR(PV2014$Duracion)/(length(PV2014$Duracion)^(1/3)))} días según el método de Freedman-Diaconis. Panel inferior: histograma con los tiempos de vida de las \Sexpr{nrow(PrimeraVida[PrimeraVida$AnioVenta == "2015",])} tablets entregadas en 2015 agrupadas en intervalos de \Sexpr{round(2*IQR(PV2015$Duracion)/(length(PV2015$Duracion)^(1/3)))} días según el método de Freedman-Diaconis. \label{graf:Dura}}
\end{figure}



En la figura \ref{graf:Dura_Def} se refleja también la distribución de la variable duración del total de las tablets pero según si la tablet fue censurada o presentó una defunción, para cada año de entrega de los equipos.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=2.8, fig.width=4, fig.align="center", cache=TRUE>>=
ggplot(PrimeraVida, aes(x = Duracion, fill = fct_infreq(IndDef))) +
  facet_grid(AnioVenta ~ IndDef) +
  geom_histogram(binwidth = function(x) 2 * IQR(x) / (length(x)^(1/3))) +
  scale_fill_brewer(palette = "Dark2") +
  xlab("Duración (días)") + ylab ("Cantidad de tablets")  +
  theme(legend.position = "none")
@
\caption[Duración de la primera vida de las tablets por año de entrega según estado final.]{Histograma con los tiempos de vida de las tablets según año y estado final. En color verde se representa el tiempo de vida de las \Sexpr{nrow(PrimeraVida[PrimeraVida$IndDef == "Defunción",])} tablets que presentaron una defunción, y en color naranja el tiempo de las \Sexpr{nrow(PrimeraVida[PrimeraVida$IndDef == "Censura",])} tablets que fueron censuradas. A su vez se diferencia entre la generación del 2014 (paneles superiores) y la del 2015 (paneles inferiores). Los correspondinetes anchos de banda de Freedman-Diaconis son igual a \Sexpr{round(2 * IQR(PV2014$Duracion[PV2014$IndDef == "Censura"]) / (length(PV2014$Duracion[PV2014$IndDef == "Censura"]))^(1/3))} y \Sexpr{round(2 * IQR(PV2014$Duracion[PV2014$IndDef == "Defunción"]) / (length(PV2014$Duracion[PV2014$IndDef == "Defunción"]))^(1/3))} para las censuras y defunciones del 2014 respectivamente, e igual a \Sexpr{round(2 * IQR(PV2015$Duracion[PV2015$IndDef == "Censura"]) / (length(PV2015$Duracion[PV2015$IndDef == "Censura"]))^(1/3))} y \Sexpr{round(2 * IQR(PV2015$Duracion[PV2015$IndDef == "Defunción"]) / (length(PV2015$Duracion[PV2015$IndDef == "Defunción"]))^(1/3))} para las censuras y defunciones del 2015. \label{graf:Dura_Def}}
\end{figure}

Cabe aclarar para ambos gráficos que, en 2017, a todos y todas las estudiantes se le recambian las tablets por nuevos equipos, por lo que el período de exposición es menor para las que se entregaron en 2015 que para las que se entregaron en 2014, justificando así la mayor duración antes mencionada que se aprecia para los de este último año, principalmente en el panel correspondiente a las censuras.

Se observa que las duraciones tienen comportamientos diferentes según el año de entrega y según si el evento termina con una defunción o con una censura. En cuanto a las censuras, podría deberse al proceso de recambio que determina Ceibal, que puede cambiar de un año a otro ya que es difícil recambiar todas las tablets del país en un mismo día, entonces se hace durante un proceso de varios meses como se ha mencionado.

Si se observan los dos gráficos conjuntamente se puede concluir que para el caso de la generación de 2014, el primer modo que se observaba en la Figura \ref{graf:Dura} corresponde a defunciones y los otros dos a censuras; mientras que para la generación del 2015 el primer modo corresponde a defunciones, el segundo es una mezcla de defunciones y censuras y el tercero representa prácticamente solo censuras. Hay una buena concordancia entre un gráfico y otro.

\subsubsection{Causas de defunción \label{subsec:Causas}}
Según la información brindada por Plan Ceibal hay en principio cuatro repuestos que implicarían la defunción del equipo, estos son: placa madre, pantalla, touchscreen y módulo completo. Con este último se está considerando la pantalla y el touchscreen cómo una pieza única. Por otro lado, la carcasa, la cámara, los parlantes, la antena, los botones, el micrófono, el cargador y los cables USB-micro USB, son repuestos que no impiden que el equipo siga funcionando por lo que no se consideran como causas de defunción.

En los registros respectivos a las OT, se encuentra además del consumo de estos repuestos, otros pertenecientes a otros tipos o modelos de dispositivos distintos a la tablet en estudio. Se suponen como errores de tipeo de los técnicos y se consideran también como repuestos que impliquen la defunción del equipo, agrupándolos en las cuatro causas iniciales\footnote{Se programan como un factor  con cuatro niveles, donde la placa madre tiene el valor 1, la pantalla el 10, el touchscreen el 100 y el 1000 corresponde al módulo completo}.

Es necesario definir que cuando los equipos presentan más de una causa de defunción en el mismo registro (día), también se agrupan considerándose como una sola categoría, tal como se muestra en las primeras dos columnas de la Tabla \ref{tab:Causas} en la que se exponen estas causas agrupadas y las cantidades que hubo de cada una de ellas.

A su vez se vuelven a agrupar estas categorías computando la causa según un orden de prelación. El orden es el siguiente: 1.Placa Madre; 2.Módulo completo; 3.Otros repuestos; a excepción de cuando se utiliza para reparar la tablet, el módulo en conjunto con la placa, considerando esta categoría como otra causa de defunción diferente. Además los repuestos que implicaron reparar la pantalla y el touchscreen se computan a la causa módulo completo ya que son pocas cantidades. En la columna \textit{Causas agrupadas} de la Tabla \ref{tab:Causas} se refleja la categorización  anteriormente explicada.

<<echo=FALSE, cache=TRUE>>=
#Para analizar las causas de defunción se trabaja con "defun"
t3 = addmargins(table(defun$Causa, useNA = "ifany"))

defun$Causa_rec[defun$Causa %in% c(1,2,11,101)] <- "Placa"
defun$Causa_rec[defun$Causa %in% c(10, 100,1000,2000)] <- "Modulo"
defun$Causa_rec[defun$Causa %in% c(1001,1002,2002)] <- "Modulo + Placa"
defun$Causa_rec[defun$Causa == 555] <- "Sust"

defun$Causa_rec <- as.factor(defun$Causa_rec)

t4 = addmargins(table(defun$Causa_rec, defun$AnioVenta, useNA="ifany"))
@


\begin{table}[hbpt]
	\begin{scriptsize}
		\begin{center}
			\caption{Categorías de la variable que contiene las causas de defunción.}
			\label{tab:Causas}
			\begin{tabular}{|c|c|c|}
				\hline
				Cantidad  & Causa  & Causa agrupada\\
				\hline
				34135 & Placa Madre & Placa \\
				9134 & Módulo Completo & Módulo\\
				6420 & Módulo Completo + Placa Madre & Módulo + Placa\\
				51 & Placa Madre + Placa Madre & Placa \\
				39 & Pantalla & Módulo \\
				19 & Módulo Completo + Módulo Completo & Módulo\\
				5 & Touchscreen + Placa Madre & Placa\\
				5 & Módulo Completo + Pantalla & Módulo\\
				5 & Módulo Completo + Módulo Completo + Placa Madre + Placa Madre & Módulo + Placa \\
				4 & Pantalla + Placa Madre & Placa\\
				2 & Touchscreen & Módulo\\
				2 & Módulo Completo + Placa Madre + Placa Madre & Módulo + Placa\\
				\hline
			\end{tabular}
		\end{center}
	\end{scriptsize}
\end{table}

Las sustituciones de equipos se categorizan en una nueva causa de defunción nombrada \textit{sustitución}. Dado que no se cuenta con la información de una reparación individual  que indique una causa específica, pero si se sabe que esos equipos fueron analizados y reparados por lotes que implicaban consumos principalmente del conector (placa madre), se asume por parte del área de datos de Ceibal, que dichas tablets estaban muertas al momento de la sustitución. Hubieron \Sexpr{dim(defun[defun$Causa_rec == "Sust",])[1]} sustituciones realizadas considerando la generación del 2014 y la del 2015 conjuntamente.


\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3.5, fig.width=5, fig.align="center", cache=TRUE>>=
defun %>%
  group_by(AnioVenta, Causa_rec) %>%
  summarise(n = n()) %>%
  mutate(percent = n/sum(n, na.rm=TRUE)*100) %>%

  ggplot(aes(x = fct_reorder(Causa_rec, -percent), y = percent, fill = Causa_rec)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Causas de defunción", y = "Porcentaje de tablets") +
  geom_text(aes(x = Causa_rec, label = paste(round(percent),"%"), y = percent, vjust = -0.5)) +
  facet_wrap(~ AnioVenta) +
  ylim(0,80) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))
@
	\caption[Causas de defunción de la primera vida de las tablets según año de entrega.]{Gráfico de barras con el porcentaje de tablets que presentan en su primera vida sustituciones, reparaciones de placa, reparaciones del módulo completo (pantalla + touchscreen) y reparaciones de la placa y el módulo conjuntamente. Se distingue en los paneles entre la generación del 2014 (\Sexpr{nrow(PrimeraVida[PrimeraVida$AnioVenta == "2014",])} tablets) y la del 2015 (\Sexpr{nrow(PrimeraVida[PrimeraVida$AnioVenta == "2015",])} tablets). \label{graf:Causas}}
\end{figure}

Al analizar los registros de repuestos utilizados y sustituciones realizadas en la primera vida de las tablets, se destaca que la principal causa de defunción es la rotura de la placa madre, siendo la que explica el \Sexpr{round((t4["Placa", "2014"]/t4["Sum","2014"])*100,1)}\% de las defunciones para las entregadas en 2014 y el \Sexpr{round((t4["Placa", "2015"]/t4["Sum","2015"])*100,1)}\% para las entregadas en 2015, lo cual se muestra en la Figura \ref{graf:Causas}. Si se consideraran las tablets a las que se les reparó la placa conjuntamente con el módulo, ese porcentaje sería aún mayor.

<<echo=FALSE, cache=TRUE>>=
#Se utiliza la subbase con las que murieron (defun)
Media_Causa <- data.frame(tapply(defun$Duracion, defun$Causa_rec, mean, na.rm = TRUE))
Media_Causa$Causa <- rownames(Media_Causa)
colnames(Media_Causa) <- c("Duracion_Media_Mediana", "Causa")
Media_Causa$Medida <- "Duración Media"

Mediana_Causa <- data.frame(tapply(defun$Duracion, defun$Causa_rec, median, na.rm = TRUE))
Mediana_Causa$Causa <- rownames(Mediana_Causa)
colnames(Mediana_Causa) <- c("Duracion_Media_Mediana", "Causa")
Mediana_Causa$Medida <- "Duración Mediana"

SegunCausa <- rbind(Media_Causa, Mediana_Causa)
@

En la Figura \ref{graf:DuraMedi} se presentan la duración media y mediana por cada causa de defunción. Sin contar las sustituciones, las que duraron menos en promedio fueron aquellas tablets a las que se les reparó el módulo completo, y las que tuvieron una duración media y una duración mediana mayores, fueron las tablets cuya reparación fue del módulo completo conjuntamente con la placa madre. Las tablets cuya causa de defunción fue la placa madre tienen una mayor duración media respecto a las tablets cuya causa de defunción fue el módulo, pero una menor duración mediana.
\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3, fig.width=4, fig.align="center", cache=TRUE>>=
ggplot(SegunCausa, aes(x = reorder(Causa, Duracion_Media_Mediana), y = Duracion_Media_Mediana, color = Medida)) +
  geom_point(size = 3) +
  coord_flip() +
  scale_color_brewer(palette = "Dark2", name = "") +
  labs(x = "Causas de defunción", y = "Días") +
  theme(legend.position = "bottom")
@
\caption[Duración media y mediana de la primera vida de las tablets por causa de defunción.]{Gráfico de puntos que muestra la duración media (color naranja) y la duración mediana (color verde) en días, de las \Sexpr{nrow(PrimeraVida[PrimeraVida$IndDef == "Defunción",])} tablets que presentaron una defunción. Se muestra por separado para las \Sexpr{nrow(defun[defun$Causa_rec == "Sust",])} tablets que presentaron una sustitución, las \Sexpr{nrow(defun[defun$Causa_rec == "Placa",])} a las cuales se les reparó la placa, las \Sexpr{nrow(defun[defun$Causa_rec == "Modulo",])} a las cuales se les reparó el módulo  y las \Sexpr{nrow(defun[defun$Causa_rec == "Modulo + Placa",])} que se les reparó el módulo y la placa conjuntamente. \label{graf:DuraMedi}}
\end{figure}

\subsubsection{Variables sociodemográficas a considerar: sexo, área geográfica y contexto sociocultural \label{subsec:VarSocio}}
Una de las variables que se considera que podría influir en la tasa de rotura de las tablets es el sexo del alumnado, otra es el contexto sociodemográfico de las escuelas a las que ellos concurren. Dicho indicador es determinado por \citep{anep} y se construye dividiendo el total de escuelas públicas en cinco grupos, de modo que el quintil 1 agrupa al 20\% de las escuelas con mayor nivel de criticidad (contexto más vulnerable) y así sucesivamente hasta el quintil 5 que está conformado por el 20\% de las escuelas con indicadores socioculturales más favorables. Esta clasificación se hace por separado para el conjunto de escuelas urbanas por un lado, y para las escuelas rurales por otro. En este trabajo, los quintiles rurales se agrupan con los urbanos ya que son de dimensiones (cantidad de escuelas en valores absolutos en cada uno de los quintiles) mucho menores a los urbanos.
Otra variable que se considera en el análisis es la ubicación geográfica del alumno o alumna identificando si la escuela a la que asiste está ubicada en la capital del país, en el interior urbano o en el ámbito rural.

En la Figura \ref{graf:VarSocio} se presenta la distribución de estas tres variables sociodemográficas que dan cuenta de la composición del alumnado a quienes se les entregaron las tablets en 2014 y 2015.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=4, fig.width=5, fig.align="center", cache=TRUE>>=
sex <- ggplot(data = PrimeraVida) +
  geom_bar(aes(x = Sexo, fill = Sexo, y = (..count..)/sum(..count..))) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Dark2") +
  # geom_text(aes(x = Sexo, label = scales::percent((..count..)/sum(..count..)), y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5) +
  labs(x = "Sexo", y = "Porcentaje de tablets") +
  theme(axis.ticks.x = element_blank(), legend.position = "none")

are <- ggplot(data = PrimeraVida) +
  geom_bar(aes(x = fct_infreq(Area), fill = Area, y = (..count..)/sum(..count..))) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Dark2") +
  # geom_text(aes(x = Area, label = scales::percent((..count..)/sum(..count..)), y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5) +
  labs(x = "Área geográfica", y = "Porcentaje de tablets") +
  theme(axis.ticks.x = element_blank(), legend.position = "none")

con <- ggplot(data = PrimeraVida) +
  geom_bar(aes(x = Contexto, fill = Contexto, y = (..count..)/sum(..count..))) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Dark2") +
  # geom_text(aes(x = Contexto, label = scales::percent((..count..)/sum(..count..)), y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5) +
  labs(x = "Contexto sociocultural", y = "Porcentaje de tablets") +
  theme(axis.ticks.x = element_blank(),legend.position = "none")

grid.arrange(arrangeGrob(sex, are, ncol = 2), con, nrow = 2)
@
\caption[Distribución de variables sociodemográficas: sexo, área geográfica y contexto sociocultural.]{Gráficos de barras con los porcentajes de cada categoría de cada una de las variables sociodemográficas consideradas: sexo del alumno o alumna, área geográfica y contexto sociocultural al que pertenece la escuela a la que concurre el alumno o la alumna a quien se le entregó una tablet del modelo en estudio en 2014 y 2015. \label{graf:VarSocio}}
\end{figure}

En las tres secciones siguientes se analiza como pueden influenciar estas variables sociodemográficas en la proporción de defunciones, en la duración de la primera vida y en las causas de defunción de la misma, tratando de evidenciar si hay o no diferencias entre un perfil y otro.


\subsubsection{Defunciones y censuras según las variables sociodemográficas \label{subsec:Def_VarSocio}}
En la Figura \ref{graf:Def_VarSocio} se compara la distribución de las alumnas y los alumnos que registraron fallas en sus equipos con aquellos que no, según el área geográfica, contexto sociocultural y sexo del mismo/a, sin distinguir una generación de otra ya que la distribución dentro de cada año para cada una de las variables es muy similar para sus respectivas categorías.

Presentan mayor cantidad de defunciones aquellas tablets pertenecientes a alumnos de sexo masculino, de escuelas de contexto sociocultural medio y usuarios que concurren a centros educativos del interior, en particular interior urbano, sin embargo se observa que las diferencias respecto a la cantidad de defunciones entre una categoría y otra de cada una de estas tres variables, no son sustanciales.


\begin{figure}[hbpt]
<<echo=FALSE, fig.height=4, fig.align="center", cache=TRUE>>=
sex2 <- ggplot(data = PrimeraVida) +
  geom_mosaic(aes(x = product(Sexo), fill = fct_infreq(IndDef))) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Sexo", y = "") +
  theme(legend.position = "none")

are2 <- ggplot(data = PrimeraVida) +
  geom_mosaic(aes(x = product(Area), fill = fct_infreq(IndDef))) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Área geográfica", y = "") +
  theme(legend.position = "none")
#, axis.text.x  =   element_text(angle = 35)

con2 <- ggplot(data = PrimeraVida) +
  geom_mosaic( aes(x = product(Contexto), fill = fct_infreq(IndDef))) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Contexto sociocultural", y = "") +
  theme(legend.position = "none")

grid.arrange(arrangeGrob(sex2,are2, ncol = 2), con2, nrow = 2)
@
	\caption[Estado final de la primera vida de las tablets según variables sociodemográficas.]{Gráficos de mosaicos con la proporción de defunciones o censuras (estado final) de la primera vida de las \Sexpr{nrow(PrimeraVida)} tablets, para las diferentes categorías de la variable sexo (panel superior izquierdo), área geográfica (panel superior derecho) y contexto sociocultural (panel inferior). \label{graf:Def_VarSocio}}
\end{figure}

<<echo=FALSE, cache=TRUE>>=
t5 = addmargins(table(PrimeraVida$Sexo, PrimeraVida$IndDef))

t6 = addmargins(table(PrimeraVida$Area, PrimeraVida$IndDef))

t7 = addmargins(table(PrimeraVida$Contexto, PrimeraVida$IndDef))
@

Al comparar la mortalidad del total de tablets entregadas según el sexo del alumno o la alumna, mueren el \Sexpr{round((t5["Masculino", "Defunción"]/t5["Masculino", "Sum"])*100,1)}\% de las entregadas a los niños y el  \Sexpr{round((t5["Femenino", "Defunción"]/t5["Femenino", "Sum"])*100,1)}\% de las entregadas a las niñas.

Al comparar la mortalidad según la región geográfica a la que pertenece la escuela, las tablets de escuelas del Interior Urbano son las que presentaron mayor porcentaje de defunciones (\Sexpr{round((t6["I.Urbano", "Defunción"]/t6["I.Urbano", "Sum"])*100,1)}\%) en relación al total de tablets entregadas a dicha área geográfica.

Al comparar la mortalidad según el contexto sociocultural, la cantidad de defunciones ronda entre el 60\% y el 70\% para todos los contextos, siendo aquellas tablets de escuelas pertenecientes al contexto clasificado como \textit{quintil 3}, con un nivel medio de criticidad, las que presentan mayor cantidad de defunciones (\Sexpr{round((t7["Quintil 3", "Defunción"]/t7["Quintil 3", "Sum"])*100,1)}\%) y las del contexto menos crítico clasificado como \textit{quintil 5}, las que presentaron menor cantidad (\Sexpr{round((t7["Quintil 5", "Defunción"]/t7["Quintil 5", "Sum"])*100,1)}\%) respecto al total entregado.

\subsubsection{Tiempo de vida hasta la primera defunción según las variables sociodemográficas \label{subsec:Dura_VarSocio}}
Se analiza la duración de las tablets que presentaron una primera defunción según las tres variables sociodemográficas consideradas, a través de gráficos de  los cuales se presentan en el Anexo \ref{ane:densi}. No se aprecian prácticamente diferencias entre las categorías de cada variable.

\subsubsection{Causas de defunción según variables sociodemográficas \label{subsec:Causas_VarSocio}}
Para ver si hay algún perfil sociodemográfico del alumnado que determine alguna causa de defunción en particular, se grafican en la Figura \ref{graf:Causas_VarSocio} tres mosaicos en los que se muestra la proporción de tablets que presentan cada una de las causas de defunción definidas, según el sexo, el área geográfica y el contexto sociocultural de las alumnas y alumnos.
Al igual que en el análisis conjunto (sin distinción por variables), para todas las categorías, la mayor proporción de defunciones la presentan aquellas tablets a las que se les repara la placa madre. Analizando el contexto, dicha proporción aumenta en forma gradual desde el quintil 1 al quintil 5. En la variable sexo, para ambas categorías, todas las causas de defunción tienen la misma proporción.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=4, fig.width=6, fig.align="center", cache=TRUE>>=
sex4 <- ggplot(data = defun) +
geom_mosaic(aes(x = product(Sexo), fill = fct_infreq(Causa_rec))) +
  scale_fill_brewer(palette = "Dark2")  +
  theme( legend.position = "none") +
  labs(y = "Causas de defunción", x = "Sexo")

are4 <- ggplot(data = defun) +
geom_mosaic(aes(x = product(Area), fill = fct_infreq(Causa_rec))) +
  scale_fill_brewer(palette = "Dark2")  +
  theme( legend.position = "none") +
  labs(y = "Causas de defunción", x = "Área geográfica")

con4 <- ggplot(data = defun) +
geom_mosaic(aes(x = product(Contexto), fill = fct_infreq(Causa_rec))) +
  scale_fill_brewer(palette = "Dark2")  +
  theme( legend.position = "none") +
  labs(y = "Causas de defunción", x = "Contexto sociocultural")

con4 + (sex4 + are4) + plot_layout(ncol=1)
@
\caption[Causas de defunción de la primera vida de las tablets según variables sociodemográficas]{Gráficos de mosaico con la proporción las primeras causas de defunción de las \Sexpr{nrow(defun)} tablets que registraron un evento en su primera vida, según las variables sociodemográficas consideradas en el estudio: sexo (panel inferior izquierdo), área geográfica (panel inferior derecho) y contexto sociocultural (panel superior).
	\label{graf:Causas_VarSocio}}
\end{figure}


\subsubsection{Otras variables a considerar: Visitas a servicio técnico y cantidad de repuestos consumidos \label{subsec:VarTecni}}
Además de considerar las covariables sociodemográficas de la sección anterior, se ha considerado como posible factor que influencia la duración del equipo, la cantidad de entradas a servicio técnico, reflejadas en un principio, por un lado en la cantidad de visitas a ST y por otro en la cantidad de fallas registrados durante su primera vida. La primera de ellas cuantifica la cantidad de veces (específicamente días) que el alumno o la alumna llevó a reparar su equipo con el ST de Ceibal. La segunda, cuantifica la cantidad de repuestos que la tablet consumió. La diferencia con la anterior es que en esta se cuenta por repuestos en vez de por fechas, ya que en un mismo día, en una misma OT, se pueden haber utilizado más de un repuesto para el mismo equipo.


<<echo=FALSE, cache=TRUE>>=
t8 = addmargins(table(PrimeraVida$Visitas, PrimeraVida$AnioVenta, useNA = "ifany"))
#Hay 17100 equipos en 2014 y 12427 que no fueron nunca a servicio técnico
#No está contada la entrada a servicio técnico por defunción, asi que habria que sumarle uno a todos

#Solo de los que muerieron (se trabaja con las subbase "defun")
t9 = addmargins(table(defun$ViAntes, defun$AnioVenta, useNA = "ifany"))
t10 = addmargins(table(defun$RepAntes, defun$AnioVenta, useNA = "ifany"))

@

Se analiza la distribución de dichas variables que cuantifican las entradas a servicio técnico y se destaca que el \Sexpr{round((t8["0","Sum"]/t8["Sum","Sum"])*100,1)}\% (\Sexpr{t8["0","Sum"]}) del total de las tablets no entran nunca a ST con una orden de trabajo del tipo reparación, es decir, que luego de que los equipos fueron entregados a los alumnos o las alumnas,  no se volvió a tener ningún registro de ellos hasta que fueron recambiados.
Considerando sólo las entradas de los equipos que presentaron una defunción, el \Sexpr{round((t9["0", "Sum"]/t9["Sum", "Sum"])*100,1)}\% de las tablets no tienen ninguna visita a ST, y por ende, repuestos consumidos, antes de la defunción; es decir, las primeras causas de rotura de estas tablets son causas que les impiden seguir con su funcionamiento. Las demás presentan hasta 3 visitas a ST y hasta 4 reparaciones antes de su defunción.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=2.7, cache=TRUE>>=
#Se saca el 3 que tiene solamente una observacion
vi <- defun %>%
  dplyr::filter(ViAntes != "3") %>%
ggplot(aes(x = Duracion, fill = ViAntes,  col = ViAntes)) +
  geom_density(alpha = 0.3) +
  scale_fill_brewer(palette = "Dark2", name = "") +
  scale_color_brewer(palette = "Dark2", name= "") +
  labs(title =  "Visitas", x = "Duración (días)", y = "Densidad") +
  theme(plot.title = element_text(hjust = 0.5))

rep <- ggplot(data = defun, aes(x = Duracion, fill = RepAntes, color = RepAntes)) +
  geom_density(alpha = 0.3) +
  ggtitle ("Repuestos") +
  scale_fill_brewer(palette = "Dark2", name = "") +
	scale_color_brewer(palette = "Dark2", name = "") +
  labs(x = "Duración (días)", y = "Densidad") +
  theme(plot.title = element_text(hjust = 0.5))

grid.arrange(vi, rep, ncol=2)
@
\caption[Duración de la primera vida de las tablets que presentaron defunciones según variables técnicas.]{Gráficos de densidad con el tiempo de vida de las \Sexpr{nrow(PrimeraVida[PrimeraVida$IndDef == "Defunción",])} tablets que registraron un evento en su primera vida, según la cantidad de visitas a servicio técnico antes de la defunción (panel izquierdo) y la cantidad de repuestos consumidos previo a la defunción (panel derecho). \label{graf:Dura_VarTecni}}
\end{figure}

Por último, en la Figura \ref{graf:Dura_VarTecni} se  muestra a través de gráficos de densidad la duración según la cantidad de visitas y según la cantidad de repuestos consumidos, ambas antes de la defunción. Se observa la diferencia de los que van 0 veces a ST previo a su defunción, que tienen una duración menor a la de los demás equipos. Sin embargo no se evidencian prácticamente diferencias en la distribución de la duración si van 1 o 2 veces a ST previo a morir.

Tras este análisis, se decide crear para efectivamente utilizar en los modelos de estimación, una variable dicotómica (llamada \emph{ST}) que vale 1 si el equipo entra a reparación antes de su defunción, por otro motivo que no implique la muerte, y 0 en otro caso.

\subsection{Segunda vida de las tablets \label{sec:SV}}
En esta sección se presentan los resultados del mismo análisis que se ha venido realizando para la primera vida pero para la segunda, de una forma resumida, comenzando con las dimensiones de la base y la proporción de defunciones, luego el tiempo de vida de los equipos y por último las causas de defunción.

De las \Sexpr{nrow(PrimeraVida[PrimeraVida$IndDef == "Defunción",])} tablets que murieron en su primera vida se consideran \Sexpr{nrow(SegundaVida)} que presentan una segunda vida. En el proceso de construcción de la base de la segunda vida de los equipos se dejan fuera 2013 observaciones correspondientes a tablets que fueron retiradas, reparadas por lote (implicando una muerte por lo que se consideró sustitución), pero no se volvieron a entregar a ningún otro alumno o alumna, pasando de \Sexpr{nrow(PrimeraVida[PrimeraVida$IndDef == "Defunción",])} observaciones a 51022. La diferencia con las restantes se debe a que se eliminaron observaciones con duraciones negativas y duraciones menores a un día.

<<echo=FALSE, cache=TRUE>>=
#Cuantas tablets se entregaron cada año?
t11 = addmargins(table(SegundaVida$AnioVenta))
@

De las \Sexpr{nrow(SegundaVida)} tablets, \Sexpr{t11["2014"]} pertenecen a la generación del 2014 y \Sexpr{t11["2015"]} a la del 2015.

\subsubsection{Defunciones y censuras \label{subsec:Def_SV}}
<<echo=FALSE, cache=TRUE>>=
t12 = addmargins(table(SegundaVida$IndDef2, useNA = "ifany"))

t13 = addmargins(table(SegundaVida$IndDef2, SegundaVida$AnioVenta, useNA = "ifany"))
@
De las \Sexpr{nrow(SegundaVida)} tablets que presentan una segunda vida, el \Sexpr{round((t12["Defunción"]/t12["Sum"])*100,1)}\% (\Sexpr{t12["Defunción"]} tablets) registraron una segunda defunción mientras que para las \Sexpr{round((t12["Censura"]/t12["Sum"])*100,1)}\% restantes (\Sexpr{t12["Censura"]} tablets) no se observó el evento antes de que fueran retiradas por Ceibal pasando a estar fuera del análisis, por lo que se consideran censuradas a la derecha.

Considerando las distintas generaciones, la mortalidad es del \Sexpr{round((t13["Defunción", "2014"]/t13["Sum", "2014"])*100,1)}\% (\Sexpr{t13["Defunción", "2014"]} tablets) para las tablets entregadas en 2014 y del \Sexpr{round((t13["Defunción", "2015"]/t13["Sum", "2015"])*100,1)}\% (\Sexpr{t13["Defunción", "2015"]} tablets) para las entregadas en 2015, como se observa en la Figura \ref{graf:Def SV}, donde se grafica un mosaico que muestra la proporción de equipos que presentaron defunciones o censuras en su segunda vida, según el año de entrega de los mismos.


\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3.5, fig.align="center", cache=TRUE>>=
ggplot(data = SegundaVida) +
  geom_mosaic(aes(x = product(AnioVenta), fill = fct_infreq(IndDef2))) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Año de entrega", y = "Estado final") +
  theme(aspect.ratio = 1, legend.position = "none")
@
\caption[Estado final de la segunda vida de las tablets según año de entrega.]{Gráfico de mosaico que muestra la proporción de tablets que presentaron defunciones o censuras (estado final) en la segunda vida según el año de entrega, para la generación de las \Sexpr{nrow(SegundaVida[SegundaVida$AnioVenta == "2014",])} tablets entregadas en 2014 y la generación de las \Sexpr{nrow(SegundaVida[SegundaVida$AnioVenta == "2015",])} entregadas en 2015.\label{graf:Def SV}}
\end{figure}

\subsubsection{Tiempo de vida de las tablets hasta su segunda defunción o censura \label{subsec:Dura_SV}}
Igual que como se había definido anteriormente, el tiempo de vida o duración corresponde a la diferencia entre la fecha de inicio y la fecha de finalización del episodio, ya sea por una defunción o por una censura.

Para los equipos que tuvieron  una primer defunción por sustitución, la fecha de inicio de la segunda vida es la fecha en que la tablet es entregada por segunda vez a otro alumno u otra alumna. Para el resto de los casos, la fecha en que comienza la segunda vida corresponde a la fecha en que se finalizó la OT correspondiente a la reparación del repuesto que implicó la primer defunción de ese equipo.

La fecha de finalización de los episodios corresponde a la fecha en que el equipo ingresó por segunda vez a servicio técnico o fue retirado para ser reparado por lote, para las defunciones por códigos de OT y defunciones por sustitución respectivamente. Para el caso de las censuras, la fecha de finalización de la segunda vida corresponde a la fecha en que el equipo pasa a estar registrado como devuelto o pendiente de devolución.

<<echo=FALSE, cache=TRUE>>=
#Se crean dos sub bases correspondientes a cada año de entrega que se utilizarán luego para los gráficos.
SV2014 <- SegundaVida[SegundaVida$AnioVenta == "2014",]
SV2015 <- SegundaVida[SegundaVida$AnioVenta == "2015",]
#Se crea una subbase en la que se encuentran solo las tablets que murieron que se utilizará luego para los gráficos.
defun2 <- SegundaVida[SegundaVida$IndDef2 == "Defunción",]
@
Se presenta en la Figura \ref{graf:Dura SV} a través de un histograma, la distribución de la duración de todas las tablets que presentaron una segunda vida. El panel superior presenta la duración de las \Sexpr{t11["2014"]} tablets entregadas en 2014, cuyos tiempos de vida van desde \Sexpr{round(min(SV2014$Duracion2))} día hasta \Sexpr{round(max(SV2014$Duracion2))} días. El panel inferior presenta las duraciones de las \Sexpr{t11["2015"]} tablets entregadas en 2015 que van desde \Sexpr{round(min(SV2015$Duracion2))} día hasta \Sexpr{round(max(SV2015$Duracion2))} días aproximadamente. Para ambos años de entrega, se observa como disminuye la cantidad de equipos a medida que se consideran duraciones mayores, siendo más notorio para las entregadas en 2015.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3, fig.width=4, fig.align="center", cache=TRUE>>=
ggplot(SegundaVida, aes(x = Duracion2)) +
  geom_histogram(binwidth = function(x) 2 * IQR(x) / (length(x)^(1/3)), fill = "sienna1") +
  facet_wrap(~ AnioVenta, nrow = 2) +
  labs(y = "Cantidad de tablets", x = "Duración (días)")
@
  \caption[Duración de la segunda vida de las tablets por año de entrega.]{Panel superior: Histograma con los tiempos de vida de las \Sexpr{nrow(SegundaVida[SegundaVida$AnioVenta == "2014",])} tablets que fueron entregadas en 2014 y tienen una segunda vida, agrupados en intervalos de \Sexpr{round(2*IQR(SegundaVida$Duracion[SegundaVida$AnioVenta == "2014"])/(length(SegundaVida$Duracion[SegundaVida$AnioVenta == "2014"])^(1/3)))} días según el método de Freedman-Diaconis.
Panel inferior: Histograma con los tiempos de vida de las \Sexpr{nrow(SegundaVida[SegundaVida$AnioVenta == "2015",])} tablets que fueron entregadas en 2015 y tienen una segunda vida, agrupados en intervalos de \Sexpr{round(2*IQR(SegundaVida$Duracion[SegundaVida$AnioVenta == "2015"])/(length(SegundaVida$Duracion[SegundaVida$AnioVenta == "2015"])^(1/3)))} días.\label{graf:Dura SV}}
\end{figure}

<<echo=FALSE, cache=TRUE>>=
#Para analizar las causas de defunción se trabaja con "defun2"
defun2$Causa2_rec[defun2$Causa2 %in% c(1,2,11)] <- "Placa"
defun2$Causa2_rec[defun2$Causa2 %in% c(10, 100, 1000,1010, 2000)] <- "Modulo"
defun2$Causa2_rec[defun2$Causa2 %in% c(1001,1002, 2002)] <- "Modulo + Placa"
defun2$Causa2_rec[defun2$Causa2 == 555] <- "Sust"

defun2$Causa2_rec <- as.factor(defun2$Causa2_rec)
#levels(defun2$Causa2_rec)
defun2$Causa2_rec = droplevels(defun2$Causa2_rec)

t14 = addmargins(table(defun2$Causa2_rec, defun2$AnioVenta, useNA = "ifany"))
@

\subsubsection{Causas de defunción \label{subsec:Causas_SV}}
Al igual que en la primera vida, el equipo puede presentar una defunción por diferentes motivos (o causas); porque se le haya roto la placa, el módulo (incluyendo la pantalla y el touchscreen) o la placa y el módulo a la vez, o porque haya sido sustituido por otro equipo para ser reparado por lote. En la Figura \ref{graf:Causas SV} se muestra la distribución de estas causas de defunción expresada en términos de porcentajes. Considerando todas las tablets que tienen una segunda vida y vuelven a presentar una defunción, se destaca que la principal causa es nuevamente la rotura de la placa madre, siendo la que explica el \Sexpr{round((t14["Placa", "2014"]/t14["Sum","2014"])*100,1)}\% de las defunciones para las entregadas en 2014 y el \Sexpr{round((t14["Placa", "2015"]/t14["Sum","2015"])*100,1)}\% para las entregadas en 2015 tal como se muestra en la figura.


\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3.5, fig.width=5, fig.align="center", cache=TRUE>>=
defun2 %>%
  group_by(AnioVenta, Causa2_rec) %>%
  summarise(n = n()) %>%
  mutate(percent = n / sum(n, na.rm = TRUE) * 100) %>%
ggplot(aes(x = fct_reorder(Causa2_rec, -percent), y = percent, fill = Causa2_rec)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Causas de defunción", y = "Porcentaje de tablets") +
  geom_text(aes(x = Causa2_rec, label = paste(round(percent),"%"), y = percent, vjust = -0.5)) +
  facet_wrap(~ AnioVenta) +
  ylim(0,80) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))
@
\caption[Causas de defunción de la segunda vida de las tablets según año de entrega.]{Gráfico de barras del porcentaje de tablets que presentan en su segunda vida sustituciones, reparaciones de placa, reparaciones del módulo y reparaciones de placa y módulo conjuntamente según año de entrega del equipo, para la generación del 2014 (\Sexpr{nrow(SegundaVida[SegundaVida$AnioVenta == "2014",])} tablets) y la del 2015 (\Sexpr{nrow(SegundaVida[SegundaVida$AnioVenta == "2015",])} tablets). \label{graf:Causas SV}}
\end{figure}


\subsection{Comparación entre la primera y segunda vida de las tablets \label{sec:PVySV}}
En la presente sección se realiza una comparación entre la primera y segunda vida de las tablets, para observar si hay o no diferencias entre sus causas de defunción y entre sus tiempos de vida, analizando algunas medidas de resumen e indicadores.

En primer lugar se muestra en la Figura \ref{graf:def_PVSV} un mosaico en el que se presenta la proporción de defunciones y censuras para la primera y segunda vida. Como se ha mencionado, los mosaicos tienen en cuenta la cantidad de observaciones en cada subconjunto a comparar, por eso el azulejo correspondiente a la primera vida es más ancho. Se observa además que la proporción de defunciones es mayor en la primera vida que en la segunda.

<<echo=FALSE, cache=TRUE>>=
PVmod <- PrimeraVida[, c(1, 8)]
PVmod$vida <- "Primera vida"
SVmod <- SegundaVida[, c(1, 6)]
SVmod$IndDef <- SegundaVida$IndDef2
SVmod$IndDef2 <- NULL
SVmod$vida <- "Segunda vida"
Todas <- rbind(PVmod, SVmod)
@


\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3.5, fig.align="center", cache=TRUE>>=
ggplot(data = Todas) +
  geom_mosaic(aes(x = product(vida), fill = fct_infreq(IndDef))) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "", y = "Estado final") +
  theme(aspect.ratio = 1, legend.position = "none")
@
\caption[Comparación del estado final de la primera y la segunda vida de las tablets.]{Gráfico de mosaico que muestra la proporción de tablets que presentan defunciones o son censuradas (estado final) para las \Sexpr{nrow(PrimeraVida)} tablets de la primera vida  y para las \Sexpr{nrow(SegundaVida)} tablets de la segunda vida por separado. \label{graf:def_PVSV}}
\end{figure}

<<echo=FALSE, cache=TRUE>>=
Tres <- defun[defun$Duracion <= 90,]
Tres$Intervalo <- "0-3"; Tres$vida <- "Primera Vida"
Tres2 <- defun2[defun2$Duracion2 <= 90,]
Tres2$Intervalo <- "0-3"; Tres2$vida <- "Segunda Vida"
Seis <- defun[defun$Duracion > 90 & defun$Duracion <= 180,]
Seis$Intervalo <- "3-6"; Seis$vida <- "Primera Vida"
Seis2 <- defun2[defun2$Duracion2 > 90 & defun2$Duracion2 <= 180,]
Seis2$Intervalo <- "3-6"; Seis2$vida <- "Segunda Vida"
Doce <- defun[defun$Duracion > 180 & defun$Duracion <= 365,]
Doce$Intervalo <- "6-12"; Doce$vida <- "Primera Vida"
Doce2<- defun2[defun2$Duracion2 > 180 & defun2$Duracion2 <= 365,]
Doce2$Intervalo <- "6-12"; Doce2$vida <- "Segunda Vida"
DosA <- defun[defun$Duracion > 365 & defun$Duracion <= 730 ,]
DosA$Intervalo <- "12-24"; DosA$vida <- "Primera Vida"
DosA2<- defun2[defun2$Duracion2 > 365 & defun2$Duracion2 <= 730,]
DosA2$Intervalo <- "12-24"; DosA2$vida <- "Segunda Vida"
MasDosA<- defun[defun$Duracion > 730,]
MasDosA$Intervalo <- "+24"; MasDosA$vida <- "Primera Vida"
MasDosA2<- defun2[defun2$Duracion2 > 730,]
MasDosA2$Intervalo <- "+24"; MasDosA2$vida <- "Segunda Vida"

Tres <- Tres[,c("Serie", "Intervalo", "vida")]
Seis <- Seis[,c("Serie", "Intervalo", "vida")]
Doce <- Doce[,c("Serie", "Intervalo", "vida")]
DosA <- DosA[,c("Serie", "Intervalo", "vida")]
MasDosA <- MasDosA[,c("Serie", "Intervalo", "vida")]
Tres2 <- Tres2[,c("Serie", "Intervalo", "vida")]
Seis2 <- Seis2[,c("Serie", "Intervalo", "vida")]
Doce2 <- Doce2[,c("Serie", "Intervalo", "vida")]
DosA2 <- DosA2[,c("Serie", "Intervalo", "vida")]
MasDosA2 <- MasDosA2[,c("Serie", "Intervalo", "vida")]

ParaGrafico <- rbind(Tres, Seis, Doce, DosA, MasDosA, Tres2, Seis2, Doce2, DosA2, MasDosA2)
ParaGrafico$Intervalo <- as.factor(ParaGrafico$Intervalo)
ParaGrafico$Intervalo  <- factor(ParaGrafico$Intervalo, levels = levels( ParaGrafico$Intervalo )[ c( 2,4,5,3,1) ])

t15 = table(ParaGrafico$Intervalo, ParaGrafico$vida)
@

Luego en la Figura \ref{graf:Interv} se muestra un gráfico de barras que indica para cada una de las vidas (primera y segunda) cuántas de las tablets que presentaron defunciones lo hicieron en distintos intervalos de tiempo. En los intervalos se dividen las tablets que murieron en los primeros tres meses, entre los tres y seis meses, entre los seis meses y el año, entre uno y dos años y luego de los dos años. Observando el gráfico correspondiente a la primera vida, la mayor cantidad de defunciones suceden en el intervalo de tiempo entre 6 meses y 1 año (\Sexpr{nrow(Doce)} tablets). Para la segunda vida sin embargo, las defunciones suceden mayormente en los primeros tres meses (\Sexpr{nrow(Tres2)}).

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3, fig.width=5, fig.align="center", cache=TRUE>>=
ggplot(ParaGrafico, aes(x = vida, fill = Intervalo)) +
  geom_bar(position = "dodge") +
  scale_fill_brewer(palette = "Dark2", name = "Meses") +
  labs(y = "Cantidad", x = "" ) +
  theme(legend.position = "bottom")
@
\caption[Comparación de la proporción de defunciones en distintos intervalos de tiempo de la primera y segunda vida de las tablets.]{Gráficos de barras que muestra, para cada una de las vidas (primera y segunda) de las tablets, la cantidad de equipos que presentan una defunción en distintos intervalos de tiempo. (Entre 0 y 3 meses, entre 3 y 6 meses, entre 6 meses y un año, entre 1 y 2 años, en más de 2 años) \label{graf:Interv}}
\end{figure}

Por último se presenta, en la Figura \ref{graf:PVySV}, la distribución de la duración de cada una de las vidas de las tablets (primera y segunda vida), según si fueron censuradas o presentaron una defunción. Se observan en el panel correspondiente a los tiempos de vida hasta la primera defunción, dos modos bien definidos mientras que para las defunciones de la segunda vida hay solo uno, concentrándose la mayoría de las muertes de los equipos en los primeros 200 días. Por otro lado, se puede apreciar en general que los tiempos de vida hasta las segundas defunciones son menores que los tiempos hasta las primeras defunciones.
<<echo=FALSE, cache=TRUE>>=
UnAnio_2014 <- PV2014[PV2014$Duracion >= 365,]
UnAnio_2015 <- PV2015[PV2015$Duracion >= 365,]
UnAnio2_2014 <- SV2014[SV2014$Duracion2 >= 365,]
UnAnio2_2015 <- SV2015[SV2015$Duracion2 >= 365,]
@
Sin embargo, en proporción, para la generación de tablets entregadas en 2014, el \Sexpr{round((nrow(UnAnio_2014)/nrow(PV2014))*100,1)}\% de las tablets de la primera vida y el \Sexpr{round((nrow(UnAnio2_2014)/nrow(SV2014))*100,1)}\% de las de la segunda vida, llegan al año de vida; mientras que para la generación del 2015, el \Sexpr{round((nrow(UnAnio_2015)/nrow(PV2015))*100,1)}\% de las de la primera y el \Sexpr{round((nrow(UnAnio2_2015)/nrow(SV2015))*100,1)}\% de las de la segunda vida lo hacen.


\begin{figure}[hbpt]
<<echo=FALSE, fig.height=4, fig.width=5, fig.align="center", cache=TRUE, warning=FALSE>>=
pv <- ggplot(PrimeraVida, aes(x = Duracion, fill = IndDef)) +
  geom_histogram(binwidth = function(x) 2 * IQR(x) / (length(x)^(1/3))) +
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap(~ IndDef, nrow = 1) + xlim(0,1182) + ylim(0,3000) +
  labs(y = "Cantidad", x = "Duración (días)", title = "Primera Vida") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5))

sv <- ggplot(SegundaVida, aes(x = Duracion2, fill = IndDef2)) +
  geom_histogram(binwidth = function(x) 2 * IQR(x) / (length(x)^(1/3))) +
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap(~ IndDef2, nrow = 1) + xlim(0,1182) + ylim(0,3000) +
  labs(y = "Cantidad", x = "Duración (días)", title = "Segunda Vida") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5))

grid.arrange(pv, sv)
@
\caption[Comparación de la duración de la primera y segunda vida según estado final de las tablets.]{Histogramas con los tiempos de vida de las tablets. Se diferencia entre la primera vida (paneles superiores) y la segunda vida (paneles inferiores). A su vez, en color verde se representa el tiempo de vida de las tablets que presentan una defunción, y en color naranja el tiempo de las que son censuradas en las respectivas vidas. \label{graf:PVySV}}
\end{figure}

<<echo=FALSE, cache=TRUE>>=
Todas <- merge(defun, defun2, by = "Serie")
Todas$Causa2_rec = droplevels(Todas$Causa2_rec)
t16 = addmargins(table(Todas$Causa_rec, Todas$Causa2_rec))
@

Se quiere indagar además si las causas de defunción de la primera y segunda vida son similares, por lo que se realiza un gráfico de mosaico en el que se muestra la probabilidad condicional de presentar una defunción por determnada causa en la segunda vida habiendo dejado de funcionar por esa misma u otra causa en la primera vida (Figura \ref{fig:CausasPVSV}). Como se ha mencionado, para la segunda vida sigue siendo la placa la principal causa de defunción (\Sexpr{round((t16["Sum", "Placa"]/t16["Sum", "Sum"])*100,1)}\%) de las cuales \Sexpr{round((t16["Placa", "Placa"]/t16["Sum", "Placa"])*100,1)}\% en su primera vida también habían muerto por habérseles roto dicha pieza.

<<echo=FALSE, cache=TRUE, results="asis", eval=FALSE>>=
tab3 = xtable(t16, align="ccccccccc", caption = " Distribución de las causas de defunción de los equipos, de la primera y segunda vida", label = "tab:CausasPVSV", display = c("s","d","d","d","d","d","d","d","d"))
print(tab3, caption.placement = "top", hline.after = c(-1,0,nrow(tab3)-1,nrow(tab3)))
@

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=4, fig.align="center", cache=FALSE>>=
ggplot(data = Todas) +
  geom_mosaic(aes(x = product(Causa2_rec), fill = fct_infreq(Causa_rec))) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Segunda vida", y = "Primera vida") +
  theme(aspect.ratio = 1,legend.position = "none",  axis.text.x = element_text(angle = 20))
@
\caption[Distribución de las causas de defunción de los equipos, de la primera y segunda vida]{Gráfico de mosaico con la distribución de la causas de defunción de la segunda vida condicional a las causas de defunción de la primera vida \label{fig:CausasPVSV}}}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% RESULTADOS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Resultados \label{sec:Res}}
En este capítulo se presenta el resultado de la estimación de la función de confiabilidad a través del método de Kaplan-Meier con su respectivo intervalo de confianza (Sección \ref{sec:KM}). Se presentan los resultados para la primera y segunda vida de las tablets por separado y luego una comparación de ellos utilizando los paquetes \texttt{survival} \citep{survival} y \texttt{survminer} \citep{survminer} del software estadístico \texttt{R}.

Luego, se presenta para la primera vida, la comparación y testeo de curvas de confiabilidad estimadas de distintos grupos, correspondientes a las categorías de las variables sociodemográficas y las categorías de las variables técnicas mencionadas en el capítulo anterior (Sección \ref{sec:KM_sociodemo}). En esta parte del estudio se introduce el modelo de regresión de Cox como una alternativa de estimación de la función de supervivencia con la influencia de variables explicativas (Sección \ref{sec:ModCox}). Aquí nuevamente se utilizan funciones de los paquetes \texttt{survival} para estimar los modelos y \texttt{survminer} para la realización de las visualizaciones.

Por último se presenta la estimación núcleo de la función de riesgo, para la primera y para la segunda vida, siguiendo la metodología planteada en el Capítulo \ref{cap:Meto}, tanto para la elección del núcleo como para el ancho de banda en el interior y en el borde (Sección \ref{sec:EstFunRiesgo}). En esta parte del capítulo se utiliza el paquete \texttt{muhaz} \citep{muhaz} para obtener dichos resultados.

\section{Estimación Kaplan-Meier \label{sec:KM}}
\subsection{Primera vida \label{subsec:KM_pv}}
Se consideran las \Sexpr{nrow(PrimeraVida)} tablets que tienen una primera vida, y se realiza una estimación de la función de supervivencia o confiabilidad para un modelo con datos censurados a la derecha.

<<echo=FALSE, cache=FALSE>>=
#levels(PrimeraVida$IndDef)
levels(PrimeraVida$IndDef) <- c(0, 1)
PrimeraVida$IndDef <- as.numeric(as.character(PrimeraVida$IndDef)) #El indicador de defunción se pasa nuevamente a numérico
#str(PrimeraVida$IndDef)

KM_pv <- survfit(Surv(Duracion, IndDef) ~ 1, data = PrimeraVida)
#KM_pv
#class(KM_pv)
#str(KM_pv)
sum = summary(KM_pv, times = seq(0,2000, by = 90))
#sum$table
#print(KM_pv, rmean = "common")
@


<<echo=FALSE, cache=TRUE>>=
t1 = addmargins(table(PrimeraVida$IndDef))
@

La cantidad de eventos (defunciones) registrados, tal como se ha mencionado anteriormente en el análisis descriptivo, asciende a \Sexpr{t1["1"]}, lo cual representa el \Sexpr{round((t1["1"]/t1["Sum"])*100,1)}\% del total de las tablets.

La media de la función de supervivencia estimada, se basan en un estimador truncado. Es decir, si la última observación no es una muerte, entonces la estimación de la curva de supervivencia no va a cero y la media no está definida. La estimación de la misma se realiza integrando la función de supervivencia estimada hasta un valor $T$:
$$ \hat{\mu} = \int_0^T \hat{S}_{KM} (t) dt. $$
Una opción es establecer el límite superior en una constante, en este trabajo se define $T$ como el tiempo de seguimiento máximo observado durante el estudio.

En el presente análisis, la vida media o media de la supervivencia es estimada en \Sexpr{round(sum$table["*rmean"],1)} días, con limite superior igual a \Sexpr{round(sum$rmean.endtime,1)} días y una desviación estándar de \Sexpr{round(sum$table["*se(rmean)"],1)} días.

La vida mediana de las tablets, la cual representa el tiempo en el cual el 50\% de la generación ha sobrevivido, es estimada en  \Sexpr{round(quantile(KM_pv, c(0.5))$quantile,1)} días. Su intervalo de confianza al 95\% es entre \Sexpr{round(quantile(KM_pv, c(0.5))$lower,1)} y \Sexpr{round(quantile(KM_pv, c(0.5))$upper,1)} días.

En el Anexo \ref{ane:KM_pv} se muestra la información de la estimación de la función de supervivencia a través del método de Kaplan-Meier para cada tiempo de supervivencia y una visualización del resumen de la misma.

Se presenta en la Figura \ref{fig:KM_PV} (panel izquierdo), el gráfico de la función de supervivencia estimada por el método de Kaplan-Meier\footnote{Este y los siguientes gráficos en los que se dibujan las diferentes curvas de supervivencia, fueron obtenidos con la función \texttt{ggsurvplot()} del paquete \texttt{survminer}.}, para el total de las tablets consideradas en el grupo primera vida, teniendo en cuenta la censura por la derecha e ignorando los distintos grupos de riesgo que se determinan por las distintas covariables que se especifican más adelante. Conjuntamente se grafica su respectivo intervalo de confianza al 95\% calculado con una aproximación logarítmica\footnote{La aproximación logarítmica es la opción por defecto utilizada para calcular los límites de confianza. Esta opción calcula los intervalos en función del riesgo acumulado o el log(supervivencia).}. En el panel derecho se traza una función arbitraria que define una transformación de la curva de supervivencia, llamada función de riesgo acumulado, $f(S(t)) = -log(S(t))$.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=2.7, fig.width=5, fig.align="center", cache=TRUE>>=
superv = list()
superv[[1]] = ggsurvplot(KM_pv, data = PrimeraVida, conf.int = T, xlab = "Tiempo (días)", ylab = "Probabilidad de supervivencia", legend = "none", censor = FALSE, title = "Función de supervivencia", surv.median.line = "hv", palette = "Dark2", font.main = c(9, "bold"), font.x = 11, font.y = 11, ggtheme = theme_gray(), conf.int.style = "step", size = 0.5)

# superv[[2]] = ggsurvplot(KM_pv, data = PrimeraVida, conf.int = T, xlab = "Tiempo (días)", ylab = "Eventos acumulados", legend = "none", censor = FALSE, fun = "event", y = c(0,1), title = "Función de distribución", palette = "Dark2", font.main = c(9, "bold"), font.x = 11, font.y = 11, ggtheme = theme_gray(), conf.int.style = "step", size=0.5)

superv[[2]] = ggsurvplot(KM_pv, data = PrimeraVida, conf.int = T, xlab = "Tiempo (días)", ylab = "Riesgo acumulado", legend = "none", censor = FALSE, fun = "cumhaz", title = "Función de riesgo acumulado", palette = "Dark2", font.main = c(9, "bold"), font.x = 11, font.y = 11, ggtheme = theme_gray(), conf.int.style = "step")

# labs(y = "Cantidad", x = "Duración (días)", title = "Primera Vida") +
#   theme(legend.position = "none", plot.title = element_text(hjust = 0.5))

arrange_ggsurvplots(superv, print= TRUE, ncol = 2, nrow = 1, size=0.5)
@
\caption[Estimación Kaplan-Meier de la función de supervivencia y función de riesgo acumulado de la primera vida de las tablets.]{Panel izquierdo: curva de supervivencia (línea verde continua) y su intervalo de confianza (líneas verdes punteadas), estimada a través del método de Kaplan-Meier para las \Sexpr{nrow(PrimeraVida)} tablets que tienen una primera vida. La línea negra punteada, indica el valor de la mediana de supervivencia igual a  \Sexpr{round(quantile(KM_pv, c(0.5))$quantile)} días. Panel derecho: curva de la función de riesgo acumulado, asociada a las probabilidades de supervivencia de la primera vida de las tablets. \label{fig:KM_PV}}
\end{figure}

Observando la curva de confiabilidad que se ha obtenido, se ve como en los primeros 450 días de vida de los dispositivos, la supervivencia de los mismos disminuye progresivamente, hasta mantenerse más constante a partir de ese tiempo, de hecho más de la mitad de las tablets ya han muerto. Como la estimación de la curva de supervivencia no vale cero en ningún momento, se sabe que el último dato registrado es un tiempo de censura. Otra aclaración pertinente es que los intervalos de confianza son casi inperceptibles y es debido al gran volumen de datos con el que se está trabajando. Con el gráfico de la función de riesgo acumulado, que muestra la probabilidad de defunción del equipo en el tiempo, se puede confirmar que el número de fallos se acumula con los días. Y por último, al observar las dos curvas en conjunto se puede comprobar que dichas funciones son equivalentes entre si como se mencionó en la metodología.

\subsection{Segunda vida y comparación \label{subsec:KM_sv}}
<<echo=FALSE, cache=TRUE>>=
#levels(SegundaVida$IndDef2)
levels(SegundaVida$IndDef2) <- c(0, 1)
SegundaVida$IndDef2 <- as.numeric(as.character(SegundaVida$IndDef2)) #El indicador de defunción se pasa nuevamente a numérico
#str(SegundaVida$IndDef2)

KM_sv <- survfit(Surv(Duracion2, IndDef2) ~ 1, data = SegundaVida)
#KM_sv
sum2 = summary(KM_sv)
#sum2$table
#print(KM_sv, rmean = "common")
@

<<echo=FALSE, cache=TRUE>>=
t22 = addmargins(table(SegundaVida$IndDef2))
@

Luego de que la tablet presenta la rotura que le impide seguir funcionando, es reparada por servicio técnico y vuelta a entregar al alumno o alumna, comenzando lo que se considera su segunda vida. Entonces, ¿cuanto durará ese equipo luego de su primera reparación con repuestos que implican su defunción? ¿Valdrá la pena arreglarlo? Con el fin de investigar estos interrogantes, se considera como otro grupo a analizar y comparar con la primera vida, la segunda vida de las tablets.

Se realiza entonces la estimación de la función de supervivencia de las \Sexpr{nrow(SegundaVida)} tablets que presentan una segunda vida, a través de la estimación Kaplan-Meier,  considerando nuevamente datos censurados a la derecha y no incluyendo aún ninguna variable explicativa.

Los resultados obtenidos son: el \Sexpr{round((t22["1"]/t22["Sum"])*100, 1)}\% (\Sexpr{t22["1"]}) del total de las tablets registraron una segunda defunción mientras que las \Sexpr{round((t22["0"]/t22["Sum"])*100, 1)} \% restantes (\Sexpr{t22["0"]} tablets) fueron censuradas. La media de la supervivencia es estimada, con límite superior igual a \Sexpr{round(sum2$rmean.endtime,1)} días, en \Sexpr{round(sum2$table["*rmean"],1)} días con desvío estándar de \Sexpr{round(sum2$table["*se(rmean)"],1)} días. La vida mediana es estimada en \Sexpr{round(quantile(KM_sv, c(0.5))$quantile,1)} días, su intervalo de confianza al 95\% es entre \Sexpr{round(quantile(KM_sv, c(0.5))$lower,1)} y \Sexpr{round(quantile(KM_sv, c(0.5))$upper,1)} días.

%%Si calculo la estimacion solo de la segunda vida me da un valor de media, si lo hago en conjunto con las dos vidas, me da otro, ya que el limite superior cambia. Puse la que calcula la media de la estimacion solo de la SV

<<echo=FALSE, cache=TRUE>>=
PV <- PrimeraVida[,c("Serie", "IndDef", "Duracion")]
PV$Vida <- "Primera vida"
SV <- SegundaVida[,c("Serie", "IndDef2", "Duracion2")]
SV$Vida <- "Segunda vida"
SV$IndDef <- SV$IndDef2
SV$IndDef2 <- NULL
SV$Duracion <- SV$Duracion2
SV$Duracion2 <- NULL

PVSV <- rbind(PV, SV)

KM_pvsv <- survfit(Surv(Duracion, IndDef) ~ Vida, data = PVSV)
#KM_pvsv
#KM_pvsv$table
#summary(KM_pvsv)
#print(KM_pvsv, rmean = "individual")
@


Siguiendo el procedimiento, se comparan las funciones de supervivencia de la primera y segunda vida, con el fin de obtener una aproximación de cuan conveniente es reparar los equipos en función de cuanto sobreviven una vez realizada la reparación, respecto a lo que sobrevivieron antes de la primer rotura que impidió seguir su funcionamiento.

Para ello se construye un gráfico donde se observa la estimación de Kaplan-Meier de las funciones de supervivencia, con sus respectivos intervalos de confianza al 95\%, para la primera y segunda vida, considerándolas como dos grupos diferentes. Conjuntamente con el gráfico, en la Figura \ref{fig:KM_PySV}, se presenta la tabla de riesgos que muestra, para cada una de las vidas, el número absoluto de equipos en riesgo en cada tiempo de supervivencia, el número acumulado de eventos y el número acumulado de censuras.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=5, fig.width=5.5, fig.align="center", cache=TRUE>>=
ggsurvplot(KM_pvsv, data = PVSV, conf.int = TRUE, risk.table = TRUE, cumcensor = TRUE, cumevents = TRUE, xlab = "Tiempo (días)", ylab = "", legend = "none", legend.title = "", legend.labs = c("Primera vida", "Segunda vida"), linetype = "strata", pval = TRUE, pval.method = TRUE, censor = FALSE, tables.height = 0.20, ggtheme = theme_gray(), tables.theme = theme_cleantable(), pval.size = 3, break.x.by = 200, fontsize = 3, risk.table.title = "Número en riesgo", cumevents.title = "Número acumulado de eventos", cumcensor.title = "Número acumulado de censuras", palette = "Dark2", size=0.5)
@
\caption[Funciones de supervivencia de la primera y la segunda vida estimadas por el método de Kaplan-Meier.]{Curvas de supervivencia estimadas por el método de Kaplan-Meier de las \Sexpr{nrow(PrimeraVida)} tablets pertenecientes al grupo primera vida (línea continua color verde) y de las \Sexpr{nrow(SegundaVida)} tablets pertenecientes al grupo segunda vida (línea punteada color naranja). En el eje $Y$ se muestra la probabilidad de supervivencia y en el eje $X$ el tiempo. El sombreado de cada curva indica su intervalo de confianza al 95\%. Además para cada una de las vidas (o grupos), se muestran para intervalos de tiempo de 200 días, el número de observaciones en el conjunto de riesgo, el número acumulado de eventos y el número acumulado de censuras. En la parte inferior izquierda del gráfico se muestra el valor $p$ calculado con el test de igualdad de funciones de supervivencia de log-rank, con pesos igual a 1. \label{fig:KM_PySV}}
\end{figure}

El gráfico parece indicar que las tablets del grupo de la primera vida, tienen un mejor pronóstico de supervivencia que las del grupo de la segunda vida, teniendo esta última una pendiente mucho mayor. Quiere decir que luego de que los equipos son reparados después de su primer defunción, vuelven a romperse rápidamente. Las curvas tienen una diferencia uniforme hasta los primeros 400 días aproximadamente, manteniendo una amplia distancia que luego va disminuyendo.

Una prueba de significación de esta diferencia es proporcionada por los test de G-rho de Fleming y Harrington, los cuales incluyen el test log-rank y el test de Peto-Peto.
A priori no se tiene información de que prueba podría proporcionar el mayor poder estadístico, ni como se podría violar la hipótesis nula, por lo que se implementan los dos test mencionados y se presentan resultados comparativos. (Ver Anexo \ref{ane:test_comp})

<<echo=FALSE, cache=TRUE>>=
logrank <- survdiff(Surv(Duracion, IndDef) ~ Vida, data = PVSV)
peto <- survdiff(Surv(Duracion, IndDef) ~ Vida, data = PVSV, rho = 1)
@

El valor del estadístico log-rank es \Sexpr{round(logrank$chisq)} y bajo la hipótesis nula la distribución asintótica de este estadístico es $\chi^2_1$, el valor del estadístico de Peto-Peto es \Sexpr{round(peto$chisq)} y bajo la hipótesis nula este estadísitico también se distribuye asintóticamente $\chi^2_1$. Como el $p$-valor es menor a 0.05 en ambos casos, hay evidencia para rechazar la hipótesis nula de igualdad de funciones de supervivencia (para un nivel de significación del 5\%). Entonces se puede concluir que la primera vida y la segunda vida tienen curvas de supervivencia Kaplan-Meier significativamente diferentes siendo las tablets del grupo primera vida las que tienen mayor probabilidad de sobrevivir a medida que pasa el tiempo.


\section{Estimación con variables auxiliares \label{sec:KM_sociodemo}}
Se vuelve a considerar solamente la primera vida de las tablets y se complementa el análisis realizado agregando al modelo cuatro variables explicativas como posibles predictoras del tiempo de supervivencia $T$, donde $T$ indica cantidad de días hasta que el equipo presenta por primera vez una rotura que impide continuar con su funcionamiento.

Las variables consideradas (todas variables categóricas), como ya fue expuesto en las secciones \ref{subsec:VarSocio} y \ref{subsec:VarTecni} , corresponden a características sociodemográficas de las alumnas y los alumnos y la entrada a servicio técnico de Ceibal. Se dividen de la siguiente manera:

\begin{itemize}
	\item Sexo del alumno o alumna. Dos grupos: femenino y masculino.
	\item Área geográfica en la que se encuentra la escuela. Tres grupos: interior rural, interior urbano y Montevideo.
	\item Contexto en el que se encuentra la escuela: Cinco grupos: desde quintil 1 hasta 5.
	\item Entradas de la tablet a servicio técnico. Dos grupos: el equipo fue reparado antes de morir, el equipo no tuvo ninguna reparación previo a su defunción. Dicho de otra forma, el equipo entró o no entró a servicio técnico (ST) antes de su defunción.

\end{itemize}

Desde el punto de vista tecnológico, el desgaste que la máquina sufre con el tiempo es un componente que podría aumentar el riesgo de experimentar roturas en las tablets. En cambio, desde el punto de vista de las características sociodemográficas, no se cuenta con la certeza de que dichos factores influyan de manera diferente en el riesgo de rotura.

Para ello se estima a través del método de Kaplan-Meier la curva de supervivencia para las diferentes variables, con la finalidad de encontrar alguna diferencia considerable entre estas. Se presentan dichos gráficos en la Figura \ref{fig:KM_var}.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=6, fig.align="center", cache=TRUE>>=
superv2 = list()
superv2[[1]] = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ Sexo, PrimeraVida, conf.type = "log-log") %>%
  ggsurvplot(title = "Supervivencia por sexo", xlab = "Tiempo (días)", ylab = "", conf.int = TRUE, legend.title = "",  legend = "bottom", legend.labs = c("Femenino", "Masculino"), censor = FALSE, ggtheme = theme_gray(), palette = "Dark2", fontsize = 3,  font.legend = 7, font.title = c(11, "bold"), pval = TRUE, pval.method=TRUE,  pval.size = 3, size = 0.3)

superv2[[2]] = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ Area, PrimeraVida, conf.type = "log-log") %>%
  ggsurvplot(title = "Supervivencia por área geográfica", xlab = "Tiempo (días)", ylab = "", conf.int = TRUE, legend.title = "",  legend = "bottom", legend.labs = c("I.Rural", "I.Urbano", "Mvd"), censor = FALSE, ggtheme = theme_gray(), palette = "Dark2", fontsize = 3, font.legend = 7, font.title = c(11, "bold"), pval = TRUE, pval.method=TRUE,  pval.size = 3, size = 0.3)

superv2[[3]] = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ Contexto, PrimeraVida, conf.type = "log-log") %>%
  ggsurvplot(title = "Supervivencia por contexto", xlab = "Tiempo (días)", ylab = "", conf.int = TRUE, legend.title = "",  legend = "bottom", legend.labs = c("Q1", "Q2", "Q3", "Q4", "Q5"), censor = FALSE, ggtheme = theme_gray(), palette = "Dark2", fontsize = 3, font.legend = 7, font.title = c(11, "bold"), pval = TRUE, pval.method=TRUE,  pval.size = 3, size = 0.3)

superv2[[4]] = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ ST, PrimeraVida, conf.type = "log-log") %>%
  ggsurvplot(title = "Supervivencia por Entrada a ST", xlab = "Tiempo (días)", ylab = "", conf.int = TRUE, legend.title = "", legend = "bottom", legend.labs = c("No entró", "Entró"), censor = FALSE, ggtheme = theme_gray(), palette = "Dark2", fontsize = 3,  font.legend = 6, font.title = c(11, "bold"), pval = TRUE, pval.method=TRUE,  pval.size = 3, size = 0.3)

arrange_ggsurvplots(superv2, print = TRUE, ncol = 2, nrow = 2, size = 0.3)
@
\caption[Funciones de supervivencia estimadas con el método de Kaplan-Meier para las distintas categorías de las variables auxiliares: sexo, área geográfica, contexto y entrada a ST.]{Gráficos de las funciones de supervivencia estimadas por el método de Kaplan-Meier para cada una de las variables auxiliares: sexo (panel superior izquierdo), área geográfica (panel inferior izquierdo), contexto (panel superior derecho) y entrada a ST (panel inferior derecho). Para cada una de las curvas se dibuja además, con un sombreado del mismo color de la misma, su intervalo de confianza al 95\%. Para cada variable se muestra también, el p-valor de los test de igualdad de curvas de supervivencia calculado con el método log-rank. \label{fig:KM_var}}
\end{figure}

A primera vista los diferentes sexos presentan una clara diferencia entre sus curvas de supervivencia, con un comportamiento paralelo en donde los alumnos de sexo masculino presentan mayor riesgo. Esto puede estar asociado a la educación que se le sigue dando a niñas y niños, siendo las primeras mayormente estimuladas para el cuidado de las cosas.

Las curvas por área geográfica muestran que las tablets entregadas en escuelas urbanas del interior del país son más vulnerables en relación a las entregadas en el resto del país, cuyas curvas son más parecidas y se entremezclan solapándose en varios momentos del tiempo los intervalos de confianza. El resultado de la curva del área rural podría estar asociado a que dicho sector tal vez cuenta con menor acceso a los centros de reparación de Ceibal.

El gráfico de los diferentes contextos socioculturales muestra también tendencias similares casi paralelas. La supervivencia de las tablets del contexto menos crítico, es mayor respecto a los demás, y las del quintil 3 son aquellas que presentan mayor riesgo de dejar de funcionar a lo largo del tiempo. El contar con otras alternativas tecnológicas parece hacer que el alumnado de contextos más favorables cuiden más sus equipos y por lo tanto tengan roturas más tardías. Para aquellas niñas y niños de nivel más crítico, que probablemente no cuentan con el acceso a otras tecnologías, también parece hacer que el cuidado sea mayor.

Se observa además en estos tres casos, como en los primeros 400 días aproximadamente, la supervivencia de estas tablets disminuye progresivamente hasta mantenerse más estable a partir de ese tiempo.

Por último, las tablets sin ninguna reparación antes de su primera defunción tienen un menor riesgo de dejar de funcionar. Para los equipos que nunca fueron a servicio técnico, la probabilidad de sobrevivir disminuye rápidamente al inicio de la vida, a diferencia de los otros, que tienen un mejor pronóstico. Al final del período de análisis, las curvas son más similares, mostrando una probabilidad de sobrevivir más constante.

Para testear la significancia de la diferencia entre las categorías de cada una de las variables y los supuestos antes mencionados, se realizan las respectivas pruebas de hipótesis. En todos los casos el $p$-valor es prácticamente cero por lo que hay evidencia para rechazar la hipótesis nula que establece que todas las curvas de supervivencia de la misma variable son iguales, concluyendo que las funciones de supervivencia de cada grupo son significativamente diferentes.

En los Anexos \ref{ane:km_sociodemo} y \ref{ane:testLRyPP} se muestra información descriptiva sobre las diferentes curvas de Kaplan-Meier junto con los resultados de las pruebas de log-rank y de Peto-Peto, ambas con un nivel de confianza del 95\%.

<<echo=FALSE, eval=FALSE>>=
KM_Sexo <- survfit(Surv(Duracion, IndDef) ~ Sexo, data = PrimeraVida)
summary(KM_Sexo)

KM_Area <- survfit(Surv(Duracion, IndDef) ~ Area, data = PrimeraVida)
summary(KM_Area)

KM_Contexto <- survfit(Surv(Duracion, IndDef) ~ Contexto, data = PrimeraVida)
summary(KM_Contexto)

KM_ST <- survfit(Surv(Duracion, IndDef) ~ ST, data = PrimeraVida)
summary(KM_ST)
@

<<echo=FALSE, eval=FALSE>>=
#Test log-rank
obj.sup <- Surv(PrimeraVida$Duracion, PrimeraVida$IndDef)

survdiff(obj.sup ~ Sexo, data = PrimeraVida)
survdiff(obj.sup ~ Area, data = PrimeraVida)
survdiff(obj.sup ~ Contexto, data = PrimeraVida)
survdiff(obj.sup ~ ST, data = PrimeraVida)

survdiff(obj.sup ~ Sexo, data = PrimeraVida, rho = 1)
survdiff(obj.sup ~ Area, data = PrimeraVida, rho = 1)
survdiff(obj.sup ~ Contexto, data = PrimeraVida, rho = 1)
survdiff(obj.sup ~ ST, data = PrimeraVida, rho = 1)
@


\subsection{Estimación con el modelo de Cox \label{subsec:est_cox}}
Como alternativa a la estimación Kaplan-Meier se aplicará el modelo de riesgos proporcionales de Cox, usualmente conocido como un modelo semi paramétrico, ya que como se ha explicado en la Sección \ref{sec:ModCox}, es paramétrico porque especifica un modelo de regresión con una forma funcional determinada y es no paramétrico en cuanto que no especifica la forma exacta de la distribución de los tiempos de supervivencia.

<<echo=FALSE, cache=TRUE>>=
mA = coxph(Surv(Duracion, IndDef) ~ Sexo , data = PrimeraVida, na.action = na.exclude)
PrimeraVida$Contexto = relevel(PrimeraVida$Contexto, ref = "Quintil 5")
mB = coxph(Surv(Duracion, IndDef) ~ Contexto, data = PrimeraVida, na.action = na.exclude)
mC = coxph(Surv(Duracion, IndDef) ~ Sexo + Contexto , data = PrimeraVida, na.action = na.exclude)
PrimeraVida$Area = relevel(PrimeraVida$Area, ref = "I.Urbano")
mcom = coxph(Surv(Duracion, IndDef) ~ Sexo + Area + Contexto + ST , data = PrimeraVida, na.action = na.exclude)
@


En primer término se consideran cuatro modelos distintos. En el \emph{Modelo A} y el \emph{Modelo B} se incluyen únicamente las covariables \emph{sexo} y \emph{contexto} respectivamente. El en \emph{Modelo C} se incluyen ambas covariables, \emph{sexo} y \emph{contexto}. Y, el \emph{Modelo D} es un modelo completo que incluye las cuatro covariables que se han utilizado en este trabajo: \emph{sexo}, \emph{área}, \emph{contexto} y \emph{ST}. Se elijen respectivamente las categorías \emph{Femenino}, \emph{I.Urbano}, \emph{Quintil 5} y \emph{0} como niveles de referencia de cada una de las variables.
\renewcommand{\theequation}{\Alph{equation}}
\begin{eqnarray}
  \hat{S}(t, X) &=& \left[ \hat{S}_0(t) \right] ^{exp(\hat{\beta}_{sexo} sexo)} \\
  \hat{S}(t, X) &=& \left[ \hat{S}_0(t) \right] ^{exp(\hat{\beta}_{contexto} contexto)} \\
  \hat{S}(t, X) &=& \left[ \hat{S}_0(t) \right] ^{exp(\hat{\beta}_{sexo} sexo + \hat{\beta}_{contexto} contexto)} \\
  \hat{S}(t, X) &=& \left[ \hat{S}_0(t) \right] ^{exp(\hat{\beta}_{sexo} sexo + \hat{\beta}_{área} área + \hat{\beta}_{contexto} contexto + \hat{\beta}_{ST} ST)}
\end{eqnarray}

En el Anexo \ref{ane:modelos} se presenta el resultado de la estimación de cada uno de ellos a través de un modelo de Cox.

Para saber cual de estos modelos candidatos que incluyen distintas variables se podría elegir, se utiliza una cantidad conocida como el \emph{Criterio de Información de Akaike}, o \emph{AIC}. Este es una medida de la bondad de ajuste de un modelo estadístico. Se puede decir que describe la relación entre el sesgo y varianza en la construcción del modelo (el \emph{AIC} no es una prueba del modelo en el sentido de la prueba de hipótesis, sino que es una prueba entre los modelos, una herramienta para la selección de los mismos). Dicha cantidad está dada por $AIC = -2 ln(L(\hat{\beta})) + kp$ donde $ln(L(\hat{\beta}))$ es el máximo valor del logaritmo de la función de verosimilitud para el modelo estimado, $p$ es el número de parámetros en el modelo y $k = 2$. Los valores de \emph{AIC} equilibran dos cantidades que son propiedades de un modelo, la bondad de ajuste y el número de parámetros (que entra como un término de penalización). Por lo tanto, un modelo ``bueno'' es aquel que se ajusta bien a los datos (valor pequeño de la bondad de ajuste) con pocos parámetros, de modo que los valores más pequeños de \emph{AIC} deberían en teoría indicar mejores modelos.

<<echo=FALSE, eval=FALSE>>=
AIC(mA)
AIC(mB)
AIC(mC)
AIC(mcom)
@

El mejor ajuste utilizando el criterio \emph{AIC}, es el \emph{Modelo D} (ver resultados en Anexo \ref{ane:aic}), el cual incluye todas las variables explicativas. El \emph{Modelo C}, que incluye tanto \emph{sexo} como \emph{contexto}, es una segunda opción cercana.

\begin{small}
<<echo=FALSE, results="asis">>=
tab4 = cbind(summary(mcom)$coefficients[,c("coef", "exp(coef)", "se(coef)")], summary(mcom)$conf.int[,c("lower .95","upper .95")], summary(mcom)$coefficients[,c("z", "Pr(>|z|)")])

dfList <- list(tab4)
attr(dfList, "message") <- c("Concordance = 0.549   (se = 0.001)", "Likelihood ratio test = 1541  on 8 df,   p= $<$2e-16","Wald test             = 1509  on 8 df,   p= $<$2e-16", "Score (logrank) test  = 1515  on 8 df,   p= $<$2e-16")

print(xtableList(dfList, caption = "Resultado del ajuste de un modelo de Cox al modelo que incluye las variables sexo, área, contexto y ST (modelo completo).", label = "tab:MC_cox"), caption.placement = "top", table.placement = "hbpt",  hline.after = c(-1,0))
@
\end{small}

Aplicando la estimación de Cox al \emph{Modelo D} o modelo completo, se obtienen con la función \texttt{coxph()} del paquete \texttt{survival} los resultados que se expresan en la Tabla \ref{tab:MC_cox}. En ella se especifican los parámetros estimados $\hat{\beta}_i$, cuyas estimaciones son estimaciones de máxima verosimilitud parcial y para cada covariable, el parámetro $\beta_i$ es la relación de riesgo para el efecto de ese parámetro en la supervivencia, ajustándose para las otras covariables. Para variables dummy o categóricas representa el efecto del nivel correspondiente en comparación con la categoría de referencia. También se pueden mostrar esos resultados como un diagrama de bosque, lo cual se muestra en la Figura \ref{fig:forest}\footnote{Dicho gráfico se realiza con la función \texttt{ggforest()} del paquete \texttt{survminer}.}. Este es un gráfico de las estimaciones de los coeficientes y los intervalos de confianza al 95\%, cada uno con respecto a un nivel de referencia. Por ejemplo, se puede ver que las tablets de las niñas (la referencia) tienen menos riesgo que las de los niños, las del interior rural y Montevideo tienen una mejor probabilidad de supervivencia que las del interior urbano (la referencia). Además se puede ver que los quintiles mas críticos (quintiles 1, 2 y 3) tienen peores resultados que los quintiles menos críticos (quintiles 4 y 5) y que entrar a servicio técnico una vez antes de morir reduce el riesgo respecto a las tablets que no entran (la referencia).
Estas conclusiones concuerdan con las estimaciones obtenidas anteriormente a través del método de Kaplan-Meier, particularmente se puede comparar con la Figura \ref{fig:KM_var} y observar esa relación.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=4.5, fig.align="center", cache=TRUE, warning=FALSE>>=
ggforest(mcom, PrimeraVida, main = "")
@
\caption[Resultado gráfico del ajuste del modelo de Cox al grupo de la primera vida con las variables sexo, área, contexto y ST]{Gráfico de bosque que muestra de forma sintetizada el resultado del ajuste del modelo de regresión Cox aplicado al grupo de la primera vida, considerando las variables explicativas sexo, área geográfica, contexto sociocultural y entrada a ST. Para cada una de las variables indica: las categorías, la cantidad de observaciones en cada una de ellas y los coeficientes estimados con sus respectivos intervalos de confianza al 95\%, de forma numérica y de forma gráfica, ubicándolos a la derecha o la izquierda de una recta vertical en el valor 1, según si la probabilidad de sobrevivir es mayor o menor respecto a la categoría de referencia de cada variable. También se muestran la cantidad total de eventos, el p-valor del test log-rank global y de cada variable, el valor de AIC y el índice de concordancia. \label{fig:forest}}
\end{figure}

Por otro lado, en la columna $Pr(>|z|)$ de la tabla con los resultados de la estimación del modelo de Cox aplicado al modelo completo, se pueden observar las variables que son significativas y las que no, ya que \emph{z} es el test de Wald, asintóticamente normal bajo la hipótesis de nulidad del coeficiente. En este caso todos los coeficientes son significativos al 1\%.

Además se muestran en el resultado, estadísticos de Concordancia y $R^2$, así como los estadísticos de prueba, grados de libertad y p-valores para la significación del modelo de los test de hipótesis de razón de verosimilitud, de Wald y de puntajes (ver metodología, Sección \ref{subsec:signif_Cox}).
Los tres criterios son asintóticamente equivalentes, con sus p-valores significativos. Por tanto, se puede afirmar que el modelo permite explicar la variable tiempo de supervivencia considerada.

<<echo=FALSE>>=
s = summary(mcom)$conf.int
@

Otra información importante que amplía lo expresado en párrafos anteriores, es la estimación de los riesgos relativos. \emph{exp(coef)} permite una interpretación de los efectos de las variables explicativas sobre la función de riesgo $h(t)$, y se acompaña de un intervalo de confianza al 95\%. Se observa por ejemplo que los equipos entregados a niños tienen \Sexpr{round(s["SexoMasculino", "exp(coef)"], 1)} veces el riesgo de morir en relación con los equipos entregados a niñas. Pertenecer al área interior rural hace que la defunción del equipo tenga un riesgo de \Sexpr{round(s["AreaI.Rural", "exp(coef)"], 1)} veces el riesgo de muerte de los que pertenecen al interior urbano. En cuanto al contexto en donde se entrega el equipo, pertenecer al quintil 3 es \Sexpr{round(s["ContextoQuintil 3", "exp(coef)"], 1)} veces más riesgoso que pertenecer al quintil 5. Finalmente, haber entrado a servicio técnico antes, hace que la muerte tenga un riesgo de \Sexpr{round(s["ST1", "exp(coef)"], 1)} veces el riesgo de muerte de los que no entraron ninguna vez.

\subsubsection{Diagnóstico del modelo \label{subsec:diagnos_cox}}
El modelo de Cox hace varias suposiciones. Por lo tanto es importante evaluar si el modelo de regresión de Cox ajustado describe adecuadamente los datos. En concreto se debe comprobar:
\begin{itemize}
\item Suposición de riesgos proporcionales.
\item Si existen observaciones influyentes (o valores atípicos).
\item Detectar la no linealidad de los efectos de las variables predictoras en la función de riesgo.
\end{itemize}
Para verificar estas suposiciones del modelo, se utilizan diferentes tipos de residuos. Los residuos a considerar son:
\begin{itemize}
\item Residuos de \emph{Schoenfeld} vs \emph{tiempo} para verificar la suposición de riesgos proporcionales.
\item Residuos de \emph{Schoenfeld} vs \emph{tiempo} o \emph{martingala} vs \emph{identificador de la observación} de cada predictora para evaluar la no linealidad.
\item Desviación residual (transformación simétrica de los residuos de martingala) para examinar observaciones influyentes.
\end{itemize}

\textbf{Observaciones influyentes}

La detección de observaciones influyentes se realiza mediante métodos gráficos. En la Figura \ref{fig:resid1} se muestran los residuos tipo devianza\footnote{Este y los siguientes gráficos en los que se dibujan los diferentes residuos que permiten evaluar el modelo son obtenidos con la función \texttt{ggcoxdiagnositcs()} del paquete \texttt{survminer} incluyendo en el argumento \texttt{type} el tipo de residuo que corresponda.}, en la cual se evidencia que no existe ningún individuo que esté influenciando el ajuste del modelo.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3.5, fig.width=4, fig.align="center", cache=TRUE, warning=FALSE>>=
ggcoxdiagnostics(mcom, type = "deviance", linear.predictions = FALSE, xlab = "Id. observación", ylab = "Residuos (tipo desvío)", hline = TRUE, hline.col = brewer.pal(4, "Dark2")[2], point.col = brewer.pal(4, "Dark2")[1], point.alpha = 0.3, point.size = 0.1)
@
\caption[Residuos tipo devianza para la estimación del modelo de Cox aplicado a la primera vida con las variables explicativas sexo, área, contexto y ST]{Gráfico de los residuos tipo devianza del modelo de Cox aplicado a la primera vida con las variables explicativas sexo, área, contexto y ST que permite detectar observaciones influyentes. En el eje $Y$ se presentan los residuos y en el eje $X$ la identificación de cada observación. Se agrega la línea horizontal que resalta el nivel $y=0$. \label{fig:resid1}}
\end{figure}

También se pueden generar gráficos de influencia sobre la estimación de cada coeficiente, los cuales se obtienen utilizando los residuos dfbetas y se muestran en la Figura \ref{fig:resid2}.

<<echo=FALSE, fig.height=3.5, fig.width=4, fig.align="center", cache=TRUE, warning=FALSE, eval=FALSE>>=
ggcoxdiagnostics(mcom, type = "dfbetas", xlab = "Id. observación", ylab = "Residuos (tipo dfbeta)", hline = TRUE, hline.col = brewer.pal(4, "Dark2")[2], point.col = brewer.pal(4, "Dark2")[1], point.alpha = 0.3, point.size = 0.1)
@


\begin{figure}[hbpt]
\begin{center}
\includegraphics[scale = 0.7]{grafi/residuos_dfbeta.png}
\caption[Residuos tipo dfbetas para la estimación del modelo de Cox aplicado a la primera vida con las variables explicativas sexo, área, contexto y ST]{Gráfico de los residuos tipo dfbetas del modelo de Cox aplicado a la primera vida con las variables explicativas sexo, área, contexto y ST que permite detectar observaciones influyentes por separado para cada coeficiente estimado (uno en cada panel, dejando fuera los niveles de referencia). En el eje $Y$ se presentan los residuos y en el eje $X$ la identificación de cada observación. En cada panel se agrega la línea horizontal que resalta el nivel $y=0$. \label{fig:resid2}}
\end{center}
\end{figure}


El patrón de residuos es bastante simétrico respecto de cero. Además no hay residuos con valores claramente fuera del rango (-0.03, 0.03), indicando que no hay ninguna observación que pueda identificarse como anómala. En caso de existir alguna se debería eliminar y ajustar el nuevo modelo.


\textbf{No linealidad}

El test de no linealidad sólo se puede interpretar para variables de tipo numérico, donde se pueden plantear diferentes tendencias en la respuesta en función de diferentes transformaciones numéricas de la predictora.

% \begin{figure}[hbpt]
<<echo=FALSE, fig.height=5, fig.align="center", cache=TRUE, warning=FALSE, eval=FALSE>>=
#ggcoxdiagnostics(mcom, type = "schoenfeld", ox.scale = "time", xlab = "Tiempo", ylab = "Residuos (tipo Schoenfeld)", hline = TRUE, hline.col =  brewer.pal(4, "Dark2")[2], point.col = brewer.pal(4, "Dark2")[1], point.alpha = 0.3, point.size = 0.1)

ggcoxdiagnostics(mcom, type = "schoenfeld", ox.scale = "observation.id", xlab = "Id. observación", ylab = "Residuos (tipo Schoenfeld)", hline = TRUE, hline.col = brewer.pal(4, "Dark2")[2], point.col = brewer.pal(4, "Dark2")[1], point.alpha = 0.3, point.size = 0.1)
@
% \caption[Residuos tipo Schoenfeld para la estimación del modelo de Cox aplicado a la primera vida con las variables explicativas sexo, área, contexto y ST]{Gráfico de los residuos tipo Schoenfeld del modelo de Cox aplicado a la primera vida con las variables explicativas sexo, área, contexto y ST que permite detectar la forma funcional de las covariables, por separado para cada coeficiente estimado (uno en cada panel, dejando fuera los niveles de referencia). En cada panel se agrega una línea suavizada que resalta el promedio local de los residuos y su desvío estándar (lineas punteadas). En el eje $Y$ de cada una se presentan los residuos y en el eje $X$ la identificación de cada observación.
% \label{fig:resid3}}
% \end{figure}

En este caso, que son todas variables categóricas, se puede evaluar el modelo creando residuos martingala y graficándolos frente a las predictoras seleccionadas. Los resultados que se exponen en la Figura \ref{fig:resid4}, muestran que los residuos se distribuyen uniformemente sobre los valores de cada covariable.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=4.5, fig.align="center", cache=TRUE>>=
levels(PrimeraVida$ST) = c("No entró", "Entró")
levels(PrimeraVida$Contexto) = c("Q1", "Q2", "Q3", "Q4", "Q5")

rr.final = residuals(mcom, type = "martingale")
rr.final.sexo = rr.final  ~ PrimeraVida$Sexo
par(mfrow = c(2,2))
plot(rr.final  ~ PrimeraVida$Sexo, ylab = "Residuos (tipo martingala)", xlab = "Sexo", asp = 3)
plot(rr.final ~ PrimeraVida$Area, ylab = "Residuos (tipo martingala)", xlab = "Área geográfica", asp = 3.5)
plot(rr.final ~ PrimeraVida$Contexto, ylab = "Residuos (tipo martingala)", xlab = "Contexto sociodemográfico", asp = 4)
plot(rr.final ~ PrimeraVida$ST, ylab = "Residuos (tipo martingala)", xlab = "Entrada a servicio técnico", asp = 4.5)

levels(PrimeraVida$ST) = c("0", "1")
levels(PrimeraVida$Contexto) = c("Quintil 1", "Quintil 2", "Quintil 3", "Quintil 4", "Quintil 5")

@
\caption[Residuos tipo martingala para la estimación del modelo de Cox aplicado a la primera vida con las variables explicativas sexo, área, contexto y ST]{Gráfico de cajas en el que se dibuja para cada categoría de cada covariable (en paneles diferentes), los residuos tipo martingala, lo cual permite corroborar el supuesto de linealidad de los efectos de cada predictora. En el eje $Y$ de cada una se presentan los residuos y en el eje $X$ las categorías de la variable correspondiente. \label{fig:resid4}}
\end{figure}


\textbf{Riesgos proporcionales}

La validación de riesgos proporcionales se realiza con la prueba de hipótesis de correlación para los residuos Schoenfeld escalados de cada covariable con alguna transformación del tiempo. El valor predeterminado de dicha transformación (y utilizado en este trabajo) se basa en la estimación de Kaplan-Meier de la función de supervivencia.

La suposición de proporcionalidad es que la tasa de riesgo de un individuo es relativamente constante en el tiempo, y esto es lo que prueba la función \texttt{cox.zph()} del paquete \texttt{survival}. La salida de dicha función, la cual se muestra en la Tabla \ref{tab:Cox}, es una matriz con una fila para cada variable, y adicionalmente una última fila para la prueba global para el modelo en su conjunto. Las columnas de la matriz contienen el coeficiente de correlación entre el tiempo de supervivencia transformado y los residuos de Schoenfeld escalados \emph{rho}, el estadístico de prueba chi-cuadrado \emph{chisq} y su respectivo $p$-valor de dos lados (o colas). Para la prueba global no existe una correlación adecuada, por lo que se ingresa un \emph{NA} en la matriz como marcador de posición.

<<echo=FALSE, cache=TRUE, results="asis">>=
h = cox.zph(mcom)
listCox = list(round(h$table, 4))
print(xtableList(listCox, caption = "Verificación del supuesto de riesgos proporcionales del modelo de Cox aplicado a la primera vida de las tablets con las variables explicativas sexo, área, contexto y ST.", label = "tab:Cox", digits = c(0,3,3,3)), caption.placement = "top", table.placement = "hbpt")
@

Todos los p-valores (tanto los individuales de cada variable como el global para el modelo) son inferiores a 0.05 por lo que hay evidencia para rechazar la hipótesis nula no cumpliéndose el supuesto de riesgos proporcionales, tener valores p muy pequeños indica que hay coeficientes dependientes del tiempo.

El supuesto de riesgos proporcionales también se puede verificar de forma gráfica dibujando para cada coeficiente los residuos de Schoenfeld escalados con la función \texttt{ggcoxzph()} del paquete \texttt{survminer}. Dicho resultado se muestra en el Anexo \ref{ane:zph}} lo cual aporta la misma información que lo anterior.


<<echo=FALSE, cache=TRUE>>=
result.R = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ PrimeraVida$Area, subset = {PrimeraVida$Area == "I.Rural"})
time.R = result.R$time
surv.R = result.R$surv
cloglog.R = log(-log(surv.R))
logtime.R = log(time.R)

result.M = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ PrimeraVida$Area, subset = {PrimeraVida$Area == "Montevideo"})
time.M = result.M$time
surv.M = result.M$surv
cloglog.M = log(-log(surv.M))
logtime.M = log(time.M)

# result.U = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ PrimeraVida$Area, subset = {PrimeraVida$Area == "I.Urbano"})
# time.U = result.U$time
# surv.U = result.U$surv
# cloglog.U = log(-log(surv.U))
# logtime.U = log(time.U)

# result.ST1 = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ PrimeraVida$ST, subset = {PrimeraVida$ST == "1"})
# time.ST1 = result.ST1$time
# surv.ST1 = result.ST1$surv
# cloglog.ST1 = log(-log(surv.ST1))
# logtime.ST1 = log(time.ST1)
#
# result.ST0 = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ PrimeraVida$ST, subset = {PrimeraVida$ST == "0"})
# time.ST0 = result.ST0$time
# surv.ST0 = result.ST0$surv
# cloglog.ST0 = log(-log(surv.ST0))
# logtime.ST0 = log(time.ST0)
#
# plot(cloglog.ST1 ~ logtime.ST1, col="red", type="s", lwd=2)
# lines(cloglog.ST0 ~ logtime.ST0, col="blue", type="s", lwd=2)

result.F = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ PrimeraVida$Sexo, subset = {PrimeraVida$Sexo == "Femenino"})
cloglog.F = log(-log(result.F$surv))
logtime.F = log(result.F$time)

result.Ma = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ PrimeraVida$Sexo, subset = {PrimeraVida$Sexo == "Masculino"})
cloglog.Ma = log(-log(result.Ma$surv))
logtime.Ma = log(result.Ma$time)


result.Q1 = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ PrimeraVida$Contexto, subset = {PrimeraVida$Contexto == "Quintil 1"})
cloglog.Q1 = log(-log(result.Q1$surv))
logtime.Q1 = log(result.Q1$time)

result.Q5 = survfit(Surv(PrimeraVida$Duracion, PrimeraVida$IndDef) ~ PrimeraVida$Contexto, subset = {PrimeraVida$Contexto == "Quintil 5"})
cloglog.Q5 = log(-log(result.Q5$surv))
logtime.Q5 = log(result.Q5$time)
@

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3.5, fig.align="center", cache=TRUE>>=
R = data.frame(cbind(cloglog.R, logtime.R))
M = data.frame(cbind(cloglog.M, logtime.M))
are5 = ggplot() +
  geom_line(data = R, aes(y = cloglog.R, x = logtime.R, colour = "I.Rural")) +
  geom_line(data = M, aes(y = cloglog.M, x = logtime.M, colour = "Montevideo")) +
  labs(x = "Log Tiempo", y = "Superv. log-log complementaria", title = "Área geográfica") +
  scale_colour_manual(values = c(brewer.pal(4, "Dark2")[1], brewer.pal(4, "Dark2")[2]), name= "") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))


Fe = data.frame(cbind(cloglog.F, logtime.F))
Ma = data.frame(cbind(cloglog.Ma, logtime.Ma))
sex5 = ggplot() + geom_line(data = Fe, aes(y = cloglog.F, x = logtime.F, colour = "Femenino")) +
  geom_line(data = Ma, aes(y = cloglog.Ma, x = logtime.Ma, colour = "Masculino")) +
  labs(x = "Log Tiempo", y = "Superv. log-log complementaria", title = "Sexo") +
  scale_colour_manual(values = c(brewer.pal(4, "Dark2")[1], brewer.pal(4, "Dark2")[2]), name= "") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

Q1 = data.frame(cbind(cloglog.Q1, logtime.Q1))
Q5 = data.frame(cbind(cloglog.Q5, logtime.Q5))
con5 = ggplot() + geom_line(data = Q1, aes(y = cloglog.Q1, x = logtime.Q1, colour = "Quintil 1")) +
  geom_line(data = Q5, aes(y = cloglog.Q5, x = logtime.Q5, colour = "Quintil 5")) +
  labs(x = "Log Tiempo", y = "Superv. log-log complementaria", title = "Contexto sociocultural") +
  scale_colour_manual(values = c(brewer.pal(4, "Dark2")[1], brewer.pal(4, "Dark2")[2]), name= "") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

are5 + sex5 + con5 + plot_layout(ncol = 3)
@
\caption[Transformación log-log complementaria para verificar el supuesto de riesgos proporcionales (otra forma).]{Gráficos de líneas utilizados para evaluar el supuesto de riesgo proporcionales. En el eje $Y$ se grafica la transformación log-log complementaria de las tasas de riesgo de la primera vida de las tablets considerando las variables auxiliares sexo, área y contexto y en el eje $X$ el logaritmo del tiempo. En el panel izquierdo se comparan las categorías interior rural (línea verde) y Montevideo (línea naranja) de la variable área, en el panel del medio las categorías femenino (linea verde) y masculino (linea naranja) de la variable sexo y en el panel derecho, las categorías quintil 1 y quintil 5 de la variable contexto. \label{fig:riesprop2}}
\end{figure}

Si se comparan los tiempos de supervivencia entre dos grupos, hay una gráfica simple que puede ayudar a evaluar el supuesto de riesgos proporcionales.
La función $g(u) = log {-log(u)}$ se llama transformación $log-log$ complementaria, y tiene el efecto de cambiar el rango de $(0,1)$ para $u$ a $(-\infty, +\infty)$ para $g(u)$. Un gráfico de $g[S_1(t)]$ y $g[S_0(t)]$ versus $t$ o $log (t)$ producirá curvas paralelas separadas por $\beta$ si el supuesto de riesgos proporcionales es correcto.

Por ejemplo, en la Figura \ref{fig:riesprop2} se compara el área interior rural con Montevideo,  por otro lado el quintil 1 con el 5 y ambos sexos, a través de la transformación de las tasas de riesgo mencionadas anteriormente. Para realizar dichas gráficas primero se crean las curvas de supervivencia pero considerando solamente el subconjunto de filas correspondientes a los datos de cada categoría de las que se quiere comparar, luego se realiza la transformación mencionada en el párrafo anterior.
Para los tres casos, las curvas son claramente no paralelas (se cruzan) evidenciando que las relaciones de riesgo no son constantes en el tiempo, por lo tanto, no sería apropiado usar un modelo de riesgos proporcionales de Cox para esta situación.

Si una covariable rompe la suposición, es posible que deba corregirse ya que existen coeficientes dependientes del tiempo. Sin hacer algo al respecto, se podrían invalidar los resultados, de una manera similar a cómo se podrían romper los supuestos de regresión lineal. Entonces es natural preguntar en este punto, si el modelo de riesgos proporcionales de Cox no es apropiado ¿cómo se debe llevar a cabo el análisis?. Hay varias opciones que podrían servir, tales como:
\begin{itemize}
\item Analizar estratificando en las variables auxiliares; es decir, en lugar de ajustarse un modelo, obtener las curvas de Kaplan-Meier para cada grupo de cada variable por separado. Esta alternativa ya se realizó mas bien como análisis exploratorio en la Sección \ref{sec:KM_sociodemo}.
\item Ajustar el modelo de Cox a dos subconjuntos diferentes según el momento en que la razón de riesgo cambia, para obtener dos estimaciones de razón de riesgo diferentes, una para cada uno de estos dos períodos, o directamente comenzar el análisis luego de cierta cantidad de días.
\item Ajustar un modelo de Cox modificado que incluya variables dependientes del tiempo que midan la interacción de las covariables con el tiempo. Este modelo se llama modelo extendido de Cox.
\end{itemize}

\subsubsection{Modelo extendido de Cox}
El correspondiente modelo de Cox extendido, puede usarse para verificar el supuesto de riesgos proporcionales para las variables independientes del tiempo. Además, se puede usar para obtener una fórmula de razón de riesgo que considere los efectos de las variables que no satisfacen dicho supuesto como es en este caso.

En esta investigación, a modo de ejemplo, se considera en lugar del modelo completo con el que se venía trabajando, un nuevo modelo que inlcuye solo la covariable que indica si el equipo entró a servicio técnico antes de su defuncón o no (ST), y se extenderá aplicando una función del tiempo, $g_i(t) = t$. Entonces, el modelo extendido de Cox en este caso toma la forma:

$$ h(t,X(t)) = h_0 exp \left[ \beta_{ST}ST + \delta_{ST} (ST \times t) \right]. $$

Para ejecutar un modelo extendido de Cox en \texttt{R}, el conjunto de datos debe estar en el formato del proceso de conteo (inicio, detención). Esto se puede lograr con la función \texttt{survSplit()} del paquete \texttt{survival}. Dicha función crea múltiples observaciones para individuos en riesgo en múltiples puntos de tiempo, los cuales son proporcionados por el usuario. La opción más general es un vector de puntos de corte de tiempo que incluye todos los tiempos de eventos en los datos.

Otra forma es utilizar la función \texttt{coxphw()} del paquete \texttt{coxphw} \citep{coxphw}
la cual realiza una regresión ponderada de Cox, proporcionando estimaciones imparciales de las razones de riesgo promedio, también en caso de riesgos no proporcionales. Los efectos dependientes del tiempo se pueden estimar convenientemente incluyendo interacciones de covariables con funciones arbitrarias del tiempo, con o sin el uso de la opción de ponderación.

En la Tabla \ref{tab:extendido} se presenta el resultado de dicha estimación.

<<echo=FALSE, cache=TRUE, results="asis">>=
fit = coxphw(Surv(Duracion, IndDef) ~ ST + Duracion:ST, data = PrimeraVida, template = "PH")

coment <- paste0("\\hline \n \\multicolumn{5}{l}",
      "{\\small{Wald Chi-square=501.3418 on 2df, p=0, n=80500}} \n")

print(xtable(fit, caption = "Estimación de un modelo extendido de Cox", label = "tab:extendido", display = c("s","f", "f", "f", "f", "f")), caption.placement = "top", table.placement = "hbpt", include.rownames = TRUE, hline.after = c(-1,0), add.to.row = list(pos = list(2), command = coment))
@

El estadístico z de la prueba de Wald de \Sexpr{round(fit$Wald,1)} y el valor p significativo (p = 0) sugiere que la razón de riesgo para ST no es igual a lo largo del tiempo. En otras palabras, el valor p significativo proporciona evidencia de que la suposición de riesgo proporcional se viola.



\section{Estimación de la función de riesgo \label{sec:est_FunRies}}
La función de riesgo (Sección \ref{subsec:FunRiesgo}) es especialmente útil para describir los cambios temporales de la probabilidad de experimentar un fallo. Para obtener desde otro enfoque, alguna idea de como se comporta el riesgo de presentar una defunción, es que se hace hincapié en esta función estimándola a través del método propuesto en la metodología (Sección \ref{sec:EstFunRiesgo}).

\subsection{Primera vida \label{subsec:FunRies_pv}}
Se aplica, utilizando la función \texttt{muhaz()} del paquete \texttt{muhaz}, la estimación por núcleos de la función de riesgo de la primera vida de todas las tablets (incluyendo las observaciones censuradas), con un núcleo de Epanechnikov. Se realiza la comparación con otras posibles funciones núcleos: rectangular, bicuadrática y tricuadrático, sin observarse diferencias notorias entre ellas, por lo que se decide seguir trabajando con el de Epanechnikov (ver Anexo \ref{ane:nucleos}).

<<echo=FALSE, cache=TRUE>>=
#con bw.method = global y kernel = Epanechnikov
fitHAZg <- muhaz(times = PrimeraVida$Duracion, delta = PrimeraVida$IndDef, bw.method = "g")
#fitHAZg
#sum7 = summary(fitHAZg)
#xtable(sum7)

#con bw.method = local y kernel = Epanechnikov
fitHAZl <- muhaz(times = PrimeraVida$Duracion, delta = PrimeraVida$IndDef, bw.method = "l")
#summary(fitHAZl)
@

Otra consideración importante en la estimación no paramétrica de curvas, es la selección del ancho de ventana (o bandwith). Una alternativa es utilizar una \emph{ventana global}, es decir el mismo parámetro ventana para todos los puntos en los que se hará la estimación.

Puede ser que este método no presente buenos resultados. Entonces, en regiones de baja densidad de datos es preferible elegir un parámetro ventana grande, mientras que en aquellas áreas en las que existen un mayor número de datos, es preferible elegir parámetros ventana pequeños, pues evidenciarán más claramente las características locales de la función a estimar. Con esta filosofía se construyen los estimadores de \emph{ventana local}, que utilizan una ventana diferente dependiendo del punto concreto donde se realice la estimación.

En el panel superior de la Figura \ref{fig:FunRiesgo} se presenta la estimación de la función de riesgo de las \Sexpr{fitHAZg$pin$nobs} tablets que presentan una primera vida, utilizando un método de selección de ancho de banda global, cuyo valor óptimo igual a \Sexpr{round(fitHAZg$bw.glob,1)} se obtiene minimizando el IMSE, aplicando correcciones de borde izquierda y derecha y un núcleo de Epanechnikov. En el panel inferior se presenta la estimación de la función de riesgo de la primera vida pero utilizando un método de selección de ancho de ventana local, en donde el valor óptimo en cada punto se obtiene minimizando el MSE local, también con corrección en ambos bordes y núcleo de Epanechnikov.

Para ambos casos, el tiempo mínimo es por defecto \Sexpr{fitHAZg$pin$min.time} y el tiempo máximo es por defecto \Sexpr{round(fitHAZg$pin$max.time,1)} días, correspondiendo al momento en que 10 tablets permanecen en riesgo. El ancho de banda inicial (pilot bandwidth) utilizado en la minimización del ECM es por defecto el recomendado por Muller y Wang, expresado en la metodología, igual a \Sexpr{round(fitHAZg$pin$bw.pilot,1)}. Por último, el ancho de banda utilizado para suavizar los anchos de banda locales (smoothing bandwidth), es 5 veces el ancho de banda inicial, es decir \Sexpr{round(fitHAZg$pin$bw.smooth,1)}.

<<echo=FALSE, cache=TRUE, message=FALSE>>=
quiet <- function(x) {
  sink(tempfile())
  on.exit(sink())
  invisible(force(x))
}

#Piecewise Exponential Hazard Rate
fitPEHAZ <- quiet(pehaz(PrimeraVida$Duracion, PrimeraVida$IndDef))
# summary(fitPEHAZ)
@

Para la comparación de las estimaciones de la función de riesgo suavizado, también se grafica la curva de estimación exponencial por tramos obtenida con la función \texttt{pehaz()} del paquete \texttt{muhaz}. Esta, da una idea  de las características de los datos sin que el tratamiento de los mismos implique un suavizado. Éste método de estimación paramétrica divide el dominio de tiempo en intervalos de igual ancho y luego calcula el riesgo en cada intervalo como el número de eventos dividido entre el tiempo total de seguimiento en ese intervalo. No se agregan detalles de este modelo, ya que solo se utiliza de forma comparativa y de ayuda para confirmar que se están generando estimaciones realistas de la función de riesgo referida. Se utiliza el ancho del intervalo por defecto igual a $\dfrac{(tiempo.max - tiempo.min)}{(8*(nu)^{0.2})} = \dfrac{(\Sexpr{round(max(PrimeraVida$Duracion),1)} - 0)}{8*(\Sexpr{sum(fitPEHAZ$Events)})^{0.2}} = \Sexpr{round(fitPEHAZ$Width, 1)}$.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=4.5, fig.width=4.5, fig.align="center", comment=NA>>=
HAZg = data.frame(cbind(fitHAZg$est.grid, fitHAZg$haz.est))
HAZl = data.frame(cbind(fitHAZl$est.grid, fitHAZl$haz.est))
PEHAZ = data.frame(cbind(fitPEHAZ$Cuts[-1], fitPEHAZ$Hazard))

global = ggplot() +
  geom_step(data = PEHAZ, aes(x = X1,  y = X2), color =  brewer.pal(4, "Dark2")[2]) +
  geom_line(data = HAZg, aes(x = X1,  y = X2), color = brewer.pal(4, "Dark2")[1], size = 1) +
  labs(x = "Tiempo (días)", y = "", title = "Método global") +
  theme(plot.title = element_text(hjust = 0.95))

local = ggplot() +
  geom_step(data = PEHAZ, aes(x = X1,  y = X2, colour = "Exponencial constante a intervalos")) +
  geom_line(data = HAZl, aes(x = X1,  y = X2, colour = "Estimación núcleo"), size = 1) +
  labs(x = "Tiempo (días)", y = "", title = "Método local")+
  scale_colour_manual(values = c(brewer.pal(4, "Dark2")[1], brewer.pal(4, "Dark2")[2]), name= "") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.95))


global + local + plot_layout(ncol=1)
@
\caption[Estimación por núcleos de la función de riesgo de la primera vida de las tablets]{Gráficos de la estimación por núcleos de la función de riesgo de la primera vida de las tablets (líneas en color verde). En el panel superior, se utiliza un ancho de ventana global, siendo el ancho óptimo igual a \Sexpr{round(fitHAZg$bw.glob,1)} mientras que en el panel inferior se realiza la estimación con un ancho de ventana local. Para ambos casos el ancho de banda inicial es igual a \Sexpr{round(fitHAZl$pin$bw.pilot,1)} y se aplica corrección de límites en el borde izquierdo y el derecho, el núcleo utilizado es el de Epanechnikov. Las líneas en color naranja representan la estimación de la función de riesgo utilizando el modelo exponencial constante a intervalos. \label{fig:FunRiesgo}}
\end{figure}

Se observa un crecimiento parcial del riesgo en los primeros meses de vida de los equipos, que luego se incrementa, alcanzándose la mayor tasa de riesgo en aproximadamente los 350 días. A medida que transcurre el tiempo, el riesgo disminuye, es decir que la probabilidad de que las tablets se rompan dejando de funcionar dado que no se han roto hasta ese momento, va siendo cada vez menor.
Al comparar la estimación obtenida seleccionando una ventana global con ancho de banda variables, se observa que la curva obtenida con ventanas locales es más suavizada, destacando que se asemeja menos a la estimación exponencial constante a intervalos.


\subsection{Segunda vida \label{subsec:FunRies_pv}}
Se vuelven a realizar las mismas estimaciones que las realizadas para el grupo primera vida, pero considerando las \Sexpr{nrow(SegundaVida)} tablets que tienen una segunda vida después de su primer defunción. Se presentan los resultados en la Figura \ref{fig:FunRiesgo2}\footnote{Se utiliza la función \texttt{ggplot()} para obtener dicha visualización.}.

<<echo=FALSE, cache=TRUE, message=FALSE>>=
#con bw.method = global y kernel = Epanechnikov
fitHAZg2 <- muhaz(times = SegundaVida$Duracion, delta = SegundaVida$IndDef, bw.method = "g")

#con bw.method = local y kernel = Epanechnikov
fitHAZl2 <- muhaz(times = SegundaVida$Duracion, delta = SegundaVida$IndDef, bw.method = "l")

fitPEHAZ2 <- quiet(pehaz(SegundaVida$Duracion, SegundaVida$IndDef))
@

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=4.5, fig.width=4.5, fig.align="center", cache=TRUE>>=
HAZg2 = data.frame(cbind(fitHAZg2$est.grid, fitHAZg2$haz.est))
HAZl2 = data.frame(cbind(fitHAZl2$est.grid, fitHAZl2$haz.est))
PEHAZ2 = data.frame(cbind(fitPEHAZ2$Cuts[-1], fitPEHAZ2$Hazard))

global2 = ggplot() +
  geom_step(data = PEHAZ2, aes(x = X1,  y = X2), color =  brewer.pal(4, "Dark2")[2]) +
  geom_line(data = HAZg2, aes(x = X1,  y = X2), color = brewer.pal(4, "Dark2")[1], size = 1) +
  labs(x = "Tiempo (días)", y = "", title = "Método global") +
  theme(plot.title = element_text(hjust = 0.95))

local2 = ggplot() +
  geom_step(data = PEHAZ2, aes(x = X1,  y = X2, colour = "Exponencial constante a intervalos")) +
  geom_line(data = HAZl2, aes(x = X1,  y = X2, colour = "Estimación núcleo"), size = 1) +
  labs(x = "Tiempo (días)", y = "", title = "Método local")+
  scale_colour_manual(values = c(brewer.pal(4, "Dark2")[1], brewer.pal(4, "Dark2")[2]), name= "") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.95))


global2 + local2 + plot_layout(ncol=1)
@
\caption[Estimación por núcleos de la función de riesgo de la segunda vida de las tablets]{Gráficos de la estimación por núcleos de la función de riesgo de la segunda vida de las tablets (líneas color verde). En el panel superior, se utiliza un ancho de ventana global, siendo el ancho óptimo igual a \Sexpr{round(fitHAZg2$bw.glob,1)} mientras que en el panel inferior se realiza la estimación con un ancho de ventana local. Para ambos casos el ancho de banda inicial es igual a \Sexpr{round(fitHAZl2$pin$bw.pilot,1)} y se aplica corrección de límites en el borde izquierdo y el derecho, el núcleo utilizado es el de Epanechnikov. Las líneas en color naranja representan la estimación de la función de riesgo utilizando el modelo exponencial constante a intervalos. \label{fig:FunRiesgo2}}
\end{figure}

En la figura se observa como el riesgo de presentar una segunda defunción es muy alto al principio de la segunda vida de las tablets, y ese riesgo va disminuyendo con el paso de los días hasta volverse más insignificante. Se advierte nuevamente que con una ventana global la estimación es más rugosa asemejándose a los picos de la función escalonada, y con una ventana local, es más suavizada.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% CONCLUSIONES %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Conclusiones y trabajos a futuro}

A partir del análisis exploratorio realizado con los datos correspondientes a la primera y segunda vida del equipo, se pudo observar principalmente que no existen diferencias notorias entre la generación de tablets entregadas en 2014 y la generación de tablets entregadas en 2015 y que la primer vida presenta un mejor pronóstico que la segunda.

La proporción de defunciones para las \Sexpr{nrow(PrimeraVida)} tablets que tuvieron una primera vida ascendió a \Sexpr{round((t2[2,1]/t2[3,1])*100)}\% para la generación del 2014 y a \Sexpr{round((t2[2,2]/t2[3,2])*100)}\% para la del 2015. Para las \Sexpr{nrow(SegundaVida)} tablets que presentaron una segunda vida, la mortalidad fue del \Sexpr{round((t13["Defunción", "2014"]/t13["Sum", "2014"])*100)}\% para las tablets entregadas en 2014 y del \Sexpr{round((t13["Defunción", "2015"]/t13["Sum", "2015"])*100)}\% para las entregadas en 2015.

Los tiempos de vida de las tablets de la primera vida tuvieron comportamientos diferentes según el año de entrega, siendo la generación del 2015 la que tuvo duraciones menores, pero también con un período de exposición menor. Más especificamente: las tablets entregadas en 2014 tuvieron una duración máxima de un poco mas de tres años (\Sexpr{round(max(PV2014$Duracion))} días) y una duración media de un año y dos meses (\Sexpr{round(mean(PV2014$Duracion))} días), en cambio la duración máxima de las entregadas en 2015 fue de dos años y medio (\Sexpr{round(max(PV2015$Duracion))} días) y la duración media de un año (\Sexpr{round(mean(PV2015$Duracion))} días).
Los tiempos de vida hasta las segundas defunciones fueron menores que los tiempos hasta las primeras defunciones, concentrándose la mayor cantidad de defunciones en los primeros seis meses. La duración máxima de las tablets entregadas en 2014 fue de casi tres años (\Sexpr{round(max(SV2014$Duracion2))} días) y de las entregadas en 2015 fue de dos años y cuatro meses (\Sexpr{round(max(SV2015$Duracion2))} días).

La rotura de la placa madre fue la principal causa de defunción para este modelo específico de tablet. Para la primera vida, este repuesto se reparó en un \Sexpr{round((t4["Placa", "2014"]/t4["Sum","2014"])*100)}\%  de los equipos entregados en 2014 y en un \Sexpr{round((t4["Placa", "2015"]/t4["Sum","2015"])*100)}\% de los entregadas en 2015. Para la segunda vida, en un \Sexpr{round((t14["Placa", "2014"]/t14["Sum","2014"])*100)}\% de los del 2014 y en un \Sexpr{round((t14["Placa", "2015"]/t14["Sum","2015"])*100)}\% de los del 2015.

Al analizar la distribución de las variables sociodemográficas correspondientes a la primera vida: sexo, área geográfica y contexto sociocultural, se pudo apreciar que no hubo diferencias notorias respecto al tiempo de vida y a las causas de defunción, pero si respecto a la proporción de defunciones entre una categoría y otra de cada una de estas variables.  Dejaron de funcionar el \Sexpr{round((t5["Masculino", "Defunción"]/t5["Masculino", "Sum"])*100)}\% de las entregadas a los niños y el \Sexpr{round((t5["Femenino", "Defunción"]/t5["Femenino", "Sum"])*100)}\% de las entregadas a niñas; el área geográfica que presentó mayor cantidad de defunciones respecto al total de tablets entregadas es el de las escuelas del interior urbano (\Sexpr{round((t6["I.Urbano", "Defunción"]/t6["I.Urbano", "Sum"])*100)}\%); y aquellas tablets de escuelas pertenecientes al contexto con un nivel medio de criticidad son las que presentaron mayor cantidad de defunciones (\Sexpr{round((t7["Quintil 3", "Defunción"]/t7["Quintil 3", "Sum"])*100)}\%) y los del contexto menos crítico son las que presentaron menor cantidad respecto al total entregado (\Sexpr{round((t7["Quintil 5", "Defunción"]/t7["Quintil 5", "Sum"])*100)}\%) .

Al analizar las variables que cuantificaron las entradas a servicio técnico, se destacó que del \Sexpr{round((t8["0","Sum"]/t8["Sum","Sum"])*100)}\% del total de las tablets de la primera vida, no se tuvo ningún registro de ellas desde que se entregaron hasta que fueron recambiadas. Considerando sólo las entradas de los equipos que presentaron una defunción, el \Sexpr{round((t9["0", "Sum"]/t9["Sum", "Sum"])*100)}\% no tuvo ninguna orden de trabajo antes de la que indicó defunción.

Por otro lado, al utilizar el método de Kaplan-Meier para estimar la función de supervivencia para las \Sexpr{nrow(PrimeraVida)} tablets que presentaron una primera vida, los resultados fueron los siguientes: \Sexpr{nrow(PrimeraVida[PrimeraVida$IndDef == "1",])} tablets (\Sexpr{round((nrow(defun)/nrow(PrimeraVida))*100)}\%) presentaron una defunción, el resto fueron censuradas; la vida media fue estimada (con límite superior igual a \Sexpr{round(sum$rmean.endtime)} días) en \Sexpr{round(sum$table["*rmean"],1)} días y la vida mediana en \Sexpr{round(quantile(KM_pv, c(0.5))$quantile)} días, entre \Sexpr{round(quantile(KM_pv, c(0.5))$lower)} y \Sexpr{round(quantile(KM_pv, c(0.5))$upper)} días con 95\% de confianza. Al analizar dicha estimación gráficamente se observó como a medida que pasó el tiempo, la supervivencia de las tablets disminuyó rápidamente, hasta los 450 días aproximadamente.

Para la estimación de la función de supervivencia de las \Sexpr{nrow(SegundaVida)} tablets que tuvieron una segunda vida, los resultados fueron los siguientes: \Sexpr{t22["1"]} tablets (\Sexpr{round((t22["1"]/t22["Sum"])*100)}\%) presentaron un segundo evento, las restantes \Sexpr{t22["0"]} fueron censuradas; la vida media se estimó con un límite superior igual a \Sexpr{round(sum2$rmean.endtime)} en \Sexpr{round(sum2$table["*rmean"],1)} días y la vida mediana en \Sexpr{round(quantile(KM_sv, c(0.5))$quantile)} días entre \Sexpr{round(quantile(KM_sv, c(0.5))$lower)} y \Sexpr{round(quantile(KM_sv, c(0.5))$upper)} días con 95\% de confianza.

Al comparar ambas curvas de supervivencia, resultaron significativamente diferentes y la primera vida tuvo un mejor pronóstico que la segunda durante todo el período de análisis.

A futuro sería importante incluir y tener en cuenta el precio de los diferentes repuestos utilizados, mano de obra, etc., para obtener una mejor valoración de la conveniencia de reparar los equipos, en función no sólo de cuanto sobreviven una vez realizada la reparación, si no de los costos que esta implica, respecto a la compra de un nuevo dispositivo.

Por otro lado, para analizar como influían las variables explicativas (sexo del alumno, área geográfica  y contexto sociodemográfico al que pertenece la escuela y st que indica si el equipo entró a servicio técnico antes de la defunción o no) en la supervivencia del equipo, se realizó una estimación Kaplan-Meier de la función de confiabilidad de cada categoría de estas variables por separado. A través de los test de log-rank y Peto-Peto se concluyó para todos los casos, que no hubo evidencia para aceptar la hipótesis nula de igualdad de curvas de supervivencia. En particular, se observó que las tablets de las niñas sobrevivieron mas que las de los niños a lo largo del tiempo, es la variable que presentó mayor diferencia entre sus curvas. Las tablets entregadas en escuelas del interior rural y escuelas de Montevideo tuvieron una mayor probabilidad de sobrevivir que las del interior urbano. Los quintiles más críticos (quintiles 1, 2 y 3) tuvieron peores resultados que los quintiles menos críticos (quintiles 4 y 5) cuya supervivencia fue mayor, los equipos entregados en el quintil 3 presentaron el mayor riesgo de dejar de funcionar durante el período de análisis. Las tablets sin ninguna reparación antes de su primera defunción tuvieron una mayor supervivencia a lo largo del tiempo, para los equipos que nunca fueron a servicio ténico, la probabilidad de sobrevivir disminuyó rápidamente principalmente al inicio de la vida.

Otra forma de analizar lo planteado anteriormente fue aplicando un modelo de riesgos proporcionales de Cox. Se obtuvieron resultados similares a los de la estimacion de Kaplan-Meier manteniendo la relacion entre las categoría de cada variable y la probabilidad de sobrevivir a lo largo del tiempo durante el período de análisis. Sin embargo al realizar el diagnóstico y verificación de los supuestos del modelo, resultó que no se cumplía el supuesto de riesgos proporcionales, de forma global y para ninguna de las variables explicativas.

Una alternativa fue utilizar un modelo extendido de Cox, en el que se consideraron las variabes explicativas como dependientes del tiempo.
A futuro sería interesante profundizar en este tipo de modelos y probar con diferentes interacciones entre las variables que no cumplieron el supuesto de riesgos proprcionales y el tiempo.

Otra alternativa a futuro sería incluir en el modelo de Cox además de las variables explicativas, interacciones entre ellas.

Finalmente, se realizó la estimación de la función de riesgo. Para ello se utilizó una estimación no paramétrica por núcleos obteniendo una curva en la que el riesgo fue mayor al comienzo de la vida de las tablets, alcanzando el nivel más alto de la tasa a los 350 días aproximadamente. A medida que transcurrió el tiempo, el riesgo disminuyó, es decir que la probabilidad de que las tablets se rompieran dejando de funcionar, dado que no se rompieron hasta ese momento, fue cada vez menor. Para la estimación de la función de riesgo de la generación de tablets que presentaron una segunda vida, fue aún mas notorio el crecimiento del riesgo de presentar una defunción, alcanzando el nivel más alto en los primeros 100 días aproximadamente y luego comenzando a disminuir progresivamente.

Por último, se proponen otras interrogantes e ideas con las que sería interesante trabajar en un futuro como forma de ampliar esta investigación.
\begin{itemize}
\item Incluir indicadores de uso del equipo que permitan valorar si usarlas mas o menos influye en la supervivencia. También contriburía a obtener información más precisa del momento en que finaliza la vida de cada una de las tablets.
\item Levantar el supuesto de que el intervalo de tiempo entre que el equipo deja de funcionar y es reparado no es sustancial y analizar con mayor profundidad dichos casos. ¿Cuánto tiempo pasan los niños y las niñas exactamente sin usar la máquina entre que se les rompió y la pueden reparar efectivamente? ¿Cómo afecta el hecho de no contar con el equipo por determinado tiempo al rendimiento de los alumnos y alumnas o a la planificación de las maestras y maestros?
\item Realizar comparaciones con otros modelos de equipos entregados por el Plan Ceibal. El tipo de dispositivo ¿es un factor que cambia los resultado del análisis o no? ¿Qué equipo presenta mayor probabilidad de supervivencia?
\end{itemize}



%%%%%%%%%%%%%%%%%%%%%%%%%%%% BIBLIOGRAFíA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\bibliographystyle{spr-chicago}
\bibliography{bibliografia}


%%%%%%%%%%%%%%%%%%%%%%%%%%% ANEXO %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{appendix}

\chapter{Apéndice estadístico}

\section{Propiedades del estimador por núcleos de la función de riesgo \label{ane:PropEst}}
Las propiedades de este estimador han sido estudiadas por \cite{muller1994hazard}.

\begin{itemize}
\item Sea $[0,S], S > 0$, un intervalo para el cual $L(S) < 1.$
\item $\lambda \in C^{k_0}[0,S], k_0 \geq 2, k\leq k_0$, es decir $\lambda$ es una función continua y con derivadas continuas de orden $k_0$.
\item $K^{(v)} \in S^{0}_{v,k}$, siendo 
\begin{equation*}
S_{v,k} = \left\lbrace 
\begin{array}{l} 
K \in Lip[-1,1], \quad soporte(K) = [-1,1] \\
\int_{-1}^1 x^j K(x) dx = \left\lbrace 
\begin{array}{ll}
0, & 0 \leq j < k, \quad j \neq v \\
(-1)^v v!, & j=v \\
\beta_k(K) \neq 0, & j=k. 
\end{array}
\end{array}
\end{equation*}
\item Sea $b=b(n)$ el ancho de banda que satisface que
$$\begin{array}{ll}
\lim\limits_{n\rightarrow \infty} b = 0, & \lim\limits_{n\rightarrow \infty} b^{2v+1}n = \infty,\\
\lim\limits_{n\rightarrow \infty} nb^{k+1} (\log n)^{-1} =  \infty, & \lim\limits_{n\rightarrow \infty} nb (\log n)^{-2} = \infty.
\end{array} $$
\end{itemize}

Luego, el \textit{Error Cuadrático Medio} en el punto $x$ puede ser expresado como

\begin{equation*}
MSE\lbrace \hat{\lambda}^{(v)} (x,b) \rbrace = \underbrace{\left[ b^{k-v} \lambda^{(k)} (x) \left\{ \dfrac{(-1)^{k} \beta_k}{k!} + o(1) \right\} \right]^{2}}_{sesgo^{2}\lbrace \hat{\lambda}^{(v)}(x,b) \rbrace}
		+ \underbrace{\dfrac{1}{nb^{2v+1}} \left\{ \dfrac{\lambda (x) V (K^{(v)})}{\bar{L}(x)}+o(1) \right\}}_{var \lbrace \hat{\lambda}^{(v)}(x,b) \rbrace}.
\end{equation*}

La calidad global de esta estimación se puede describir por medio del \textit{Error Cuadrático Medio Integrado} ($MISE \lbrace \hat{\lambda}^{(v)}(\cdot,b) \rbrace$).

El \textit{Error Cuadrático Medio Integrado Asintótico}, $AMISE \lbrace \hat{\lambda}^{(v)}(\cdot,b) \rbrace$ toma la forma:
$$ AMISE \lbrace \hat{\lambda}^{(v)} (\cdot, b) \rbrace = b^{2(k-v)}\beta^{2}_k D_k + \dfrac{V(K^{(v)}) \mathcal{L}}{nb^{2v+1}}, $$
donde
$$ \beta_k = \beta_k (K^{(v)}) = \int_{-1}^{1} x^{k} K^{(v)} (x)dx,$$
$$D_k = \int_0^{S} \left( \dfrac{\lambda^{(k)} (x)}{k!} \right)^{2} dx,$$
$$\mathcal{L} = \int_0^{S} \dfrac{\lambda (x)}{\bar{L} (x)}dx.$$


Entonces, el ancho de banda asintóticamente óptimo $b_{opt,v,k}$ que minimiza el $AMISE\lbrace \hat{\lambda}^{(v)} (\cdot, b) \rbrace $ sobre el conjunto $B_n$ de anchos de banda aceptables con respecto a $b$ viene dado por

$$ b^{2k+1}_{opt,v,k} = \dfrac{\mathcal{L}(2v+1)}{2n(k-v)D_k} \gamma^{2k+1}_{v,k}.$$


\section{Regla de Freedman-Diaconis (F-D) \label{ane:F-D}}

El histograma es el estimador de la función de densidad más sencillo. Depende de dos parámetros: el ancho de ventana $b$ y el origen $x_0$.
Para optimizar la ventana $b$ de manera que el sesgo y la varianza sean relativamente pequeñas, existen varios métodos. Uno de ellos es la regla de Freedman-Diaconis donde se define el ancho de ventana óptimo, $b^{*}$, como:
$$b^{*} = 2 * IQ * n ^{-1/3},$$
siendo $IQ$ el rango intercuartílico de la muestra.
Éste método fue propuesto como una modificación para datos no normales, menos sensible a los datos atípicos.

\chapter{Apéndice de resultados}
\section{Tiempo de vida hasta la primera defunción según variables sociodemográficas \label{ane:densi}}
En la Figura \ref{graf:Dura_VarSocio} se muestran los gráficos de densidad de la duración de las tablets que presentan una primera defunción según las variables sociodemográficas: sexo, área y contexto.

Al observar el gráfico correspondientes al área geográfica, se observa que la categoría que considera las escuelas rurales, tiene una duración diferente al resto, siendo el primer modo que se distingue en todas las categorías, un poco ``más bajo" para este subconjunto. En general, no hay diferencias entre los tiempos de vida hasta la primera defunción correspondientes a cada categoría de cada variable.

\begin{figure}[hbpt]
<<echo=FALSE, fig.height=4.5, fig.width=5, fig.align="center", cache=TRUE>>=
sex3 <- ggplot(defun, aes(x = Duracion, fill = Sexo, col = Sexo)) +
  geom_line(stat = "density") +
  scale_fill_brewer(palette = "Dark2", name = "") +
  scale_color_brewer(palette = "Dark2", name = "", labels = c("Fem", "Masc")) +
  labs(x = "Duración (días)", y = "Densidad", title = "Sexo") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

are3 <- ggplot(defun, aes(x = Duracion, fill = Area, color = Area)) +
  geom_line(stat = "density") +
  scale_fill_brewer(palette = "Dark2", name = "") +
  scale_color_brewer(palette = "Dark2", name = "", labels = c("I.Rur", "I.Urb", "Mvd")) +
  labs(x = "Duración (días)", y = "Densidad", title = "Área") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5), legend.text = element_text(size=6))

con3 <- ggplot(defun, aes(x = Duracion, fill = Contexto, color = Contexto)) +
  geom_line(stat="density") +
  scale_fill_brewer(palette = "Dark2", name = "") +
  scale_color_brewer(palette = "Dark2", name = "", labels =c("Q1", "Q2", "Q3", "Q4", "Q5")) +
  labs(x = "Duración (días)", y = "Densidad", title = "Contexto") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

con3 + (sex3 + are3)  + plot_layout(ncol = 1)
@
\caption[Duración de la primera vida de las tablets que presentaron defunciones según variables sociodemográficas.]{Gráficos de densidad con el tiempo de vida de las \Sexpr{nrow(PrimeraVida[PrimeraVida$IndDef == "1",])} tablets que registraron un evento en su primera vida, según las variables sociodemográficas consideradas en el análisis: sexo (panel inferior izquierdo), área geográfica (panel inferior derecho) y contexto sociocultural (panel superior). \label{graf:Dura_VarSocio}}
\end{figure}

\section{Estimación Kaplan-Meier de la primera vida de las tablets \label{ane:KM_pv}}
Se presenta en la Tabla \ref{tab:aneKM}, la salida de \texttt{R} al aplicar la función \texttt{survfit()} para estimar a través del método de Kaplan-Meier la función de supervivencia de la primera vida de las tablets, sólo que en vez de mostrar los resultados para cada tiempo en los que ocurre al menos un evento, se muestra para intervalos de 90 días. En dicha tabla se muestra el tiempo, la cantidad de tablets en el conjunto de riesgo, la cantidad de eventos, la probabilidad de sobrevivir, el error estándar y los intervalos de confianza al 95\%.

<<echo=FALSE, cache=TRUE, results="asis">>=
sumKM = summary(KM_pv, times = seq(0,2000, by = 90))
tabKM = cbind(sumKM$time, sumKM$n.risk, sumKM$n.event, round(sumKM$surv, 2), round(sumKM$std.err, 4), round(sumKM$lower, 2), round(sumKM$upper, 2))
colnames(tabKM) = c("Tiempo", "Riesgo", "Eventos", "Superv.", "Err. std.", "IC inferior", "IC superior")

print(xtable(tabKM, caption = "Estimación Kaplan-Meier de la función de supervivencia de la primera vida de las tablets para intervalos de tiempo de 90 días.", label = "tab:aneKM", display=c("s","d", "d", "d", "f", "f", "f", "f"), digits = c(0,0,0,0,2,4,2,2)), caption.placement = "top", table.placement = "hbpt", include.rownames = FALSE)
@

A continuación, como forma de resumir la estimación mencionada anteriormente, se presentan en la Tabla \ref{tab:aneKM2} la cantidad de eventos, la media calculada con el límite superior igual al máximo de la duración, la mediana y los límites del intervalo de confianza.

<<echo=FALSE, cache=TRUE, results="asis">>=
#print(KM_pv, rmean = "common")
tabKM2 = matrix(round(sumKM$table[-c(1, 2)],2), 1, 7)
colnames(tabKM2) = c("n", "Eventos", "*Media rest.", "*se(media rest.)", "Mediana", "0.95LCL", "095UCL")

com <- paste0("\\hline \n \\multicolumn{5}{l}",
      "{\\small{*Media restringida con límite superior = 1181}} \n")

print(xtable(tabKM2, caption = "Resumen de la estimación Kaplan-Meier de la función de supervivencia de la primera vida de las tablets.", label = "tab:aneKM2", display = c("s","d", "d", "f", "f", "f", "f", "f")), caption.placement = "top", table.placement = "hbpt", include.rownames = FALSE, hline.after = c(-1,0), add.to.row = list(pos = list(1), command = com))

@

\section{Test log-rank y Peto-Peto para comparación de las curvas de supervivencia de la primera y segunda vida \label{ane:test_comp}}
Se presentan los resultados de la salida de \texttt{R} de la función \texttt{survdiff()} del paquete \texttt{survival} que comprueba si hay una diferencia entre dos o más curvas de supervivencia utilizando la familia de pruebas G-rho. Se presenta el resultado con la comparación de la curva de supervivencia de la primera vida y la de la segunda vida; en primer lugar el test log-rank (Tabla \ref{tab:aneLR}) y luego el test Peto-Peto (Tabla \ref{tab:anePP}).

<<echo=FALSE, cache=TRUE, results="asis">>=
# survdiff(Surv(Duracion, IndDef) ~ Vida, data = PVSV)
tabLR = round(cbind(logrank$n, logrank$obs, logrank$exp, (logrank$obs - logrank$exp)^2/logrank$exp, (logrank$obs - logrank$exp)^2/diag(logrank$var)))
colnames(tabLR) = c("N", "Observado", "Esperado", "(O-E)^2/E", "(O-E)^2/Var")
comm <- paste0("\\hline \n \\multicolumn{5}{l}",
      "{\\small{Chisq= 2933  con 1 grado de libertad, p= $<$2e-16 }} \n")

print(xtable(tabLR, caption = "Test log-rank que compara las funciones de supervivencia de la primera y segunda vida.", label = "tab:aneLR", display = c("d","d","d","d","d","d")), caption.placement = "top", table.placement = "hbpt", include.rownames = FALSE, hline.after = c(-1,0), add.to.row = list(pos = list(2),
           command = comm))
@

<<echo=FALSE, cache=TRUE, results="asis">>=
# survdiff(Surv(Duracion, IndDef) ~ Vida, data = PVSV, rho = 1)
tabPP = round(cbind(peto$n, peto$obs, peto$exp, (peto$obs - peto$exp)^2/peto$exp, (peto$obs - peto$exp)^2/diag(peto$var)))
colnames(tabPP) = c("N", "Observado", "Esperado", "(O-E)^2/E", "(O-E)^2/Var")
comm2 <- paste0("\\hline \n \\multicolumn{5}{l}",
      "{\\small{Chisq= 4284  con 1 grado de libertad, p= $<$2e-16 }} \n")

print(xtable(tabPP, caption = "Test Peto-Peto que compara las funciones de supervivencia de la primera y segunda vida.", label = "tab:anePP", display = c("d","d","d","d","d","d")), caption.placement = "top", table.placement = "hbpt", include.rownames = FALSE, hline.after = c(-1,0), add.to.row = list(pos = list(2), command = comm2))
@

\section{Estimación Kaplan-Meier de la primera vida considerando las variables explicativas \label{ane:km_sociodemo}}

Se presentan en la Tabla \ref{tab:aneKMVar} la cantidad de eventos, la media calculada con el límite igual al máximo de la duración, la mediana y los límites del intervalo de confianza correspondientes a las estimaciones a través del método de Kaplan-Meier de las funciones de supervivencia para cada categoría de las variables sociodemográficas utilizadas en el análisis: sexo, área geográfica, contexto sociodemográfico y entrada a servicio técnico, considerando el grupo primera vida, obtenidas con un \texttt{summary()} del objeto de supervivencia obtenido con la función \texttt{survfit()} del paquete \texttt{survival}.

<<echo=FALSE, results="asis">>=
KM_Sexo <- survfit(Surv(Duracion, IndDef) ~ Sexo, data = PrimeraVida)
sumS = summary(KM_Sexo)

KM_Area <- survfit(Surv(Duracion, IndDef) ~ Area, data = PrimeraVida)
sumA = summary(KM_Area)

KM_Contexto <- survfit(Surv(Duracion, IndDef) ~ Contexto, data = PrimeraVida)
sumC = summary(KM_Contexto)

KM_ST <- survfit(Surv(Duracion, IndDef) ~ ST, data = PrimeraVida)
sumST = summary(KM_ST)

maS = matrix(round(sumS$table[,-c(2, 3)],2), 2, 7)
rownames(maS) = c("Femenino", "Masculino")
maA = matrix(round(sumA$table[,-c(1, 2)],2), 3, 7)
rownames(maA) = c("I.Rural", "I.Urbano", "Montevideo")
maC = matrix(round(sumC$table[,-c(1, 2)],2), 5, 7)
rownames(maC) = c("Quintil 1", "Quintil 2", "Quintil 3", "Quintil 4", "Quintil 5")
maST = matrix(round(sumST$table[,-c(1, 2)],2), 2, 7)
rownames(maST) = c("ST=0", "ST=1")

matriz = rbind(maS,maA,maC,maST)
colnames(matriz) = c("n", "Eventos", "Media rest.", "se(media)", "Mediana", "0.95LCL", "095UCL")

print(xtable(matriz, caption = "Estimación Kaplan-Meier de las funciones de supervivencia de cada categoría de las variables sexo, área, contexto y ST.", label = "tab:aneKMVar", display = c("s","d", "d", "f", "f", "f", "f", "f")), caption.placement = "top", table.placement = "hbpt", include.rownames = TRUE, hline.after = c(-1,0,2,5,10,12))
@

\newpage
\section{Test log-rank y Peto-Peto para comparación de las curvas de supervivencia correspondientes a las categorías de las variables auxiliares de la primera vida \label{ane:testLRyPP}}
En las Tablas \ref{tab:aneLRVar} y \ref{tab:anePPVar} se presentan los resultados de las pruebas log-rank y Peto-Peto respectivamente, obtenidos con la función \texttt{survdiff()} en los que se testea por separado para cada variable, si las funciones de supervivencia de cada categoría son iguales.
<<echo=FALSE, results="asis">>=
#Test log-rank
obj.sup <- Surv(PrimeraVida$Duracion, PrimeraVida$IndDef)

sexL = survdiff(obj.sup ~ Sexo, data = PrimeraVida)
areL = survdiff(obj.sup ~ Area, data = PrimeraVida)
conL = survdiff(obj.sup ~ Contexto, data = PrimeraVida)
stL = survdiff(obj.sup ~ ST, data = PrimeraVida)

tab.sexL = round(cbind(sexL$n, sexL$obs, sexL$exp, (sexL$obs - sexL$exp)^2/sexL$exp, (sexL$obs - sexL$exp)^2/diag(sexL$var), sexL$chisq))
colnames(tab.sexL) = c("N", "Observado", "Esperado", "(O-E)^2/E", "(O-E)^2/Var", "chisq")
comm <- paste0("\\hline \n \\multicolumn{6}{l}",
      "{\\small{Chisq= 2933  con 1 grado de libertad, p= $<$2e-16 }} \n")

tab.areL = round(cbind(areL$n, areL$obs, areL$exp, (areL$obs - areL$exp)^2/areL$exp, (areL$obs - areL$exp)^2/diag(areL$var), areL$chisq))
colnames(tab.areL) = c("N", "Observado", "Esperado", "(O-E)^2/E", "(O-E)^2/Var", "chisq")
comm2 <- paste0("\\hline \n \\multicolumn{6}{l}",
      "{\\small{Chisq= 4284  con 1 grado de libertad, p= $<$2e-16 }} \n")

tab.conL = round(cbind(conL$n, conL$obs, conL$exp, (conL$obs - conL$exp)^2/conL$exp, (conL$obs - conL$exp)^2/diag(conL$var), conL$chisq))
colnames(tab.conL) = c("N", "Observado", "Esperado", "(O-E)^2/E", "(O-E)^2/Var", "chisq")
comm3 <- paste0("\\hline \n \\multicolumn{6}{l}",
      "{\\small{Chisq= 4284  con 1 grado de libertad, p= $<$2e-16 }} \n")

tab.stL = round(cbind(stL$n, stL$obs, stL$exp, (stL$obs - stL$exp)^2/stL$exp, (stL$obs - stL$exp)^2/diag(stL$var), stL$chisq))
colnames(tab.stL) = c("N", "Observado", "Esperado", "(O-E)^2/E", "(O-E)^2/Var", "chisq")
comm4 <- paste0("\\hline \n \\multicolumn{6}{l}",
      "{\\small{Chisq= 4284  con 1 grado de libertad, p= $<$2e-16 }} \n")

listaL = list(tab.sexL, tab.areL, tab.conL, tab.stL)
print(xtableList(listaL, display = c("d", "d", "d", "d", "d", "d", "d"), caption = "Test log-rank que compara las funciones de supervivencia de cada categoría de las variables sexo, área, contexto y ST.", label = "tab:aneLRVar"), caption.placement = "top", table.placement = "hbpt", hline.after = c(-1,0), add.to.row = list(pos = list(as.list(c(2,5,10)))[[1]], command = c(comm, comm2, comm3)))

#Test Peto-Peto
sexP = survdiff(obj.sup ~ Sexo, data = PrimeraVida, rho = 1)
areP = survdiff(obj.sup ~ Area, data = PrimeraVida, rho = 1)
conP = survdiff(obj.sup ~ Contexto, data = PrimeraVida, rho = 1)
stP = survdiff(obj.sup ~ ST, data = PrimeraVida, rho = 1)

tab.sexP = round(cbind(sexP$n, sexP$obs, sexP$exp, (sexP$obs - sexP$exp)^2/sexP$exp, (sexP$obs - sexP$exp)^2/diag(sexP$var), sexP$chisq))
colnames(tab.sexP) = c("N", "Observado", "Esperado", "(O-E)^2/E", "(O-E)^2/Var", "chisq")

tab.areP = round(cbind(areP$n, areP$obs, areP$exp, (areP$obs - areP$exp)^2/areP$exp, (areP$obs - areP$exp)^2/diag(areP$var), areP$chisq))
colnames(tab.areP) = c("N", "Observado", "Esperado", "(O-E)^2/E", "(O-E)^2/Var", "chisq")

tab.conP = round(cbind(conP$n, conP$obs, conP$exp, (conP$obs - conP$exp)^2/conP$exp, (conP$obs - conP$exp)^2/diag(conP$var), conP$chisq))
colnames(tab.conP) = c("N", "Observado", "Esperado", "(O-E)^2/E", "(O-E)^2/Var", "chisq")

tab.stP = round(cbind(stP$n, stP$obs, stP$exp, (stP$obs - stP$exp)^2/stP$exp, (stP$obs - stP$exp)^2/diag(stP$var), stP$chisq))
colnames(tab.stP) = c("N", "Observado", "Esperado", "(O-E)^2/E", "(O-E)^2/Var", "chisq")

listaP = list(tab.sexP, tab.areP, tab.conP, tab.stP)
print(xtableList(listaP, display = c("d", "d", "d", "d", "d", "d", "d"), caption = "Test Peto-Peto que compara las funciones de supervivencia de cada categoría de las variables sexo, área, contexto y ST.", label = "tab:anePPVar"), caption.placement = "top", table.placement = "hbpt", hline.after = c(-1,0))
@


\section{Estimación de Cox aplicada a diferentes modelos \label{ane:modelos}}
Se muestran en las tablas a continuación (Tablas \ref{tab:modA_Cox}, \ref{tab:modB_Cox} y \ref{tab:modC_Cox}) los resultados de la estimación realizada con el modelo de Cox sobre el \emph{Modelo A}, \emph{Modelo B} y \emph{Modelo C} obtenidas con la función \texttt{coxph()} del paquete \texttt{survival}.

<<echo=FALSE, results="asis">>=
mAList <- list(mA)
attr(mAList, "message") <- c("Likelihood ratio test=642.2  on 1 df, p=$<$2e-16", "n= 80500, number of events= 53035 ")
print(xtableList(mAList, caption="Resultado del ajuste del modelo de Cox al modelo A.", label="tab:modA_Cox"), caption.placement = "top", table.placement = "hbpt")

mBList <- list(mB)
attr(mBList, "message") <- c("Likelihood ratio test=323.9  on 4 df, p=$<$2e-16
", "n= 80500, number of events= 53035 ")
print(xtableList(mBList, caption="Resultado del ajuste del modelo de Cox al modelo B.", label="tab:modB_Cox"), caption.placement = "top", table.placement = "hbpt")

mCList <- list(mC)
attr(mCList, "message") <- c("Likelihood ratio test=953.3  on 5 df, p=$<$2e-16
", "n= 80500, number of events= 53035 ")
print(xtableList(mCList, caption="Resultado del ajuste del modelo de Cox al modelo C.", label="tab:modC_Cox"), caption.placement = "top", table.placement = "hbpt")
@

\newpage
\section{Función AIC para selección de modelos\label{ane:aic}}
Se presentan en la Tabla \ref{tab:aneAIC} los resultados de la salida de \texttt{R} de la función \texttt{AIC()} para el \emph{Modelo A}, \emph{Modelo B}, \emph{Modelo C} y para el \emph{Modelo completo}.

<<echo=FALSE, results="asis">>=
aic = AIC(mA, mB, mC, mcom)
print(xtable(aic, caption = "Comparación de modelos con la función AIC().", label = "tab:aneAIC", display = c("s", "d", "f")), caption.placement = "top", table.placement = "hbpt")
@

\section{Verificación del supuesto de riesgos proporcionales del modelo de Cox aplicado al modelo completo \label{ane:zph}}
En la Figura \ref{fig:aneRiesprop}\footnote{Se utiliza la función \texttt{ggcoxzph()} del paquete \texttt{survminer} para obtener dicha visualización.} se presentan los resultados de la verificación del supuesto de riesgos proporcionales del modelo de regresión de Cox, aplicado al modelo que incluye todas las variables explicativas (modelo completo), a través de una visualización gráfica en la que para cada coeficiente, además de los residuos de Schoenfeld escalados, se ajusta una curva por el sistema de alisado de splines, junto con dos líneas adicionales a $\pm 2$ el error estándar, proporcionando una estimación del coeficiente $\beta(t)$. Si se cumple la hipótesis de riesgos proporcionales, los residuos deberían  agruparse de forma aleatoria a ambos lados del valor 0 del eje $Y$, y la curva ajustada (es decir $\beta(t)$) debería ser próxima a una línea recta.

\begin{figure}[hbpt]
<<echo=FALSE, cache=TRUE, fig.height=8>>=
# cox.zph(mcom)
hh = ggcoxzph(cox.zph(mcom), resid = TRUE, se = TRUE, point.col = brewer.pal(4, "Dark2")[1], point.alpha = 0.7, ggtheme = theme_gray(), point.size = 0.3, xlab = "Tiempo", fontsize=3)

grid.arrange(hh[[1]], hh[[2]], hh[[3]], hh[[4]], hh[[5]], hh[[6]], hh[[7]], hh[[8]], ncol=2)
# ylab= c("Beta(t) Masculino", "Beta(t) I.Rural", "Beta(t) Mvdo", "Beta(t) Q1", "Beta(t) Q2", "Beta(t) Q3", "Beta(t) Q4", "Beta(t) ST")
@
\caption[Verificación del supuesto de riesgos proporcionales del modelo de Cox, a través de los residuos de Schoenfeld escalados]{Gráfico de los residuos de Schoenfeld escalados contra el tiempo transformado para cada covariable en un modelo de Cox ajustado a los datos de la primera vida de las tablets con las variables explicativas sexo, área, contexto y ST. En cada panel, la línea continua es una spline de suavizado ajustada y las líneas discontinuas representan una banda de $\pm 2$ el error estándar alrededor del ajuste. \label{fig:aneRiesprop}}
\end{figure}

\newpage
\section{Comparación de las estimaciones de la función de riesgo con diferentes tipos de núcleos \label{ane:nucleos}}
Se presentan en la Figura \ref{graf:nucleos} los resultados gráficos de la estimación núcleo de la función de riesgo de las tablets de la primera vida obtenida con la función \texttt{muhaz()} del paquete \texttt{muhaz} considerando las funciones núcleos de Epanechnikov, rectangular, bicuadrática y tricuadrática. No se observan diferencias notorias entre ellas.

<<echo=FALSE>>=
epa <- muhaz(times = PrimeraVida$Duracion, delta = PrimeraVida$IndDef, kern = "e")
rec <- muhaz(times = PrimeraVida$Duracion, delta = PrimeraVida$IndDef, kern = "r")
bi <- muhaz(times = PrimeraVida$Duracion, delta = PrimeraVida$IndDef, kern = "b")
tri <- muhaz(times = PrimeraVida$Duracion, delta = PrimeraVida$IndDef, kern = "t")

epa2 = data.frame(cbind(epa$est.grid, epa$haz.est))
rec2 = data.frame(cbind(rec$est.grid, rec$haz.est))
bi2 = data.frame(cbind(bi$est.grid, bi$haz.est))
tri2 = data.frame(cbind(tri$est.grid, tri$haz.est))
@


\begin{figure}[hbpt]
<<echo=FALSE, fig.height=3.5, fig.width=4.5, fig.align="center", cache=TRUE>>=
ggplot() +
  geom_line(data = epa2, aes(x = X1,  y = X2, colour = "Epanechnikov")) +
  geom_line(data = rec2, aes(x = X1,  y = X2, colour = "Rectangular")) +
  geom_line(data = bi2, aes(x = X1,  y = X2, colour = "Bicuadrático")) +
  geom_line(data = tri2, aes(x = X1,  y = X2, colour = "Tricuadrático")) +
  labs(x = "Tiempo (días)", y = "") +
   scale_colour_manual(values = c(brewer.pal(4, "Dark2")[1], brewer.pal(4, "Dark2")[2], brewer.pal(4, "Dark2")[3], brewer.pal(4, "Dark2")[4]), name= "") +
  theme(legend.position = "bottom", legend.text = element_text(size=6))
@
\caption[Comparación de las funciones de riesgo de la primera vida de las tablets utilizando diferentes funciones núcleo]{Gráficos de la función de riesgo de las \Sexpr{nrow(PrimeraVida)} tablets que tienen una primera vida, estimadas a través del método por núcleos utilizando diferentes funciones núcleos. La curva color naranja es estimada con un núcleo de Epanechnikov, la de color violeta utiliza un núcleo rectangular, la de color verde un núcleo bicuadrático y la rosada uno tricuadrático. \label{graf:nucleos}}
\end{figure}


\end{appendix}


\end{document}